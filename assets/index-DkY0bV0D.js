(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function i(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(o){if(o.ep)return;o.ep=!0;const s=i(o);fetch(o.href,s)}})();const t={currentInstrument:"guitar",songs:[],currentSongData:null,isPlaying:!1,isPaused:!1,isEditMode:!1,isTunerActive:!1,isScrubbingMinimap:!1,isAudioInitialized:!1,animationFrameId:null,pitchDetectionFrameId:null,songTime:0,lastTimestamp:0,currentScrollX:0,currentNoteIndex:0,loopStartTime:0,loopEndTime:null,dragMode:null,gameState:{score:0,perfectNotes:0,attemptedNotes:0,streak:0,multiplier:1},originalTablature:[],editedTablature:[],editHistory:[],historyIndex:-1,pendingEdits:!1,isDragging:!1,wasDragged:!1,draggedNoteIndex:null,selectedNoteIndex:null,hoveredNoteIndex:null,transposeOffset:0,zoomLevel:1,globalSettings:{noteSize:1,stringSpacing:1,stringThickness:1},audioContext:null,analyser:null,micStream:null,synthMasterGain:null,pitchDetectionBuffer:null,fftData:null,activeOscillators:[],currentDetectedMidi:null,currentDetectedFrequency:null,hmmState:null,staticCanvas:null,staticCtx:null,dynamicCanvas:null,dynamicCtx:null,minimapCanvas:null,minimapCtx:null,PLAIN_PATTERN:null,WOUND_PATTERN:null,stars:[],playheadY:0,ui:{}};function _t(){t.gameState={score:0,perfectNotes:0,attemptedNotes:0,streak:0,multiplier:1}}const et=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],U=n=>440*Math.pow(2,(n-69)/12),Dt=n=>n>0?12*Math.log2(n/440)+69:null;function Rt(n){if(!n||n<=0)return null;const e=12*(Math.log(n/440)/Math.log(2)),i=Math.round(e)+69,r=U(i);return{noteName:et[i%12],octave:Math.floor(i/12)-1,frequency:n,cents:1200*Math.log2(n/r)}}const ct={guitar:{name:"Guitar",numStrings:6,numFrets:22,tuning:[64,59,55,50,45,40],stringGauges:[4,5,6,7,8,9],woundStringIndices:[3,4,5]},ukulele:{name:"Ukulele",numStrings:4,numFrets:15,tuning:[69,64,60,67],stringGauges:[4,5.2,6.4,4.4],woundStringIndices:[]}},I=n=>ct[n],R={BUFFER_SIZE:4096,RMS_THRESHOLD:.01,YIN_THRESHOLD:.1,IN_TUNE_CENTS_THRESHOLD:10},_=20,lt=100,X=20,ut=Math.ceil((lt-_)*100/X),N=ut+1,j=ut,dt={0:"#9ca3af",1:"#f59e0b",2:"#a855f7",3:"#0ea5e9",4:"#ef4444"},O={perfect:"#4ade80",good:"#4ade80",wrong:"#f87171",missed:"#f87171"},F=16,w=12,Ot=4,G=.04,Gt=Object.freeze(Object.defineProperty({__proto__:null,FADE_TIME:G,FEEDBACK_COLORS:O,FINGER_COLORS:dt,HMM_CENTS_PER_BIN:X,HMM_NUM_PITCH_BINS:ut,HMM_NUM_STATES:N,HMM_PITCH_MAX_MIDI:lt,HMM_PITCH_MIN_MIDI:_,HMM_UNVOICED_STATE_INDEX:j,INSTRUMENT_CONFIG:ct,MINIMAP_HANDLE_H:w,MINIMAP_HANDLE_W:F,MINIMAP_HIT_PAD:Ot,PITCH_DETECTION_CONFIG:R,getInstrument:I},Symbol.toStringTag,{value:"Module"})),V=()=>t.ui.tabDisplay.clientWidth*.2;function v(){const n=t.ui.tabDisplay.clientHeight,e=n*.8*t.globalSettings.stringSpacing;return{neckTopY:(n-e)/2,neckHeight:e}}const Ct=(n=!1,e)=>{const i=document.createElement("canvas");i.width=32,i.height=4;const r=i.getContext("2d");if(n){r.fillStyle="#9E8B55",r.fillRect(0,0,i.width,i.height),r.fillStyle="#D4C28E";for(let o=0;o<i.width;o+=4)r.fillRect(o,0,2,i.height)}else{const o=r.createLinearGradient(0,0,0,i.height);o.addColorStop(0,"#ffffff"),o.addColorStop(.5,"#d0d0d0"),o.addColorStop(1,"#8a8a8a"),r.fillStyle=o,r.fillRect(0,0,i.width,i.height)}return e.createPattern(i,"repeat")},zt=()=>{t.PLAIN_PATTERN=Ct(!1,t.staticCtx),t.WOUND_PATTERN=Ct(!0,t.staticCtx)},Wt=()=>{t.staticCanvas=t.ui.staticCanvas,t.staticCtx=t.staticCanvas.getContext("2d"),t.dynamicCanvas=t.ui.dynamicCanvas,t.dynamicCtx=t.dynamicCanvas.getContext("2d"),t.minimapCanvas=t.ui.minimapCanvas,t.minimapCtx=t.minimapCanvas.getContext("2d"),gt()},gt=()=>{if(!t.dynamicCanvas||!t.staticCanvas||!t.minimapCanvas)return;const n=window.devicePixelRatio||1,e=t.ui.tabDisplay.getBoundingClientRect();if(!e.width||!e.height)return;t.staticCanvas.width=e.width*n,t.staticCanvas.height=e.height*n,t.staticCtx.setTransform(n,0,0,n,0,0),t.dynamicCanvas.width=e.width*n,t.dynamicCanvas.height=e.height*n,t.dynamicCtx.setTransform(n,0,0,n,0,0);const i=t.minimapCanvas.getBoundingClientRect();!i.width||!i.height||(t.minimapCanvas.width=i.width*n,t.minimapCanvas.height=i.height*n,t.minimapCtx.setTransform(n,0,0,n,0,0),zt(),t.ui.practice&&!t.ui.practice.classList.contains("hidden")&&(nt(),T(),B()))};function Ut(n,e,i=null,r,o){if(!t.currentSongData)return;const{neckTopY:s,neckHeight:a}=v(),c=a/I(t.currentInstrument).numStrings,l=72*t.globalSettings.noteSize,d=l,m=r,g=i??s+n.string*c+c/2,p=t.draggedNoteIndex&&t.draggedNoteIndex.eventIndex===e.eventIndex&&t.draggedNoteIndex.noteIndex===e.noteIndex,x=t.selectedNoteIndex&&t.selectedNoteIndex.eventIndex===e.eventIndex&&t.selectedNoteIndex.noteIndex===e.noteIndex,y=t.loopEndTime==null||n.startTime>=t.loopStartTime&&n.startTime<t.loopEndTime,h=!t.isEditMode&&!y;if(h?(t.dynamicCtx.globalAlpha=.4,t.dynamicCtx.fillStyle="#6b7280"):n.feedback&&["perfect","good","okay","late","early"].includes(n.feedback)?(t.dynamicCtx.globalAlpha=1,t.dynamicCtx.fillStyle=O.good):(t.dynamicCtx.globalAlpha=n.feedback==="missed"||n.feedback==="wrong"?.5:p?.3:1,t.dynamicCtx.fillStyle=dt[n.finger||0]),t.dynamicCtx.beginPath(),t.dynamicCtx.roundRect(m,g-l/2,o,l,l/2),t.dynamicCtx.fill(),x?(t.dynamicCtx.strokeStyle="#3b82f6",t.dynamicCtx.lineWidth=3,t.dynamicCtx.stroke()):(n.feedback==="wrong"||n.feedback==="missed")&&(t.dynamicCtx.strokeStyle=O.wrong,t.dynamicCtx.lineWidth=4,t.dynamicCtx.stroke()),!h&&n.impactTime&&performance.now()-n.impactTime<150){const b=(performance.now()-n.impactTime)/150;t.dynamicCtx.fillStyle=`rgba(255, 255, 255, ${.7*(1-b)})`,t.dynamicCtx.fill()}t.dynamicCtx.globalAlpha=h?.6:p?.5:1,t.dynamicCtx.fillStyle="white",t.dynamicCtx.shadowColor="rgba(0, 0, 0, 0.9)",t.dynamicCtx.shadowBlur=4,t.dynamicCtx.shadowOffsetX=0,t.dynamicCtx.shadowOffsetY=0,t.dynamicCtx.font=`700 ${33*t.globalSettings.noteSize}px Inter`,t.dynamicCtx.textAlign="center",t.dynamicCtx.textBaseline="middle";const C=t.isEditMode?n.fret:n.fret+t.transposeOffset;t.dynamicCtx.fillText(String(C),m+d/2,g+1),t.dynamicCtx.shadowColor="transparent",t.dynamicCtx.shadowBlur=0,t.dynamicCtx.globalAlpha=1}function Vt(n,e,i,r,o){if(!t.currentSongData)return;const a=72*t.globalSettings.noteSize;if(n.isChord&&n.notes.length>1){const{neckTopY:c,neckHeight:l}=v(),d=l/I(t.currentInstrument).numStrings,m=n.notes.reduce((y,h)=>h.string<y.string?h:y,n.notes[0]),g=n.notes.reduce((y,h)=>h.string>y.string?h:y,n.notes[0]),p=c+m.string*d+d/2,x=c+g.string*d+d/2;t.dynamicCtx.strokeStyle="rgba(255, 255, 255, 0.2)",t.dynamicCtx.lineWidth=2,t.dynamicCtx.beginPath(),t.dynamicCtx.moveTo(r+a/2,p),t.dynamicCtx.lineTo(r+a/2,x),t.dynamicCtx.stroke()}n.notes.forEach((c,l)=>{const d=t.isDragging&&t.draggedNoteIndex&&t.draggedNoteIndex.eventIndex===e&&t.draggedNoteIndex.noteIndex===l;Ut(c,{eventIndex:e,noteIndex:l},d?i:null,r,o)})}function bt(){if(!t.currentSongData||!t.currentSongData.tablature||t.currentSongData.tablature.length===0)return;const{neckTopY:n,neckHeight:e}=v(),i=e/I(t.currentInstrument).numStrings,r=V(),o=t.currentSongData.tablature[t.currentNoteIndex],s=t.currentSongData.tablature[t.currentNoteIndex+1];if(!o)return;const a=c=>{const l=c.notes.reduce((d,m)=>d+m.string,0)/c.notes.length;return n+l*i+i/2};if(t.isPlaying&&s){const c=t.songTime-o.notes[0].startTime,l=s.notes[0].startTime-o.notes[0].startTime;if(l>0){const d=Math.max(0,Math.min(1,c/l)),m=a(o),g=a(s),p=30+o.notes[0].duration*40;t.playheadY=m+(g-m)*d-4*p*d*(1-d)}else t.playheadY=a(o)}else t.playheadY=a(o);t.dynamicCtx.fillStyle="white",t.dynamicCtx.shadowColor="rgba(255, 255, 255, 0.7)",t.dynamicCtx.shadowBlur=10,t.dynamicCtx.beginPath(),t.dynamicCtx.arc(r,t.playheadY,18*t.globalSettings.noteSize,0,Math.PI*2),t.dynamicCtx.fill(),t.dynamicCtx.shadowColor="transparent",t.dynamicCtx.shadowBlur=0}function Yt(){if(!t.currentSongData||!t.currentSongData.tablature||t.currentSongData.tablature.length<2)return;const n=t.currentSongData.tablature,{neckTopY:e,neckHeight:i}=v(),r=i/I(t.currentInstrument).numStrings,o=V(),s=t.currentSongData.pixelsPerSecond,a=t.currentScrollX,c=t.ui.tabDisplay.clientWidth,l=g=>{const p=g.notes.reduce((x,y)=>x+y.string,0)/g.notes.length;return e+p*r+r/2},d=(a-o)/s;let m=Y(d);m=Math.max(0,m-2);for(let g=m;g<n.length-1;g++){const p=n[g],x=n[g+1],y=o+p.notes[0].startTime*s-a;if(y>c+50)break;const h=o+x.notes[0].startTime*s-a;if(h<-50)continue;const C=l(p),b=l(x);t.dynamicCtx.save(),t.dynamicCtx.beginPath(),t.dynamicCtx.moveTo(y,C);const M=(y+h)/2,q=30+p.notes[0].duration*40,L=Math.min(C,b)-q;t.dynamicCtx.quadraticCurveTo(M,L,h,b);const P=t.dynamicCtx.createLinearGradient(y,0,h,0);P.addColorStop(0,"rgba(255, 255, 255, 0)"),P.addColorStop(.5,"rgba(255, 255, 255, 0.5)"),P.addColorStop(1,"rgba(255, 255, 255, 0)"),t.dynamicCtx.setLineDash([3,5]),t.dynamicCtx.strokeStyle=P,t.dynamicCtx.lineWidth=2,t.dynamicCtx.stroke(),t.dynamicCtx.restore()}}function nt(){if(!t.staticCtx)return;const n=I(t.currentInstrument),e=t.ui.tabDisplay.clientWidth;t.ui.tabDisplay.clientHeight,t.staticCtx.clearRect(0,0,t.staticCanvas.width,t.staticCanvas.height);const{neckTopY:i,neckHeight:r}=v(),o=r/n.numStrings,s=t.staticCtx.createLinearGradient(0,0,0,i);s.addColorStop(0,"#111827"),s.addColorStop(1,"#1f2937"),t.staticCtx.fillStyle=s,t.staticCtx.fillRect(0,0,e,i),t.staticCtx.fillStyle="rgba(255, 255, 255, 0.4)",t.stars.forEach(a=>{t.staticCtx.beginPath(),t.staticCtx.arc(a.x,a.y,a.r,0,Math.PI*2),t.staticCtx.fill()}),t.staticCtx.fillStyle="#374151",t.staticCtx.fillRect(0,i,e,r);for(let a=0;a<n.numStrings;a++){const c=i+a*o+o/2,l=(n.stringGauges[a]||1.5)*t.globalSettings.stringThickness,m=n.woundStringIndices.includes(a)?t.WOUND_PATTERN:t.PLAIN_PATTERN;m&&m.setTransform&&m.setTransform(new DOMMatrix().scaleSelf(1,l/2)),t.staticCtx.save(),t.staticCtx.fillStyle=m,t.staticCtx.shadowColor="rgba(0,0,0,0.35)",t.staticCtx.shadowBlur=1.5,t.staticCtx.fillRect(0,c-l/2,e,l),t.staticCtx.restore()}}function T(n=0,e=null){var y;if(!t.dynamicCtx||!t.currentSongData)return;const{tablature:i=[],pixelsPerSecond:r,totalDuration:o,minDuration:s}=t.currentSongData,a=t.ui.tabDisplay.clientWidth;if(t.dynamicCtx.clearRect(0,0,t.dynamicCanvas.width,t.dynamicCanvas.height),i.length===0){bt();return}const c=V(),l=t.currentScrollX,{neckTopY:d,neckHeight:m}=v(),g=(l-c)/r,p=ht();if(p>0){const h=Math.max(p,Math.ceil(g/p)*p);for(let C=h;C<o+p*2;C+=p){const b=c+C*r-l;if(b>a+50)break;b>-50&&(t.dynamicCtx.fillStyle="rgba(255, 255, 255, 0.2)",t.dynamicCtx.fillRect(b,d,1,m))}}Yt();let x=Y(g);x=Math.max(0,x-2);for(let h=x;h<i.length;h++){const C=i[h],b=C.notes[0],M=c+b.startTime*r-l;if(M>a+50)break;const L=72*t.globalSettings.noteSize,P=(b.duration-s)*r,xt=L+Math.max(0,P);if(M+xt>-50){let yt=null;if(e&&t.isDragging&&((y=t.draggedNoteIndex)==null?void 0:y.eventIndex)===h){const Ht=t.ui.dynamicCanvas.getBoundingClientRect();yt=e.clientY-Ht.top}Vt(C,h,yt,M,xt)}}bt()}function B(){if(!t.minimapCtx||!t.currentSongData||!t.currentSongData.tablature)return;const{width:n,height:e}=t.minimapCanvas,i=window.devicePixelRatio||1,r=n/i,o=e/i;t.minimapCtx.clearRect(0,0,n,e),t.minimapCtx.fillStyle="#111827",t.minimapCtx.fillRect(0,0,r,o);const s=t.currentSongData.tablature,a=t.currentSongData.totalDuration,c=I(t.currentInstrument),l=t.songTime/a*r;t.minimapCtx.fillStyle="rgba(22, 101, 52, 0.5)",t.minimapCtx.fillRect(0,0,l,o),s.forEach(y=>{y.notes.forEach(h=>{const C=h.startTime/a*r,b=h.duration/a*r,M=(h.string+.5)/c.numStrings*o;h.feedback==="perfect"||h.feedback==="good"?t.minimapCtx.fillStyle=O.perfect:h.feedback==="wrong"||h.feedback==="missed"?t.minimapCtx.fillStyle=O.wrong:t.minimapCtx.fillStyle=dt[h.finger||0],t.minimapCtx.fillRect(C,M-3,Math.max(2,b),6)})});const d=t.loopStartTime/a*r,m=(t.loopEndTime!==null?t.loopEndTime/a:1)*r;t.minimapCtx.fillStyle="rgba(0, 0, 0, 0.5)",t.minimapCtx.fillRect(0,0,d,o),t.loopEndTime!==null&&t.minimapCtx.fillRect(m,0,r-m,o);const g=F/2,p=Math.max(g,Math.min(d,r-g)),x=Math.max(g,Math.min(m,r-g));t.minimapCtx.fillStyle="#facc15",t.minimapCtx.fillRect(p-1,0,2,o),t.minimapCtx.fillRect(x-1,0,2,o),t.minimapCtx.fillStyle="white",t.minimapCtx.fillRect(p-g,0,F,w),t.minimapCtx.fillRect(p-g,o-w,F,w),t.minimapCtx.fillRect(x-g,0,F,w),t.minimapCtx.fillRect(x-g,o-w,F,w),t.minimapCtx.fillStyle="white",t.minimapCtx.shadowColor="rgba(255, 255, 255, 0.7)",t.minimapCtx.shadowBlur=18,t.minimapCtx.beginPath(),t.minimapCtx.arc(l,o/2,15,0,Math.PI*2),t.minimapCtx.fill(),t.minimapCtx.shadowColor="transparent",t.minimapCtx.shadowBlur=0}function $t(n,e="General"){console.error(`[${e}]`,n)}const D={log:$t},u=(n,e=document)=>e.querySelector(n),it=(n,e=document)=>[...e.querySelectorAll(n)],f=(n,e,i,r)=>n.addEventListener(e,i,r),S=(n,e)=>{Object.entries(e).forEach(([i,r])=>n.classList.toggle(i,r))},mt=(n,e)=>{let i=0;return(...r)=>{const o=performance.now();o-i>e&&(i=o,n(...r))}};async function Mt(n=!1){if(t.isAudioInitialized&&t.audioContext&&t.audioContext.state==="running"){n&&!t.pitchDetectionFrameId&&ot();return}t.audioContext&&t.audioContext.state==="suspended"&&await t.audioContext.resume();try{t.audioContext||(t.audioContext=new(window.AudioContext||window.webkitAudioContext),t.synthMasterGain=t.audioContext.createGain(),t.synthMasterGain.connect(t.audioContext.destination)),t.micStream||(t.micStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),t.analyser=t.audioContext.createAnalyser(),t.analyser.fftSize=R.BUFFER_SIZE,t.pitchDetectionBuffer=new Float32Array(R.BUFFER_SIZE),t.fftData=new Uint8Array(t.analyser.frequencyBinCount),t.audioContext.createMediaStreamSource(t.micStream).connect(t.analyser)),[t.ui.practiceMicMsg,t.ui.tunerMicMsg].forEach(e=>S(e,{hidden:!0})),t.isAudioInitialized=!0,n&&(wt(),ot())}catch(e){[t.ui.practiceMicMsg,t.ui.tunerMicMsg].forEach(i=>S(i,{hidden:!1})),D.log(e,"AudioInit"),t.isAudioInitialized=!1}}function Nt(){t.pitchDetectionFrameId&&(cancelAnimationFrame(t.pitchDetectionFrameId),t.pitchDetectionFrameId=null),t.isTunerActive=!1}function qt(){if(!t.analyser||!t.pitchDetectionBuffer)return[];t.analyser.getFloatTimeDomainData(t.pitchDetectionBuffer);let n=0;for(let o=0;o<t.pitchDetectionBuffer.length;o++)n+=t.pitchDetectionBuffer[o]*t.pitchDetectionBuffer[o];if(n=Math.sqrt(n/t.pitchDetectionBuffer.length),n<R.RMS_THRESHOLD)return[];const e=new Float32Array(Math.floor(t.pitchDetectionBuffer.length/2));let i=0;e[0]=1;for(let o=1;o<e.length;o++){let s=0;for(let a=0;a<e.length;a++){const c=t.pitchDetectionBuffer[a]-t.pitchDetectionBuffer[a+o];s+=c*c}i+=s,e[o]=s/(i/o+1e-6)}const r=[];for(let o=.05;o<.5;o+=.05){let s=-1;for(let a=2;a<e.length-1;a++)if(e[a]<o&&e[a]<e[a-1]&&e[a]<e[a+1]){s=a;break}if(s!==-1){const a=t.audioContext.sampleRate/s,c=1-e[s]/o;r.push({pitch:a,probability:c})}}return r}function wt(){t.hmmState={T1:new Float32Array(N).fill(1/N),T2:Array.from({length:N},()=>[]),path:[]}}function jt(n){t.hmmState||wt();const e=new Float32Array(N).fill(1e-6);n.length===0?e[j]=1:(n.forEach(c=>{const l=Dt(c.pitch);if(l!==null&&l>=_&&l<=lt){const d=Math.floor((l-_)*100/X);e[d]=Math.max(e[d],c.probability)}}),e[j]=1-Math.max(...e));const i=new Float32Array(N),r=new Int32Array(N);for(let c=0;c<N;c++){let l=0,d=0;for(let m=0;m<N;m++){const g=m===c?.9:Math.abs(m-c)===1?.05:1e-4,p=t.hmmState.T1[m]*g;p>l&&(l=p,d=m)}i[c]=l*e[c],r[c]=d}const o=i.reduce((c,l)=>c+l,0);if(o>0)for(let c=0;c<i.length;c++)i[c]/=o;t.hmmState.T1=i;let s=0,a=0;for(let c=0;c<t.hmmState.T1.length;c++)t.hmmState.T1[c]>a&&(a=t.hmmState.T1[c],s=c);return s===j?null:U(_+s*X/100)}function ot(){try{t.analyser&&t.analyser.getByteFrequencyData(t.fftData);const n=qt(),e=jt(n);if(t.currentDetectedFrequency=e&&e>60&&e<1600?e:null,t.isTunerActive){const i=t.currentDetectedFrequency?Rt(t.currentDetectedFrequency):null;Xt(i)}else{const i=t.currentDetectedFrequency?Dt(t.currentDetectedFrequency):null;t.currentDetectedMidi=i?Math.round(i):null}}catch(n){D.log(n,"PitchDetectionLoop"),t.pitchDetectionFrameId&&(cancelAnimationFrame(t.pitchDetectionFrameId),t.pitchDetectionFrameId=null);return}t.pitchDetectionFrameId=requestAnimationFrame(ot)}function Xt(n){const e=t.ui;if(!n){e.tunerNoteName.textContent="-",e.tunerStatus.textContent="...",e.tunerStatus.className="text-xl font-semibold text-gray-500 h-7",e.tunerFreq.textContent="0 Hz",e.tunerNeedle.style.transform="rotate(0deg)",S(e.tunerCircle,{good:!1});return}const{noteName:i,frequency:r,cents:o}=n;e.tunerNoteName.textContent=i,e.tunerFreq.textContent=`${r.toFixed(2)} Hz`;const s=Math.max(-45,Math.min(45,o*.9));e.tunerNeedle.style.transform=`rotate(${s}deg)`,Math.abs(o)<R.IN_TUNE_CENTS_THRESHOLD?(e.tunerStatus.textContent="Good Job!",e.tunerStatus.className="text-xl font-semibold text-green-400 h-7",S(e.tunerCircle,{good:!0})):o<0?(e.tunerStatus.textContent="Too Low",e.tunerStatus.className="text-xl font-semibold text-yellow-400 h-7",S(e.tunerCircle,{good:!1})):(e.tunerStatus.textContent="Too High",e.tunerStatus.className="text-xl font-semibold text-red-400 h-7",S(e.tunerCircle,{good:!1}))}function Jt(){if(!t.audioContext)return;const n=t.audioContext.currentTime;t.activeOscillators.forEach(({osc:e,gain:i})=>{try{i.gain.cancelAndHoldAtTime(n),i.gain.linearRampToValueAtTime(0,n+G),e.stop(n+G)}catch{}}),t.activeOscillators=[]}function Tt(n){if(!t.synthMasterGain||!t.audioContext)return;const e=t.audioContext.currentTime,i=n?1e-4:1;t.synthMasterGain.gain.cancelScheduledValues(e),t.synthMasterGain.gain.linearRampToValueAtTime(i,e+G)}function Kt(n){if(!t.audioContext||!n)return;const e=t.audioContext.createOscillator(),i=t.audioContext.createGain();e.connect(i).connect(t.synthMasterGain);const r=n.pitch+t.transposeOffset;e.frequency.value=U(r),e.type="sine";const o=t.audioContext.currentTime,s=parseInt(t.ui.tempoSlider.value)/100,a=n.duration/s;i.gain.setValueAtTime(0,o),i.gain.linearRampToValueAtTime(.5,o+.01),i.gain.linearRampToValueAtTime(0,o+a),e.start(o),e.stop(o+a+G),t.activeOscillators.push({osc:e,gain:i})}const It={PERFECT:.15,LATE:.6},kt={CENTS_TOLERANCE_FOR_GAMEPLAY:60,FFT_ENERGY_THRESHOLD:180};function Zt(n,e,i,r,o){if(!e||!i||!o)return!1;for(const s of n){const a=U(s.pitch+r),c=Math.round(a*(o.fftSize/2)/i.sampleRate);let l=0;for(let d=-2;d<=2;d++)e[c+d]>l&&(l=e[c+d]);if(l<kt.FFT_ENERGY_THRESHOLD)return!1}return!0}function Qt(n,e,i,r,o,s,a){const c=Math.abs(e);if(e<=0&&c<It.LATE){let l=!1;if(n.isChord)l=Zt(n.notes,r,o,s,a);else if(i!==null){const d=n.notes[0],m=U(d.pitch+s);let g=1200*Math.log2(i/m);Math.abs(g)>800&&(g%=1200),l=Math.abs(g)<kt.CENTS_TOLERANCE_FOR_GAMEPLAY}if(l)return c<It.PERFECT?{scoreChange:100,perfectNotesChange:1,attemptedNotesChange:1,wasCorrect:!0,feedback:"perfect"}:{scoreChange:75,perfectNotesChange:0,attemptedNotesChange:1,wasCorrect:!0,feedback:e>0?"early":"late"};if(e<-.3)return{scoreChange:0,perfectNotesChange:0,attemptedNotesChange:1,wasCorrect:!1,feedback:"wrong"}}return e<-.6?{scoreChange:0,perfectNotesChange:0,attemptedNotesChange:1,wasCorrect:!1,feedback:"missed"}:null}function te(n){const e=t.ui;n?(t.gameState.streak+=1,t.gameState.streak>0&&t.gameState.streak%10===0&&t.gameState.multiplier<8&&(t.gameState.multiplier+=1)):(t.gameState.streak=0,t.gameState.multiplier=1),e.streakDisplay.textContent=`${t.gameState.multiplier}x`,n&&(S(e.streakDisplay,{"streak-increased":!1}),e.streakDisplay.offsetWidth,S(e.streakDisplay,{"streak-increased":!0}))}function ee(n){if(!t.currentSongData||!t.analyser)return;const e=t.loopEndTime!==null&&t.loopEndTime<t.currentSongData.totalDuration,i=t.currentSongData.tablature[t.currentNoteIndex];if(i){const c=i.notes[0].pitch+t.transposeOffset,l=i.isChord?"Chord":et[c%12];t.ui.targetNoteDisplay.textContent=`Target: ${l}`;const d=t.currentDetectedMidi!==null?et[t.currentDetectedMidi%12]:"--";t.ui.pitchDisplay.textContent=`Detected: ${d}`}const r=5,o=5,s=Math.max(0,t.currentNoteIndex-r),a=Math.min(t.currentSongData.tablature.length,t.currentNoteIndex+o);for(let c=s;c<a;c++){const l=t.currentSongData.tablature[c];if(l.isScored)continue;const d=l.notes[0].startTime-t.songTime;if(!t.isScrubbingMinimap&&d<.05&&!l.notes[0].isAudioTriggered&&l.notes.forEach(p=>{Kt(p),p.isAudioTriggered=!0,p.impactTime=n}),!(!e||t.songTime>=t.loopStartTime&&t.songTime<t.loopEndTime))continue;const g=Qt(l,d,t.currentDetectedFrequency,t.fftData,t.audioContext,t.transposeOffset,t.analyser);if(g){l.isScored=!0,t.gameState.score+=g.scoreChange*t.gameState.multiplier,t.gameState.perfectNotes+=g.perfectNotesChange,t.gameState.attemptedNotes+=g.attemptedNotesChange,te(g.wasCorrect),l.notes.forEach(x=>x.feedback=g.feedback);const p={perfect:"Perfect!",good:"Good!",early:"Early",late:"Late",wrong:"Wrong Note",missed:"Missed"};t.ui.feedbackDisplay.textContent=`Feedback: ${p[g.feedback]||"--"}`,t.ui.scoreDisplay.textContent=`Score: ${t.gameState.score}`}}}function J(n){if(!t.isPlaying||t.isPaused||!t.currentSongData||!t.currentSongData.tablature){t.animationFrameId=null;return}if(t.lastTimestamp===0){t.lastTimestamp=n,t.animationFrameId=requestAnimationFrame(J);return}const e=(n-t.lastTimestamp)/1e3;t.lastTimestamp=n;const i=parseInt(t.ui.tempoSlider.value)/100;if(t.songTime+=e*i,t.loopEndTime!==null&&t.songTime>=t.loopEndTime){const r=ht(),o=Math.floor(t.loopStartTime/r)*r,s=Math.max(0,o-r);t.songTime=s,t.currentScrollX=t.songTime*t.currentSongData.pixelsPerSecond,t.currentSongData.tablature.forEach(a=>{a.notes[0].startTime>=s&&(a.notes.forEach(c=>{delete c.isAudioTriggered,delete c.impactTime,delete c.feedback}),delete a.isScored)})}t.currentScrollX=t.songTime*t.currentSongData.pixelsPerSecond,t.currentNoteIndex=Y(t.songTime),ee(n),T(n),B(),t.currentSongData.totalDuration&&t.songTime>t.currentSongData.totalDuration+2&&(t.loopEndTime===null||t.loopEndTime>=t.currentSongData.totalDuration)?ie():t.animationFrameId=requestAnimationFrame(J)}function z(){if(!t.currentSongData||t.isPlaying||!t.currentSongData.tablature||t.currentSongData.tablature.length===0)return;if(t.loopEndTime!==null&&t.loopEndTime<t.currentSongData.totalDuration&&t.songTime<=t.loopStartTime){const e=ht(),i=Math.floor(t.loopStartTime/e)*e,r=Math.max(0,i-e);t.songTime=r}t.synthMasterGain&&t.audioContext&&(t.synthMasterGain.gain.cancelScheduledValues(t.audioContext.currentTime),t.synthMasterGain.gain.setValueAtTime(1,t.audioContext.currentTime)),t.isPlaying=!0,t.isPaused=!1,S(t.ui.playIcon,{hidden:!0}),S(t.ui.pauseIcon,{hidden:!1}),t.lastTimestamp=0,t.animationFrameId=requestAnimationFrame(J)}function ft(){!t.isPlaying||t.isPaused||(t.isPaused=!0,S(t.ui.playIcon,{hidden:!1}),S(t.ui.pauseIcon,{hidden:!0}),t.synthMasterGain&&t.audioContext&&t.synthMasterGain.gain.exponentialRampToValueAtTime(1e-4,t.audioContext.currentTime+.05))}function pt(){!t.isPlaying||!t.isPaused||(t.isPaused=!1,S(t.ui.playIcon,{hidden:!0}),S(t.ui.pauseIcon,{hidden:!1}),t.lastTimestamp=0,t.synthMasterGain&&t.audioContext&&(t.synthMasterGain.gain.cancelScheduledValues(t.audioContext.currentTime),t.synthMasterGain.gain.setValueAtTime(1,t.audioContext.currentTime)),t.animationFrameId||(t.animationFrameId=requestAnimationFrame(J)))}function A(n=!1){t.animationFrameId&&cancelAnimationFrame(t.animationFrameId),t.animationFrameId=null,t.isPlaying=!1,t.isPaused=!1,S(t.ui.playIcon,{hidden:!1}),S(t.ui.pauseIcon,{hidden:!0}),t.currentSongData&&ne(n)}function ne(n=!1){_t(),n&&t.currentSongData?t.songTime=t.loopStartTime:(t.songTime=0,t.currentSongData&&(t.loopStartTime=0,t.loopEndTime=t.currentSongData.totalDuration)),t.currentScrollX=t.currentSongData?t.songTime*t.currentSongData.pixelsPerSecond:0,t.lastTimestamp=0,t.currentNoteIndex=Y(t.songTime),t.ui.scoreDisplay.textContent="Score: 0",t.ui.streakDisplay.textContent="1x",t.ui.targetNoteDisplay.textContent="Target: --",t.ui.feedbackDisplay.textContent="Feedback: --",t.ui.pitchDisplay.textContent="Detected: --",t.stars=[];for(let e=0;e<100;e++){const{neckTopY:i}=v();t.stars.push({x:Math.random()*t.ui.tabDisplay.clientWidth,y:Math.random()*i,r:Math.random()*1.5})}t.currentSongData&&t.currentSongData.tablature&&t.currentSongData.tablature.forEach(e=>{e.notes[0].startTime>=t.songTime&&(delete e.isScored,e.notes.forEach(i=>{delete i.isAudioTriggered,delete i.impactTime,delete i.feedback}))}),T(),B()}function ie(){if(!t.currentSongData)return;const n=t.currentSongData.highScore||0;t.ui.summaryScore.textContent=String(t.gameState.score);const e=t.gameState.attemptedNotes>0?Math.round(t.gameState.perfectNotes/t.gameState.attemptedNotes*100):0;if(t.ui.summaryAccuracy.textContent=`${e}%`,A(),ce(),t.gameState.score>n){const i=t.songs.find(r=>r.id===t.currentSongData.id);i&&(i.highScore=t.gameState.score,localStorage.setItem(`fretflow_songs_${t.currentInstrument}`,JSON.stringify(t.songs)))}}function Y(n){var s,a,c;const e=(s=t.currentSongData)==null?void 0:s.tablature;if(!e||e.length===0)return 0;let i=0,r=e.length-1,o=0;for(;i<=r;){const l=i+Math.floor((r-i)/2),d=(c=(a=e[l])==null?void 0:a.notes[0])==null?void 0:c.startTime;if(d===void 0){r=l-1;continue}d<=n?(o=l,i=l+1):r=l-1}return o}function ht(){if(!t.currentSongData)return 2;const{midiTempo:n,midiTimeSignature:e}=t.currentSongData,i=n||5e5,r=e?JSON.parse(e):{numerator:4},o=i/1e6,s=r.numerator||4;return o*s}function k(){t.currentSongData&&(t.currentSongData.tablature=t.isEditMode?t.editedTablature:t.originalTablature||[],T(),B(),t.ui.transposeValue.textContent=t.transposeOffset>0?`+${t.transposeOffset}`:String(t.transposeOffset))}async function H(){if(!(!t.currentSongData||!t.currentSongData.id||t.isEditMode))try{const n=t.songs.find(e=>e.id===t.currentSongData.id);n&&(n.playbackTempo=parseInt(t.ui.tempoSlider.value),n.transpose=t.transposeOffset,n.zoomLevel=t.zoomLevel,localStorage.setItem(`fretflow_songs_${t.currentInstrument}`,JSON.stringify(t.songs)))}catch(n){D.log(n,"SavePracticeSettings")}}function K(n){if(!t.originalTablature||t.originalTablature.length===0)return!0;const e=I(t.currentInstrument),i=t.isEditMode?t.editedTablature:t.originalTablature;for(const r of i)for(const o of r.notes){const s=o.fret+n;if(s<0||s>e.numFrets)return!1}return!0}function rt(){t.currentSongData&&(t.ui.transposeUpBtn.disabled=!K(t.transposeOffset+1),t.ui.transposeDownBtn.disabled=!K(t.transposeOffset-1))}function at(n){if(!t.currentSongData)return{mode:null,time:0};const e=t.ui.minimapCanvas.getBoundingClientRect(),i=n.clientX-e.left,r=i/e.width*t.currentSongData.totalDuration;if(t.isEditMode)return{mode:"seek",time:r};const{MINIMAP_HANDLE_W:o,MINIMAP_HIT_PAD:s}=Gt,a=o/2,c=t.loopStartTime/t.currentSongData.totalDuration*e.width,l=t.loopEndTime/t.currentSongData.totalDuration*e.width,d=Math.abs(i-c)<a+s,m=Math.abs(i-l)<a+s;return d?{mode:"start",time:r}:m?{mode:"end",time:r}:{mode:"seek",time:r}}function vt(n){if(!t.currentSongData)return;const{time:e}=at(n);t.dragMode==="start"?t.loopStartTime=Math.max(0,Math.min(e,t.loopEndTime-.1)):t.dragMode==="end"?t.loopEndTime=Math.min(t.currentSongData.totalDuration,Math.max(e,t.loopStartTime+.1)):t.dragMode==="seek"&&(t.songTime=Math.max(0,Math.min(e,t.currentSongData.totalDuration))),t.currentSongData.tablature.forEach(i=>{i.notes[0].startTime>=t.songTime&&(delete i.isScored,i.notes.forEach(r=>{delete r.isAudioTriggered,delete r.impactTime,delete r.feedback}))}),t.currentScrollX=t.songTime*t.currentSongData.pixelsPerSecond,t.currentNoteIndex=Y(t.songTime),T(),B()}async function oe(n){let e=JSON.parse(n.tablature||"[]");e.length>0&&e[0].pitch!==void 0&&e[0].notes===void 0&&(D.log("Migrating old song data structure to new format.","SongLoad"),e=e.map(l=>({notes:[l],isChord:!1}))),t.originalTablature=e,t.transposeOffset=n.transpose||0,t.zoomLevel=n.zoomLevel||1;const i=n.playbackTempo||100,r=e.length>0?e[e.length-1]:{notes:[{startTime:0,duration:0}]},o=r.notes[0].startTime+r.notes[0].duration,s=e.flatMap(l=>l.notes).map(l=>l.duration).filter(l=>l>0),a=s.length>0?Math.min(...s):.1,c=Math.max(150,(72*t.globalSettings.noteSize+8)/a)*t.zoomLevel;t.ui.tempoSlider.value=String(i),t.ui.tempoValue.textContent=`${i}%`,t.ui.zoomSlider.value=String(t.zoomLevel),t.ui.zoomValue.textContent=`${Math.round(t.zoomLevel*100)}%`,t.currentSongData={...n,tablature:t.originalTablature,totalDuration:o,minDuration:a,pixelsPerSecond:c},t.loopStartTime=0,t.loopEndTime=o,k(),rt(),await ae(),A(),z()}function Et(){t.ui.undoBtn.disabled=t.historyIndex<0,t.ui.redoBtn.disabled=t.historyIndex>=t.editHistory.length-1}function Pt(){if(t.historyIndex<0)return;const n=t.editHistory[t.historyIndex],e=t.editedTablature[n.noteId.eventIndex].notes[n.noteId.noteIndex];switch(n.type){case"finger":e.finger=n.oldValue;break;case"position":e.string=n.oldValue.string,e.fret=n.oldValue.fret;break;case"pitch":e.pitch=n.oldValue.pitch,e.fret=n.oldValue.fret;break}t.historyIndex--,t.pendingEdits=!0,k(),Et(),t.selectedNoteIndex&&t.selectedNoteIndex.eventIndex===n.noteId.eventIndex&&t.selectedNoteIndex.noteIndex===n.noteId.noteIndex&&W(t.selectedNoteIndex)}function Ft(){if(t.historyIndex>=t.editHistory.length-1)return;t.historyIndex++;const n=t.editHistory[t.historyIndex],e=t.editedTablature[n.noteId.eventIndex].notes[n.noteId.noteIndex];switch(n.type){case"finger":e.finger=n.newValue;break;case"position":e.string=n.newValue.string,e.fret=n.newValue.fret;break;case"pitch":e.pitch=n.newValue.pitch,e.fret=n.newValue.fret;break}t.pendingEdits=!0,k(),Et(),t.selectedNoteIndex&&t.selectedNoteIndex.eventIndex===n.noteId.eventIndex&&t.selectedNoteIndex.noteIndex===n.noteId.noteIndex&&W(t.selectedNoteIndex)}function W(n){var m;if(!n||!t.currentSongData)return;const{eventIndex:e,noteIndex:i}=n,r=(m=t.editedTablature[e])==null?void 0:m.notes[i];if(!r)return;t.selectedNoteIndex=n,t.ui.editorFretValue.textContent=String(r.fret),it(".finger-btn",t.ui.editorFingerButtons).forEach(g=>{S(g,{active:parseInt(g.dataset.finger)===r.finger})});const{neckTopY:o,neckHeight:s}=v(),a=s/I(t.currentInstrument).numStrings,c=V()+r.startTime*t.currentSongData.pixelsPerSecond-t.currentScrollX,l=o+r.string*a+a/2,d=t.ui.noteEditorPopup;d.style.left=`${c+35}px`,d.style.top=`${l-d.offsetHeight/2}px`,S(d,{hidden:!1}),setTimeout(()=>{S(d,{"opacity-0":!1,"pointer-events-none":!1})},10),T()}function E(){t.selectedNoteIndex=null,S(t.ui.noteEditorPopup,{"opacity-0":!0,"pointer-events-none":!0}),setTimeout(()=>S(t.ui.noteEditorPopup,{hidden:!0}),150),T()}function Q(n,e){var m;if(!((m=t.currentSongData)!=null&&m.tablature))return null;const i=t.ui.dynamicCanvas.getBoundingClientRect(),r=n-i.left,o=e-i.top,s=I(t.currentInstrument),{neckTopY:a,neckHeight:c}=v(),l=c/s.numStrings,d=t.isEditMode?t.editedTablature:t.currentSongData.tablature;for(let g=d.length-1;g>=0;g--){const p=d[g];for(let x=0;x<p.notes.length;x++){const y=p.notes[x],h=V()+y.startTime*t.currentSongData.pixelsPerSecond-t.currentScrollX,C=a+y.string*l+l/2,b=72*t.globalSettings.noteSize,M=b,q=(y.duration-t.currentSongData.minDuration)*t.currentSongData.pixelsPerSecond,L=M+Math.max(0,q);if(r>=h&&r<=h+L&&o>=C-b/2&&o<=C+b/2)return{eventIndex:g,noteIndex:x}}}return null}function re(){t.ui={loadingScreen:u("#loading-screen"),library:u("#song-library-screen"),practice:u("#practice-screen"),tuner:u("#tuner-screen"),summary:u("#summary-screen"),songList:u("#song-list"),addBtn:u("#add-song-btn"),tunerNavBtn:u("#tuner-nav-btn"),fullscreenBtn:u("#fullscreen-btn"),exportLibraryBtn:u("#export-library-btn"),importLibraryInput:u("#import-library-input"),midiFileInput:u("#midi-file-input"),practiceBackBtn:u("#practice-back-btn"),tunerBackBtn:u("#tuner-back-btn"),settingsBtn:u("#settings-btn"),settingsMenu:u("#settings-menu"),settingsMenuContent:u("#settings-menu-content"),settingsBackdrop:u("#settings-backdrop"),tempoSlider:u("#tempo-slider"),tempoValue:u("#tempo-value"),noteSizeSlider:u("#note-size-slider"),noteSizeValue:u("#note-size-value"),stringSpacingSlider:u("#string-spacing-slider"),stringSpacingValue:u("#string-spacing-value"),stringThicknessSlider:u("#string-thickness-slider"),stringThicknessValue:u("#string-thickness-value"),zoomSlider:u("#zoom-slider"),zoomValue:u("#zoom-value"),tabDisplay:u("#tab-display"),staticCanvas:u("#static-canvas"),dynamicCanvas:u("#practice-canvas"),playPauseBtn:u("#play-pause-btn"),rewindBtn:u("#rewind-btn"),editModeBtn:u("#edit-mode-btn"),undoBtn:u("#undo-btn"),redoBtn:u("#redo-btn"),playIcon:u("#play-icon"),pauseIcon:u("#pause-icon"),pitchDisplay:u("#pitch-display"),feedbackDisplay:u("#feedback-display"),targetNoteDisplay:u("#target-note-display"),practiceMicMsg:u("#practice-mic-msg"),tunerMicMsg:u("#tuner-mic-msg"),tunerNoteName:u("#tuner-note-name"),tunerNeedle:u("#tuner-needle"),tunerStatus:u("#tuner-status"),tunerFreq:u("#tuner-freq"),tunerCircle:u("#tuner-circle"),scoreDisplay:u("#current-score-display"),streakDisplay:u("#streak-display"),summaryScore:u("#summary-score"),summaryAccuracy:u("#summary-accuracy"),summaryBackBtn:u("#summary-back-btn"),transposeDownBtn:u("#transpose-down-btn"),transposeUpBtn:u("#transpose-up-btn"),transposeValue:u("#transpose-value"),minimapCanvas:u("#minimap-canvas"),libraryTitle:u("#library-title"),selectGuitarBtn:u("#select-guitar-btn"),selectUkuleleBtn:u("#select-ukulele-btn"),editButtonsContainer:u("#edit-buttons-container"),noteEditorPopup:u("#note-editor-popup"),editorCloseBtn:u("#editor-close-btn"),editorFretDown:u("#editor-fret-down"),editorFretUp:u("#editor-fret-up"),editorFretValue:u("#editor-fret-value"),editorFingerButtons:u("#editor-finger-buttons")}}const $=n=>{[t.ui.loadingScreen,t.ui.library,t.ui.practice,t.ui.summary,t.ui.tuner].forEach(e=>{e&&S(e,{hidden:!e.isEqualNode(n)})})},st=()=>{A(),Nt(),E(),$(t.ui.library)},ae=async()=>{await Mt(!0),t.isTunerActive=!1,$(t.ui.practice),gt()},se=async()=>{await Mt(!0),t.isTunerActive=!0,E(),$(t.ui.tuner)},ce=()=>{A(),Nt(),E(),$(t.ui.summary)},le=`
// --- Inlined from logger.ts ---
const isDev = true;
const Logger = {
    log(e, ctx = 'General') {
        if (isDev) {
            console.error('[Worker-' + ctx + ']', e);
        }
    }
};

// --- Inlined parts of config.ts ---
const INSTRUMENT_CONFIG = {
    guitar: {
        name: "Guitar",
        numStrings: 6,
        numFrets: 22,
        tuning: [64, 59, 55, 50, 45, 40],
        stringGauges: [4.0, 5.0, 6.0, 7.0, 8.0, 9.0],
        woundStringIndices: [3, 4, 5],
    },
    ukulele: {
        name: "Ukulele",
        numStrings: 4,
        numFrets: 15,
        tuning: [69, 64, 60, 67],
        stringGauges: [4.0, 5.2, 6.4, 4.4],
        woundStringIndices: [],
    },
};
const getInstrument = (id) => INSTRUMENT_CONFIG[id];

// --- Inlined from tablature.ts ---
function findPossiblePositions(midiNote, instrumentId, usedStrings = new Set()) {
    const positions = [];
    const instrumentConfig = getInstrument(instrumentId);
    instrumentConfig.tuning.forEach((openStringMidi, stringIndex) => {
        if (usedStrings.has(stringIndex)) return;
        const fret = midiNote - openStringMidi;
        if (fret >= 0 && fret <= instrumentConfig.numFrets) {
            positions.push({ string: stringIndex, fret: fret });
        }
    });
    return positions;
}

function calculateCost(previousFingering, nextFingering) {
    let cost = 0;
    const frets = nextFingering.map(n => n.fret).filter(f => f > 0);
    const HIGH_FRET_THRESHOLD = 12;
    const HIGH_FRET_PENALTY_FACTOR = 0.3;
    if (frets.length > 0) {
        frets.forEach(fret => {
            if (fret > HIGH_FRET_THRESHOLD) {
                cost += Math.pow(fret - HIGH_FRET_THRESHOLD, 2) * HIGH_FRET_PENALTY_FACTOR;
            }
        });
    }
    if (frets.length > 1) {
        cost += Math.pow(Math.max(...frets) - Math.min(...frets), 2) * 0.5;
    }
    if (nextFingering.some(n => n.fret === 0)) {
        cost -= 2.0;
    }
    if (previousFingering && previousFingering.length > 0) {
        const prevFrets = previousFingering.map(n => n.fret).filter(f => f > 0);
        if (frets.length > 0 && prevFrets.length > 0) {
            const avgNextFret = frets.reduce((s, f) => s + f, 0) / frets.length;
            const avgPrevFret = prevFrets.reduce((s, f) => s + f, 0) / prevFrets.length;
            cost += Math.abs(avgNextFret - avgPrevFret) * 1.5;
        }
        const avgNextString = nextFingering.reduce((s, n) => s + n.string, 0) / nextFingering.length;
        const avgPrevString = previousFingering.reduce((s, n) => s + n.string, 0) / previousFingering.length;
        cost += Math.abs(avgNextString - avgPrevString) * 0.2;
    }
    if (frets.length > 0) {
        cost += frets.reduce((s, f) => s + f, 0) / frets.length * 0.1;
    }
    return cost;
}

function generateTablature(noteEvents, instrumentId) {
    if (!noteEvents || noteEvents.length === 0) return [];
    const instrumentConfig = getInstrument(instrumentId);
    const trellis = [];
    const filteredNoteEvents = [];
    for (const event of noteEvents) {
        const notesWithPossiblePositions = event.notes.map(note => ({ note, positions: findPossiblePositions(note.pitch, instrumentId) })).filter(item => item.positions.length > 0);
        if (notesWithPossiblePositions.length === 0) continue;
        if (notesWithPossiblePositions.length > instrumentConfig.numStrings) continue;
        const playableNotes = notesWithPossiblePositions.map(item => item.note);
        const notePositions = notesWithPossiblePositions.map(item => item.positions);
        const allChordFingerings = [];
        function findCombinations(noteIndex, currentFingering, usedStrings) {
            if (noteIndex === playableNotes.length) {
                allChordFingerings.push(currentFingering);
                return;
            }
            if (!notePositions[noteIndex] || notePositions[noteIndex].length === 0) return;
            for (const pos of notePositions[noteIndex]) {
                if (!usedStrings.has(pos.string)) {
                    const newNote = { ...playableNotes[noteIndex], ...pos, finger: 0 };
                    findCombinations(noteIndex + 1, [...currentFingering, newNote], new Set(usedStrings).add(pos.string));
                }
            }
        }
        findCombinations(0, [], new Set());
        if (allChordFingerings.length > 0) {
            trellis.push(allChordFingerings);
            filteredNoteEvents.push({ notes: playableNotes, isChord: playableNotes.length > 1 });
        }
    }
    if (trellis.length === 0) return [];
    const costs = [trellis[0].map(fingering => calculateCost(null, fingering))];
    const backpointers = [new Array(trellis[0].length).fill(0)];
    for (let t = 1; t < trellis.length; t++) {
        const currentCosts = [];
        const currentBackpointers = [];
        for (let i = 0; i < trellis[t].length; i++) {
            let minCost = Infinity, bestPrevNode = -1;
            const currentFingering = trellis[t][i];
            for (let j = 0; j < trellis[t - 1].length; j++) {
                const totalCost = costs[t - 1][j] + calculateCost(trellis[t - 1][j], currentFingering);
                if (totalCost < minCost) { minCost = totalCost; bestPrevNode = j; }
            }
            currentCosts.push(minCost);
            currentBackpointers.push(bestPrevNode);
        }
        costs.push(currentCosts);
        backpointers.push(currentBackpointers);
    }
    const optimalPathIndices = [];
    let lastLayerIndex = -1, minFinalCost = Infinity;
    const lastCosts = costs[costs.length - 1];
    for (let i = 0; i < lastCosts.length; i++) {
        if (lastCosts[i] < minFinalCost) { minFinalCost = lastCosts[i]; lastLayerIndex = i; }
    }
    if (lastLayerIndex === -1) return [];
    optimalPathIndices.push(lastLayerIndex);
    let currentBestNodeIndex = lastLayerIndex;
    for (let t = trellis.length - 2; t >= 0; t--) {
        const prevNodeIndex = backpointers[t + 1][currentBestNodeIndex];
        optimalPathIndices.unshift(prevNodeIndex);
        currentBestNodeIndex = prevNodeIndex;
    }
    return optimalPathIndices.map((nodeIndex, t) => {
        const fingering = trellis[t][nodeIndex];
        fingering.sort((a, b) => a.string - b.string);
        return { notes: fingering, isChord: fingering.length > 1 };
    });
}

function assignFingering(tablature) {
    let handPosition = 1;
    return tablature.map(tabEvent => {
        const newNotes = tabEvent.notes.map(note => {
            if (note.finger !== undefined && note.finger !== null && note.finger !== 0) {
                if (note.fret > 0) handPosition = note.fret - note.finger + 1;
                return note;
            }
            if (note.fret === 0) return { ...note, finger: 0 };
            if (Math.abs(note.fret - handPosition) > 4 && note.fret > 0) {
                handPosition = note.fret <= 4 ? 1 : note.fret - 1;
            }
            let finger = note.fret - handPosition + 1;
            finger = Math.max(1, Math.min(4, finger));
            return { ...note, finger };
        });
        return { ...tabEvent, notes: newNotes };
    });
}

// --- Worker's main logic ---
importScripts('https://cdn.jsdelivr.net/npm/midi-parser-js');

function parseMidiFile(file) {
    return new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const base64 = e.target.result.split(',')[1];
                const midi = MidiParser.parse(base64);
                const ticksPerBeat = midi.timeDivision;
                let tempo = 500000;
                let timeSignature = { numerator: 4, denominator: 4 };
                for (const event of midi.track[0].event) {
                    if (event.metaType === 81) tempo = event.data;
                    if (event.metaType === 88) timeSignature = { numerator: event.data[0], denominator: Math.pow(2, event.data[1]) };
                }
                const secondsPerTick = (tempo / ticksPerBeat) / 1000000;
                const rawNotes = [];
                for (const track of midi.track) {
                    const openNotes = {};
                    let currentTime = 0;
                    for (const event of track.event) {
                        currentTime += event.deltaTime;
                        if (event.type === 9 && event.data[1] > 0) {
                            openNotes[event.data[0]] = currentTime;
                        } else if (event.type === 8 || (event.type === 9 && event.data[1] === 0)) {
                            const pitch = event.data[0];
                            const startTimeTicks = openNotes[pitch];
                            if (startTimeTicks !== undefined) {
                                const durationTicks = currentTime - startTimeTicks;
                                rawNotes.push({ pitch: pitch, startTime: startTimeTicks * secondsPerTick, duration: durationTicks * secondsPerTick });
                                delete openNotes[pitch];
                            }
                        }
                    }
                }
                rawNotes.sort((a, b) => a.startTime - b.startTime);
                const noteEvents = [];
                let i = 0;
                while (i < rawNotes.length) {
                    const chordNotes = [rawNotes[i]];
                    let j = i + 1;
                    while (j < rawNotes.length && Math.abs(rawNotes[j].startTime - rawNotes[i].startTime) < 0.01) {
                        chordNotes.push(rawNotes[j++]);
                    }
                    noteEvents.push({ notes: chordNotes, isChord: chordNotes.length > 1 });
                    i = j;
                }
                res({ notes: noteEvents, tempo, timeSignature });
            } catch (err) { rej(new Error("Could not read MIDI file.")); }
        };
        reader.onerror = (err) => rej(err);
        reader.readAsDataURL(file);
    });
}

onmessage = async (event) => {
    const { file, instrumentId } = event.data;
    const title = file.name.replace(/\\.(mid|midi)$/i, '').replace(/_/g, ' ');
    try {
        const songData = await parseMidiFile(file);
        if (songData.notes.length === 0) {
            postMessage({ status: 'skipped', title });
            return;
        }
        let tabWithPositions = generateTablature(songData.notes, instrumentId);
        if (tabWithPositions.length > 0 && tabWithPositions[0].notes.length > 0) {
            const firstNoteTime = tabWithPositions[0].notes[0].startTime;
            const measureDuration = ((songData.tempo || 500000) / 1000000) * (songData.timeSignature?.numerator || 4);
            if (firstNoteTime < measureDuration) {
                tabWithPositions.forEach(ev => ev.notes.forEach(n => n.startTime += measureDuration));
            }
        }
        const finalTablature = assignFingering(tabWithPositions);
        const newSong = {
            id: crypto.randomUUID(),
            title: title,
            highScore: 0,
            tablature: JSON.stringify(finalTablature),
            midiTempo: songData.tempo,
            midiTimeSignature: JSON.stringify(songData.timeSignature),
            createdAt: new Date().toISOString(),
            playbackTempo: 100,
            transpose: 0,
            zoomLevel: 1.0
        };
        postMessage({ status: 'success', song: newSong, title: newSong.title });
    } catch (error) {
        postMessage({ status: 'error', title, error: error.message });
    }
};
`,At=()=>`fretflow_songs_${t.currentInstrument}`;function ue(){localStorage.setItem("fretflow_current_instrument",t.currentInstrument)}function tt(){localStorage.setItem("fretflow_global_settings",JSON.stringify(t.globalSettings))}function de(){const n=localStorage.getItem("fretflow_global_settings");if(n)try{t.globalSettings={...t.globalSettings,...JSON.parse(n)}}catch(e){D.log(e,"LocalStorageParse_GlobalSettings")}t.ui.noteSizeSlider.value=String(t.globalSettings.noteSize),t.ui.noteSizeValue.textContent=`${Math.round(t.globalSettings.noteSize*100)}%`,t.ui.stringSpacingSlider.value=String(t.globalSettings.stringSpacing),t.ui.stringSpacingValue.textContent=`${Math.round(t.globalSettings.stringSpacing*100)}%`,t.ui.stringThicknessSlider.value=String(t.globalSettings.stringThickness),t.ui.stringThicknessValue.textContent=`${Math.round(t.globalSettings.stringThickness*100)}%`}function Bt(){const n=localStorage.getItem("fretflow_current_instrument");n&&ct[n]&&(t.currentInstrument=n);const e=localStorage.getItem(At());if(e)try{t.songs=JSON.parse(e)}catch(i){D.log(i,"LocalStorageParse_Songs"),t.songs=[]}else t.songs=[];t.ui.libraryTitle.textContent=`${I(t.currentInstrument).name} Library`,Z()}function St(){localStorage.setItem(At(),JSON.stringify(t.songs))}function ge(n){return`<div><h2 class="text-xl font-semibold">${n.title}</h2><p class="text-sm text-gray-400">High Score: ${n.highScore||0}</p></div><button class="delete-song-btn p-2 rounded-full text-gray-500 hover:text-red-500"><svg class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`}function Lt(n){const e=document.createElement("div");return e.className="song-item bg-gray-800 p-4 rounded-lg flex justify-between items-center shadow-md",e.setAttribute("data-id",n.id),e.innerHTML=ge(n),e}function me(n,e){const i=document.createElement("div");i.id=e,i.className="song-item-placeholder bg-gray-800 p-4 rounded-lg flex justify-between items-center shadow-md opacity-50",i.innerHTML=`
        <div><h2 class="text-xl font-semibold">${n}</h2><p class="text-sm text-yellow-400">Processing...</p></div>
        <div class="spinner"></div>`,t.ui.songList.prepend(i)}async function fe(n){const e=n.target.files;if(!e||e.length===0)return;const i=new Blob([le],{type:"application/javascript"}),r=URL.createObjectURL(i),o=new Worker(r),s=t.ui.songList.querySelector("p");s&&s.remove();const a=new Map;Array.from(e).forEach(c=>{const l=`placeholder-${crypto.randomUUID()}`,d=c.name.replace(/\.(mid|midi)$/i,"").replace(/_/g," ");a.set(d,l),me(d,l)}),o.onmessage=c=>{const{status:l,song:d,title:m,error:g}=c.data,p=a.get(m);if(!p)return;const x=document.getElementById(p);if(x)if(l==="success"&&d){t.songs.push(d),t.songs.sort((h,C)=>(h.createdAt||0)<(C.createdAt||0)?1:-1),St();const y=Lt(d);x.replaceWith(y)}else{const y=g||"Skipped";x.className="song-item-placeholder bg-red-900/50 p-4 rounded-lg flex justify-between items-center shadow-md",x.innerHTML=`
                <div><h2 class="text-xl font-semibold">${m}</h2><p class="text-sm text-red-400">Failed: ${y}</p></div>
                <div class="text-red-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>`}},o.onerror=c=>{D.log(c,"WorkerError")};for(const c of Array.from(e))o.postMessage({file:c,instrumentId:t.currentInstrument});n.target.value=""}function pe(n){t.songs=t.songs.filter(e=>e.id!==n),St(),Z()}function Z(){if(t.ui.songList.innerHTML="",t.songs.length===0){t.ui.songList.innerHTML=`<p class="text-gray-500">Your ${I(t.currentInstrument).name} library is empty. Click "Add Song" to start!</p>`;return}t.songs.sort((e,i)=>(e.createdAt||0)<(i.createdAt||0)?1:-1).forEach(e=>{t.ui.songList.appendChild(Lt(e))})}function he(n){var r;const e=(r=n.target.files)==null?void 0:r[0];if(!e)return;const i=new FileReader;i.onload=o=>{try{const s=JSON.parse(o.target.result);if(Array.isArray(s))t.songs=s,St(),Z();else throw new Error("Imported file is not a valid song library.")}catch(s){D.log(s,"ImportLibrary")}},i.readAsText(e)}function Se(){if(t.songs.length===0){t.ui.songList.innerHTML='<p class="text-yellow-400">Your library is empty. Nothing to export.</p>',setTimeout(()=>Z(),3e3);return}const n="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t.songs,null,2)),e=document.createElement("a");e.setAttribute("href",n),e.setAttribute("download",`fretflow_library_${t.currentInstrument}.json`),document.body.appendChild(e),e.click(),e.remove()}async function xe(n){const e=n.target.closest(".song-item");if(!e)return;const i=e.getAttribute("data-id");if(n.target.closest(".delete-song-btn")){i&&pe(i);return}const r=t.songs.find(o=>o.id===i);r&&await oe(r)}function ye(){const n=()=>{const i=t.currentInstrument==="guitar";S(t.ui.selectGuitarBtn,{"bg-blue-600":i,"text-white":i}),S(t.ui.selectUkuleleBtn,{"bg-blue-600":!i,"text-white":!i})},e=i=>{t.currentInstrument!==i&&(t.currentInstrument=i,ue(),Bt(),n())};f(t.ui.selectGuitarBtn,"click",()=>e("guitar")),f(t.ui.selectUkuleleBtn,"click",()=>e("ukulele")),f(t.ui.midiFileInput,"change",fe),f(t.ui.exportLibraryBtn,"click",Se),f(t.ui.importLibraryInput,"change",he),f(t.ui.songList,"click",xe),n()}function Ce(){f(t.ui.playPauseBtn,"click",()=>{t.isPlaying?t.isPaused?pt():ft():z()}),f(t.ui.rewindBtn,"click",()=>{A(!0),z()}),f(t.ui.practiceBackBtn,"click",async()=>{await H(),st()}),f(t.ui.editModeBtn,"click",async()=>{const n=t.isEditMode;if(t.isEditMode=!t.isEditMode,S(t.ui.practice,{"in-edit-mode":t.isEditMode}),E(),t.isEditMode)A(),t.editedTablature=JSON.parse(JSON.stringify(t.originalTablature)),t.editHistory=[],t.historyIndex=-1,t.ui.undoBtn.disabled=!0,t.ui.redoBtn.disabled=!0,t.ui.editModeBtn.textContent="Save & Exit",it(".local-setting-control").forEach(e=>e.disabled=!0),S(t.ui.editButtonsContainer,{hidden:!1});else{t.ui.editModeBtn.disabled=!0,t.ui.editModeBtn.textContent="Saving...";try{if(n&&t.pendingEdits){const e=t.songs.find(i=>i.id===t.currentSongData.id);e&&(e.tablature=JSON.stringify(t.editedTablature),t.originalTablature=JSON.parse(JSON.stringify(t.editedTablature)),localStorage.setItem(`fretflow_songs_${t.currentInstrument}`,JSON.stringify(t.songs)))}}catch(e){D.log(e,"SaveEdits")}finally{t.pendingEdits=!1,t.ui.editModeBtn.textContent="Edit",t.ui.editModeBtn.disabled=!1,it(".local-setting-control").forEach(e=>e.disabled=!1),S(t.ui.editButtonsContainer,{hidden:!0})}}k()})}function be(){f(t.ui.tempoSlider,"input",n=>{t.ui.tempoValue.textContent=`${n.target.value}%`}),f(t.ui.tempoSlider,"change",H),f(t.ui.zoomSlider,"input",n=>{if(t.zoomLevel=parseFloat(n.target.value),t.ui.zoomValue.textContent=`${Math.round(t.zoomLevel*100)}%`,t.currentSongData){const e=Math.max(150,(72*t.globalSettings.noteSize+8)/t.currentSongData.minDuration);t.currentSongData.pixelsPerSecond=e*t.zoomLevel,T(),B()}}),f(t.ui.zoomSlider,"change",H),f(t.ui.transposeDownBtn,"click",()=>{t.isEditMode||K(t.transposeOffset-1)&&(t.transposeOffset--,k(),H(),rt())}),f(t.ui.transposeUpBtn,"click",()=>{t.isEditMode||K(t.transposeOffset+1)&&(t.transposeOffset++,k(),H(),rt())}),f(t.ui.noteSizeSlider,"input",n=>{t.globalSettings.noteSize=parseFloat(n.target.value),t.ui.noteSizeValue.textContent=`${Math.round(t.globalSettings.noteSize*100)}%`,k()}),f(t.ui.noteSizeSlider,"change",tt),f(t.ui.stringSpacingSlider,"input",n=>{t.globalSettings.stringSpacing=parseFloat(n.target.value),t.ui.stringSpacingValue.textContent=`${Math.round(t.globalSettings.stringSpacing*100)}%`,nt(),T()}),f(t.ui.stringSpacingSlider,"change",tt),f(t.ui.stringThicknessSlider,"input",n=>{t.globalSettings.stringThickness=parseFloat(n.target.value),t.ui.stringThicknessValue.textContent=`${Math.round(t.globalSettings.stringThickness*100)}%`,nt(),T()}),f(t.ui.stringThicknessSlider,"change",tt)}function Te(){f(t.ui.undoBtn,"click",Pt),f(t.ui.redoBtn,"click",Ft),f(t.ui.editorCloseBtn,"click",E),f(t.ui.editorFretUp,"click",()=>n(1)),f(t.ui.editorFretDown,"click",()=>n(-1)),f(t.ui.editorFingerButtons,"click",e=>{const i=e.target.closest(".finger-btn");if(i&&t.selectedNoteIndex){const r=parseInt(i.dataset.finger),{eventIndex:o,noteIndex:s}=t.selectedNoteIndex,a=t.editedTablature[o].notes[s];a.finger!==r&&(a.finger=r,t.pendingEdits=!0,W(t.selectedNoteIndex))}});function n(e){if(!t.selectedNoteIndex)return;const i=I(t.currentInstrument),{eventIndex:r,noteIndex:o}=t.selectedNoteIndex,s=t.editedTablature[r].notes[o],a=s.fret+e;if(a>=0&&a<=i.numFrets){const c=i.tuning[s.string]+a;s.fret=a,s.pitch=c,t.pendingEdits=!0,W(t.selectedNoteIndex)}}}function Ie(){f(t.ui.dynamicCanvas,"mousedown",e=>{if(t.isEditMode){const i=Q(e.clientX,e.clientY);i?(t.isDragging=!0,t.wasDragged=!1,t.draggedNoteIndex=i,S(t.ui.dynamicCanvas,{grabbing:!0})):E()}}),f(t.ui.dynamicCanvas,"click",e=>{t.isEditMode||(t.isPlaying?t.isPaused?pt():ft():z())});const n=mt(e=>{if(!t.isEditMode||!t.currentSongData||t.isDragging)return;const i=Q(e.clientX,e.clientY);JSON.stringify(i)!==JSON.stringify(t.hoveredNoteIndex)&&(t.hoveredNoteIndex=i,T())},50);f(t.ui.dynamicCanvas,"mousemove",e=>{if(t.isDragging){t.wasDragged=!0,requestAnimationFrame(()=>T(0,e));return}n(e)}),f(t.ui.dynamicCanvas,"mouseup",e=>{if(!t.currentSongData)return;const i=I(t.currentInstrument);if(t.wasDragged&&t.draggedNoteIndex){const r=t.ui.dynamicCanvas.getBoundingClientRect(),o=e.clientY-r.top,{neckTopY:s,neckHeight:a}=v(),c=a/i.numStrings,l=Math.max(0,Math.min(i.numStrings-1,Math.round((o-s)/c-.5))),{eventIndex:d,noteIndex:m}=t.draggedNoteIndex,g=t.editedTablature[d].notes[m],p=g.pitch-i.tuning[l];p>=0&&p<=i.numFrets&&l!==g.string&&(g.string=l,g.fret=p,t.pendingEdits=!0)}else if(t.isEditMode&&!t.wasDragged){const r=Q(e.clientX,e.clientY);r&&(t.selectedNoteIndex&&t.selectedNoteIndex.eventIndex===r.eventIndex&&t.selectedNoteIndex.noteIndex===r.noteIndex?E():W(r))}t.isDragging=!1,t.draggedNoteIndex=null,t.wasDragged=!1,S(t.ui.dynamicCanvas,{grabbing:!1}),T()}),f(t.ui.dynamicCanvas,"mouseleave",()=>{t.isDragging&&(t.isDragging=!1,t.draggedNoteIndex=null,t.wasDragged=!1,S(t.ui.dynamicCanvas,{grabbing:!1}),T())})}function ve(){f(t.ui.minimapCanvas,"mousedown",i=>{if(!t.currentSongData)return;t.isScrubbingMinimap=!0,Jt(),Tt(!0);const{mode:r}=at(i);t.dragMode=r,vt(i)});const n=mt(vt,16);f(window,"mousemove",i=>{if(t.isScrubbingMinimap)n(i);else{if(!t.currentSongData||t.isEditMode){t.ui.minimapCanvas.style.cursor="pointer";return}const{mode:r}=at(i);t.ui.minimapCanvas.style.cursor=r==="start"||r==="end"?"ew-resize":"pointer"}});function e(){t.isScrubbingMinimap&&(t.isScrubbingMinimap=!1,t.dragMode=null,requestAnimationFrame(()=>Tt(!1)))}f(window,"mouseup",e),f(window,"mouseleave",e)}function De(){function n(){const i=t.ui.fullscreenBtn.innerHTML;t.ui.fullscreenBtn.textContent="Fullscreen N/A",t.ui.fullscreenBtn.disabled=!0,setTimeout(()=>{t.ui.fullscreenBtn.innerHTML=i,t.ui.fullscreenBtn.disabled=!1},2500)}f(t.ui.fullscreenBtn,"click",async()=>{if(!document.fullscreenEnabled){n();return}try{document.fullscreenElement?await document.exitFullscreen():await document.documentElement.requestFullscreen()}catch(i){D.log(i,"Fullscreen"),n()}}),f(t.ui.tunerNavBtn,"click",se),f(t.ui.summaryBackBtn,"click",st),f(t.ui.tunerBackBtn,"click",st);const e=()=>{S(t.ui.settingsMenu,{open:!1}),S(t.ui.settingsBackdrop,{open:!1})};f(t.ui.settingsBtn,"click",i=>{i.stopPropagation(),S(t.ui.settingsMenu,{open:!0}),S(t.ui.settingsBackdrop,{open:!0})}),f(t.ui.settingsBackdrop,"click",e),f(document,"click",i=>{!t.ui.settingsMenuContent.contains(i.target)&&!t.ui.settingsBtn.contains(i.target)&&e()}),f(document,"keydown",i=>{if(i.target.tagName==="INPUT"||(i.code==="Space"&&!t.ui.practice.classList.contains("hidden")&&(i.preventDefault(),t.isEditMode||(t.isPlaying?t.isPaused?pt():ft():z())),!t.isEditMode))return;const r=(i.metaKey||i.ctrlKey)&&i.key==="z"&&!i.shiftKey,o=(i.metaKey||i.ctrlKey)&&(i.key==="y"||i.key==="z"&&i.shiftKey);r&&(i.preventDefault(),Pt()),o&&(i.preventDefault(),Ft())}),f(window,"resize",mt(gt,100))}function Me(){ye(),Ce(),be(),Te(),Ie(),ve(),De()}function Ne(){re(),Wt(),de(),Bt(),Me(),$(t.ui.library)}document.addEventListener("DOMContentLoaded",Ne);
