var Yt=Object.defineProperty;var Xt=(t,n,r)=>n in t?Yt(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r;var q=(t,n,r)=>Xt(t,typeof n!="symbol"?n+"":n,r);(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function r(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=r(i);fetch(i.href,a)}})();const e={currentInstrument:"guitar",currentMode:"practice",songs:[],currentSongData:null,isPlaying:!1,isPaused:!1,isEditMode:!1,isTunerActive:!1,isScrubbingMinimap:!1,isAudioInitialized:!1,animationFrameId:null,pitchDetectionFrameId:null,songTime:0,lastTimestamp:0,currentScrollX:0,currentNoteIndex:0,loopStartTime:0,loopEndTime:null,dragMode:null,gameState:{score:0,perfectNotes:0,attemptedNotes:0,streak:0,multiplier:1},originalTablature:[],editedTablature:[],editHistory:[],historyIndex:-1,pendingEdits:!1,isDragging:!1,wasDragged:!1,draggedNoteIndex:null,selectedNoteIndex:null,hoveredNoteIndex:null,mousePosition:null,transposeOffset:0,stringShiftOffset:0,zoomLevel:1,globalSettings:{noteSize:1,stringSpacing:1,stringThickness:1,selectedInstrument:25},audioContext:null,analyser:null,micStream:null,synthMasterGain:null,synth:null,isSoundfontLoading:!1,pitchDetectionBuffer:null,fftData:null,currentDetectedMidi:null,currentDetectedFrequency:null,hmmState:null,staticCanvas:null,staticCtx:null,dynamicCanvas:null,dynamicCtx:null,minimapCanvas:null,minimapCtx:null,PLAIN_PATTERN:null,WOUND_PATTERN:null,stars:[],playheadY:0,ui:{}};function Kt(){e.gameState={score:0,perfectNotes:0,attemptedNotes:0,streak:0,multiplier:1}}class Zt{constructor(){q(this,"logs",[]);q(this,"subscribers",new Set);q(this,"maxLogEntries",500)}addEntry(n,r,o,i){this.logs.length>=this.maxLogEntries&&this.logs.shift();const a={timestamp:new Date,level:n,context:r,message:o,data:i};this.logs.push(a),this.subscribers.forEach(s=>{try{s(a)}catch(l){console.error("Error in log subscriber:",l)}});const c=[`[${r}] ${o}`];switch(i&&c.push(i),n){case"DEBUG":console.debug(...c);break;case"INFO":console.info(...c);break;case"WARN":console.warn(...c);break;case"ERROR":console.error(...c);break}}debug(n,r="General",o){this.addEntry("DEBUG",r,n,o)}info(n,r="General",o){this.addEntry("INFO",r,n,o)}warn(n,r="General",o){this.addEntry("WARN",r,n,o)}error(n,r="General",o){let i,a={...o};n instanceof Error?(i=n.message,a.stack||(a.stack=n.stack)):typeof n=="string"?i=n:typeof n=="object"&&n!==null?(i=n.message||JSON.stringify(n),a.originalError||(a.originalError=n)):i=`Unexpected error type: ${String(n)}`,this.addEntry("ERROR",r,i,a)}subscribe(n){this.subscribers.add(n)}unsubscribe(n){this.subscribers.delete(n)}getLogs(){return[...this.logs]}clear(){this.logs=[],this.info("Logs cleared","Logger")}}const y=new Zt,ke=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],ve=t=>440*Math.pow(2,(t-69)/12),St=t=>t>0?12*Math.log2(t/440)+69:null;function en(t){if(!t||t<=0)return null;const n=12*(Math.log(t/440)/Math.log(2)),r=Math.round(n)+69,o=ve(r);return{noteName:ke[r%12],octave:Math.floor(r/12)-1,frequency:t,cents:1200*Math.log2(t/o)}}const bt={guitar:{name:"Guitar",numStrings:6,numFrets:22,tuning:[64,59,55,50,45,40],stringGauges:[4,5,6,7,8,9],woundStringIndices:[3,4,5]},ukulele:{name:"Ukulele",numStrings:4,numFrets:15,tuning:[69,64,60,67],stringGauges:[4,5.2,6.4,4.4],woundStringIndices:[]}},P=t=>bt[t],ae={BUFFER_SIZE:4096,RMS_THRESHOLD:.01,YIN_THRESHOLD:.1,IN_TUNE_CENTS_THRESHOLD:10},oe=20,Fe=100,he=20,_e=Math.ceil((Fe-oe)*100/he),$=_e+1,me=_e,xe={0:"#9ca3af",1:"#f59e0b",2:"#a855f7",3:"#0ea5e9",4:"#ef4444"},se={perfect:"#4ade80",good:"#4ade80",wrong:"#f87171",missed:"#f87171"},X=16,z=12,tn=4,vt=.04,xt=[{category:"PIANO",instruments:[{name:"Acoustic Grand",program:0},{name:"Bright Acoustic",program:1},{name:"Electric Grand",program:2},{name:"Honky-Tonk",program:3},{name:"Electric Piano 1",program:4},{name:"Electric Piano 2",program:5},{name:"Harpsichord",program:6},{name:"Clavinet",program:7}]},{category:"CHROM. PERCUS.",instruments:[{name:"Celesta",program:8},{name:"Glockenspiel",program:9},{name:"Music Box",program:10},{name:"Vibraphone",program:11},{name:"Marimba",program:12},{name:"Xylophone",program:13},{name:"Tubular Bells",program:14},{name:"Dulcimer",program:15}]},{category:"ORGAN",instruments:[{name:"Drawbar Organ",program:16},{name:"Percussive Organ",program:17},{name:"Rock Organ",program:18},{name:"Church Organ",program:19},{name:"Reed Organ",program:20},{name:"Accoridan",program:21},{name:"Harmonica",program:22},{name:"Tango Accordian",program:23}]},{category:"GUITAR",instruments:[{name:"Nylon String Guitar",program:24},{name:"Steel String Guitar",program:25},{name:"Electric Jazz Guitar",program:26},{name:"Electric Clean Guitar",program:27},{name:"Electric Muted Guitar",program:28},{name:"Overdriven Guitar",program:29},{name:"Distortion Guitar",program:30},{name:"Guitar Harmonics",program:31}]},{category:"BASS",instruments:[{name:"Acoustic Bass",program:32},{name:"Electric Bass(finger)",program:33},{name:"Electric Bass(pick)",program:34},{name:"Fretless Bass",program:35},{name:"Slap Bass 1",program:36},{name:"Slap Bass 2",program:37},{name:"Synth Bass 1",program:38},{name:"Synth Bass 2",program:39}]},{category:"SOLO STRINGS",instruments:[{name:"Violin",program:40},{name:"Viola",program:41},{name:"Cello",program:42},{name:"Contrabass",program:43},{name:"Tremolo Strings",program:44},{name:"Pizzicato Strings",program:45},{name:"Orchestral Strings",program:46},{name:"Timpani",program:47}]},{category:"ENSEMBLE",instruments:[{name:"String Ensemble 1",program:48},{name:"String Ensemble 2",program:49},{name:"SynthStrings 1",program:50},{name:"SynthStrings 2",program:51},{name:"Choir Aahs",program:52},{name:"Voice Oohs",program:53},{name:"Synth Voice",program:54},{name:"Orchestra Hit",program:55}]},{category:"BRASS",instruments:[{name:"Trumpet",program:56},{name:"Trombone",program:57},{name:"Tuba",program:58},{name:"Muted Trumpet",program:59},{name:"French Horn",program:60},{name:"Brass Section",program:61},{name:"SynthBrass 1",program:62},{name:"SynthBrass 2",program:63}]},{category:"REED",instruments:[{name:"Soprano Sax",program:64},{name:"Alto Sax",program:65},{name:"Tenor Sax",program:66},{name:"Baritone Sax",program:67},{name:"Oboe",program:68},{name:"English Horn",program:69},{name:"Bassoon",program:70},{name:"Clarinet",program:71}]},{category:"PIPE",instruments:[{name:"Piccolo",program:72},{name:"Flute",program:73},{name:"Recorder",program:74},{name:"Pan Flute",program:75},{name:"Blown Bottle",program:76},{name:"Skakuhachi",program:77},{name:"Whistle",program:78},{name:"Ocarina",program:79}]},{category:"SYNTH LEAD",instruments:[{name:"Square Wave",program:80},{name:"Saw Wave",program:81},{name:"Syn. Calliope",program:82},{name:"Chiffer Lead",program:83},{name:"Charang",program:84},{name:"Solo Vox",program:85},{name:"5th Saw Wave",program:86},{name:"Bass& Lead",program:87}]},{category:"SYNTH PAD",instruments:[{name:"Fantasia",program:88},{name:"Warm Pad",program:89},{name:"Polysynth",program:90},{name:"Space Voice",program:91},{name:"Bowed Glass",program:92},{name:"Metal Pad",program:93},{name:"Halo Pad",program:94},{name:"Sweep Pad",program:95}]},{category:"SYNTH EFFECTS",instruments:[{name:"Ice Rain",program:96},{name:"Soundtrack",program:97},{name:"Crystal",program:98},{name:"Atmosphere",program:99},{name:"Brightness",program:100},{name:"Goblin",program:101},{name:"Echo Drops",program:102},{name:"Star Theme",program:103}]},{category:"ETHNIC",instruments:[{name:"Sitar",program:104},{name:"Banjo",program:105},{name:"Shamisen",program:106},{name:"Koto",program:107},{name:"Kalimba",program:108},{name:"Bagpipe",program:109},{name:"Fiddle",program:110},{name:"Shanai",program:111}]},{category:"PERCUSSIVE",instruments:[{name:"Tinkle Bell",program:112},{name:"Agogo",program:113},{name:"Steel Drums",program:114},{name:"Woodblock",program:115},{name:"Taiko Drum",program:116},{name:"Melodic Tom",program:117},{name:"Synth Drum",program:118},{name:"Reverse Cymbal",program:119}]},{category:"SOUND EFFECTS",instruments:[{name:"Guitar Fret Noise",program:120},{name:"Breath Noise",program:121},{name:"Seashore",program:122},{name:"Bird Tweet",program:123},{name:"Telephone Ring",program:124},{name:"Helicopter",program:125},{name:"Applause",program:126},{name:"Gunshot",program:127}]}],nn=Object.freeze(Object.defineProperty({__proto__:null,FADE_TIME:vt,FEEDBACK_COLORS:se,FINGER_COLORS:xe,HMM_CENTS_PER_BIN:he,HMM_NUM_PITCH_BINS:_e,HMM_NUM_STATES:$,HMM_PITCH_MAX_MIDI:Fe,HMM_PITCH_MIN_MIDI:oe,HMM_UNVOICED_STATE_INDEX:me,INSTRUMENT_CONFIG:bt,MIDI_INSTRUMENTS:xt,MINIMAP_HANDLE_H:z,MINIMAP_HANDLE_W:X,MINIMAP_HIT_PAD:tn,PITCH_DETECTION_CONFIG:ae,getInstrument:P},Symbol.toStringTag,{value:"Module"})),le=()=>e.ui.tabDisplay.clientWidth*.2;function V(){const t=e.ui.tabDisplay.clientHeight,n=t*.8*e.globalSettings.stringSpacing;return{neckTopY:(t-n)/2,neckHeight:n}}const Ke=(t=!1,n)=>{const r=document.createElement("canvas");r.width=32,r.height=4;const o=r.getContext("2d");if(t){o.fillStyle="#9E8B55",o.fillRect(0,0,r.width,r.height),o.fillStyle="#D4C28E";for(let i=0;i<r.width;i+=4)o.fillRect(i,0,2,r.height)}else{const i=o.createLinearGradient(0,0,0,r.height);i.addColorStop(0,"#ffffff"),i.addColorStop(.5,"#d0d0d0"),i.addColorStop(1,"#8a8a8a"),o.fillStyle=i,o.fillRect(0,0,r.width,r.height)}return n.createPattern(r,"repeat")},rn=()=>{e.PLAIN_PATTERN=Ke(!1,e.staticCtx),e.WOUND_PATTERN=Ke(!0,e.staticCtx)},on=()=>{e.staticCanvas=e.ui.staticCanvas,e.staticCtx=e.staticCanvas.getContext("2d"),e.dynamicCanvas=e.ui.dynamicCanvas,e.dynamicCtx=e.dynamicCanvas.getContext("2d"),e.minimapCanvas=e.ui.minimapCanvas,e.minimapCtx=e.minimapCanvas.getContext("2d"),Pe()},Pe=()=>{if(!e.dynamicCanvas||!e.staticCanvas||!e.minimapCanvas)return;const t=window.devicePixelRatio||1,n=e.ui.tabDisplay.getBoundingClientRect();if(!n.width||!n.height)return;e.staticCanvas.width=n.width*t,e.staticCanvas.height=n.height*t,e.staticCtx.setTransform(t,0,0,t,0,0),e.dynamicCanvas.width=n.width*t,e.dynamicCanvas.height=n.height*t,e.dynamicCtx.setTransform(t,0,0,t,0,0);const r=e.minimapCanvas.getBoundingClientRect();!r.width||!r.height||(e.minimapCanvas.width=r.width*t,e.minimapCanvas.height=r.height*t,e.minimapCtx.setTransform(t,0,0,t,0,0),rn(),e.ui.practice&&!e.ui.practice.classList.contains("hidden")&&(De(),R(),ee()))};function an(t,n,r=null,o,i){if(!e.currentSongData)return;const{neckTopY:a,neckHeight:c}=V(),s=c/P(e.currentInstrument).numStrings,l=72*e.globalSettings.noteSize,d=l,g=o,u=r??a+t.string*s+s/2,f=e.draggedNoteIndex&&e.draggedNoteIndex.eventIndex===n.eventIndex&&e.draggedNoteIndex.noteIndex===n.noteIndex,h=e.selectedNoteIndex&&e.selectedNoteIndex.eventIndex===n.eventIndex&&e.selectedNoteIndex.noteIndex===n.noteIndex,m=e.loopEndTime==null||t.startTime>=e.loopStartTime&&t.startTime<e.loopEndTime,b=!e.isEditMode&&!m;if(b?(e.dynamicCtx.globalAlpha=.4,e.dynamicCtx.fillStyle="#6b7280"):t.feedback&&["perfect","good","okay","late","early"].includes(t.feedback)?(e.dynamicCtx.globalAlpha=1,e.dynamicCtx.fillStyle=se.good):(e.dynamicCtx.globalAlpha=t.feedback==="missed"||t.feedback==="wrong"?.5:f?.3:1,e.dynamicCtx.fillStyle=xe[t.finger||0]),e.dynamicCtx.beginPath(),e.dynamicCtx.roundRect(g,u-l/2,i,l,l/2),e.dynamicCtx.fill(),h?(e.dynamicCtx.strokeStyle="#3b82f6",e.dynamicCtx.lineWidth=3,e.dynamicCtx.stroke()):(t.feedback==="wrong"||t.feedback==="missed")&&(e.dynamicCtx.strokeStyle=se.wrong,e.dynamicCtx.lineWidth=4,e.dynamicCtx.stroke()),!b&&t.impactTime&&performance.now()-t.impactTime<150){const A=(performance.now()-t.impactTime)/150;e.dynamicCtx.fillStyle=`rgba(255, 255, 255, ${.7*(1-A)})`,e.dynamicCtx.fill()}e.dynamicCtx.globalAlpha=b?.6:f?.5:1,e.dynamicCtx.fillStyle="white",e.dynamicCtx.shadowColor="rgba(0, 0, 0, 0.9)",e.dynamicCtx.shadowBlur=4,e.dynamicCtx.shadowOffsetX=0,e.dynamicCtx.shadowOffsetY=0,e.dynamicCtx.font=`700 ${33*e.globalSettings.noteSize}px Inter`,e.dynamicCtx.textAlign="center",e.dynamicCtx.textBaseline="middle";const T=t.fret;e.dynamicCtx.fillText(String(T),g+d/2,u+1),e.dynamicCtx.shadowColor="transparent",e.dynamicCtx.shadowBlur=0,e.dynamicCtx.globalAlpha=1}function sn(t,n,r,o,i){if(!e.currentSongData)return;const c=72*e.globalSettings.noteSize;if(t.isChord&&t.notes.length>1){const{neckTopY:s,neckHeight:l}=V(),d=l/P(e.currentInstrument).numStrings,g=t.notes.reduce((m,b)=>b.string<m.string?b:m,t.notes[0]),u=t.notes.reduce((m,b)=>b.string>m.string?b:m,t.notes[0]),f=s+g.string*d+d/2,h=s+u.string*d+d/2;e.dynamicCtx.strokeStyle="rgba(255, 255, 255, 0.2)",e.dynamicCtx.lineWidth=2,e.dynamicCtx.beginPath(),e.dynamicCtx.moveTo(o+c/2,f),e.dynamicCtx.lineTo(o+c/2,h),e.dynamicCtx.stroke()}t.notes.forEach((s,l)=>{const d=e.isDragging&&e.draggedNoteIndex&&e.draggedNoteIndex.eventIndex===n&&e.draggedNoteIndex.noteIndex===l;an(s,{eventIndex:n,noteIndex:l},d?r:null,o,i)})}function Ze(){if(!e.currentSongData||!e.currentSongData.tablature||e.currentSongData.tablature.length===0)return;const{neckTopY:t,neckHeight:n}=V(),r=n/P(e.currentInstrument).numStrings,o=le(),i=e.currentSongData.tablature[e.currentNoteIndex],a=e.currentSongData.tablature[e.currentNoteIndex+1];if(!i)return;const c=s=>{const l=s.notes.reduce((d,g)=>d+g.string,0)/s.notes.length;return t+l*r+r/2};if(e.isPlaying&&a){const s=e.songTime-i.notes[0].startTime,l=a.notes[0].startTime-i.notes[0].startTime;if(l>0){const d=Math.max(0,Math.min(1,s/l)),g=c(i),u=c(a),f=30+i.notes[0].duration*40;e.playheadY=g+(u-g)*d-4*f*d*(1-d)}else e.playheadY=c(i)}else e.playheadY=c(i);e.dynamicCtx.fillStyle="white",e.dynamicCtx.shadowColor="rgba(255, 255, 255, 0.7)",e.dynamicCtx.shadowBlur=10,e.dynamicCtx.beginPath(),e.dynamicCtx.arc(o,e.playheadY,18*e.globalSettings.noteSize,0,Math.PI*2),e.dynamicCtx.fill(),e.dynamicCtx.shadowColor="transparent",e.dynamicCtx.shadowBlur=0}function cn(){if(!e.currentSongData||!e.currentSongData.tablature||e.currentSongData.tablature.length<2)return;const t=e.currentSongData.tablature,{neckTopY:n,neckHeight:r}=V(),o=r/P(e.currentInstrument).numStrings,i=le(),a=e.currentSongData.pixelsPerSecond,c=e.currentScrollX,s=e.ui.tabDisplay.clientWidth,l=u=>{const f=u.notes.reduce((h,m)=>h+m.string,0)/u.notes.length;return n+f*o+o/2},d=(c-i)/a;let g=ue(d);g=Math.max(0,g-2);for(let u=g;u<t.length-1;u++){const f=t[u],h=t[u+1],m=i+f.notes[0].startTime*a-c;if(m>s+50)break;const b=i+h.notes[0].startTime*a-c;if(b<-50)continue;const T=l(f),A=l(h);e.dynamicCtx.save(),e.dynamicCtx.beginPath(),e.dynamicCtx.moveTo(m,T);const k=(m+b)/2,M=30+f.notes[0].duration*40,E=Math.min(T,A)-M;e.dynamicCtx.quadraticCurveTo(k,E,b,A);const D=e.dynamicCtx.createLinearGradient(m,0,b,0);D.addColorStop(0,"rgba(255, 255, 255, 0)"),D.addColorStop(.5,"rgba(255, 255, 255, 0.5)"),D.addColorStop(1,"rgba(255, 255, 255, 0)"),e.dynamicCtx.setLineDash([3,5]),e.dynamicCtx.strokeStyle=D,e.dynamicCtx.lineWidth=2,e.dynamicCtx.stroke(),e.dynamicCtx.restore()}}function De(){if(!e.staticCtx)return;const t=P(e.currentInstrument),n=e.ui.tabDisplay.clientWidth;e.ui.tabDisplay.clientHeight,e.staticCtx.clearRect(0,0,e.staticCanvas.width,e.staticCanvas.height);const{neckTopY:r,neckHeight:o}=V(),i=o/t.numStrings,a=e.staticCtx.createLinearGradient(0,0,0,r);a.addColorStop(0,"#111827"),a.addColorStop(1,"#1f2937"),e.staticCtx.fillStyle=a,e.staticCtx.fillRect(0,0,n,r),e.staticCtx.fillStyle="rgba(255, 255, 255, 0.4)",e.stars.forEach(c=>{e.staticCtx.beginPath(),e.staticCtx.arc(c.x,c.y,c.r,0,Math.PI*2),e.staticCtx.fill()}),e.staticCtx.fillStyle="#374151",e.staticCtx.fillRect(0,r,n,o);for(let c=0;c<t.numStrings;c++){const s=r+c*i+i/2,l=(t.stringGauges[c]||1.5)*e.globalSettings.stringThickness,g=t.woundStringIndices.includes(c)?e.WOUND_PATTERN:e.PLAIN_PATTERN;g&&g.setTransform&&g.setTransform(new DOMMatrix().scaleSelf(1,l/2)),e.staticCtx.save(),e.staticCtx.fillStyle=g,e.staticCtx.shadowColor="rgba(0,0,0,0.35)",e.staticCtx.shadowBlur=1.5,e.staticCtx.fillRect(0,s-l/2,n,l),e.staticCtx.restore()}}function R(t=0){var h;if(!e.dynamicCtx||!e.currentSongData)return;const{tablature:n=[],pixelsPerSecond:r,totalDuration:o,minDuration:i}=e.currentSongData,a=e.ui.tabDisplay.clientWidth;if(e.dynamicCtx.clearRect(0,0,e.dynamicCanvas.width,e.dynamicCanvas.height),n.length===0){Ze();return}const c=le(),s=e.currentScrollX,{neckTopY:l,neckHeight:d}=V(),g=(s-c)/r,u=Ve();if(u>0){const m=Math.max(u,Math.ceil(g/u)*u);for(let b=m;b<o+u*2;b+=u){const T=c+b*r-s;if(T>a+50)break;T>-50&&(e.dynamicCtx.fillStyle="rgba(255, 255, 255, 0.2)",e.dynamicCtx.fillRect(T,l,1,d))}}cn();let f=ue(g);f=Math.max(0,f-2);for(let m=f;m<n.length;m++){const b=n[m],T=b.notes[0],A=c+T.startTime*r-s;if(A>a+50)break;const M=72*e.globalSettings.noteSize,E=(T.duration-i)*r,D=M+Math.max(0,E);if(A+D>-50){let L=null;if(e.mousePosition&&e.isDragging&&((h=e.draggedNoteIndex)==null?void 0:h.eventIndex)===m){const C=e.ui.dynamicCanvas.getBoundingClientRect();L=e.mousePosition.y-C.top}sn(b,m,L,A,D)}}Ze()}function ee(){if(!e.minimapCtx||!e.currentSongData||!e.currentSongData.tablature)return;const{width:t,height:n}=e.minimapCanvas,r=window.devicePixelRatio||1,o=t/r,i=n/r;e.minimapCtx.clearRect(0,0,t,n),e.minimapCtx.fillStyle="#111827",e.minimapCtx.fillRect(0,0,o,i);const a=e.currentSongData.tablature,c=e.currentSongData.totalDuration,s=P(e.currentInstrument),l=e.songTime/c*o;if(e.minimapCtx.fillStyle="rgba(22, 101, 52, 0.5)",e.minimapCtx.fillRect(0,0,l,i),a.forEach(d=>{d.notes.forEach(g=>{const u=g.startTime/c*o,f=g.duration/c*o,h=(g.string+.5)/s.numStrings*i;g.feedback&&["perfect","good","okay","late","early"].includes(g.feedback)?e.minimapCtx.fillStyle=se.perfect:g.feedback==="wrong"||g.feedback==="missed"?e.minimapCtx.fillStyle=se.wrong:e.minimapCtx.fillStyle=xe[g.finger||0],e.minimapCtx.fillRect(u,h-3,Math.max(2,f),6)})}),e.currentMode!=="performance"&&!e.isEditMode){const d=e.loopStartTime/c*o,g=(e.loopEndTime!==null?e.loopEndTime/c:1)*o;e.minimapCtx.fillStyle="rgba(0, 0, 0, 0.5)",e.minimapCtx.fillRect(0,0,d,i),e.loopEndTime!==null&&e.minimapCtx.fillRect(g,0,o-g,i);const u=X/2,f=Math.max(u,Math.min(d,o-u)),h=Math.max(u,Math.min(g,o-u));e.minimapCtx.fillStyle="#facc15",e.minimapCtx.fillRect(f-1,0,2,i),e.minimapCtx.fillRect(h-1,0,2,i),e.minimapCtx.fillStyle="white",e.minimapCtx.fillRect(f-u,0,X,z),e.minimapCtx.fillRect(f-u,i-z,X,z),e.minimapCtx.fillRect(h-u,0,X,z),e.minimapCtx.fillRect(h-u,i-z,X,z)}e.minimapCtx.fillStyle="white",e.minimapCtx.shadowColor="rgba(255, 255, 255, 0.7)",e.minimapCtx.shadowBlur=18,e.minimapCtx.beginPath(),e.minimapCtx.arc(l,i/2,15,0,Math.PI*2),e.minimapCtx.fill(),e.minimapCtx.shadowColor="transparent",e.minimapCtx.shadowBlur=0}function ln(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function un(t){if(t.__esModule)return t;var n=t.default;if(typeof n=="function"){var r=function o(){return this instanceof o?Reflect.construct(n,arguments,this.constructor):n.apply(this,arguments)};r.prototype=n.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(t).forEach(function(o){var i=Object.getOwnPropertyDescriptor(t,o);Object.defineProperty(r,o,i.get?i:{enumerable:!0,get:function(){return t[o]}})}),r}var Tt={exports:{}},At={exports:{}};function dn(t){return t>64&&t<91?t-65:t>96&&t<123?t-71:t>47&&t<58?t+4:t===43?62:t===47?63:0}function gn(t,n){for(var r=t.replace(/[^A-Za-z0-9\+\/]/g,""),o=r.length,i=n?Math.ceil((o*3+1>>2)/n)*n:o*3+1>>2,a=new Uint8Array(i),c,s,l=0,d=0,g=0;g<o;g++)if(s=g&3,l|=dn(r.charCodeAt(g))<<18-6*s,s===3||o-g===1){for(c=0;c<3&&d<i;c++,d++)a[d]=l>>>(16>>>c&24)&255;l=0}return a}var fn={decode:gn},mn=function(t,n){return new Promise(function(r,o){var i=new XMLHttpRequest;n&&(i.responseType=n),i.open("GET",t),i.onload=function(){i.status===200?r(i.response):o(Error(i.statusText))},i.onerror=function(){o(Error("Network Error"))},i.send()})};(function(t){var n=fn,r=mn;function o(C){return function(S){return typeof S=="string"&&C.test(S)}}function i(C,S){return typeof C=="string"?C+S:typeof C=="function"?C(S):S}function a(C,S,I,w){var N=c(S)?s:l(S)?d:g(S)?u:f(S)?h:m(S)?b:T(S)?A:k(S)?M:E(S)?D:null,B=I||{};return N?N(C,S,B):w?Promise.resolve(w):Promise.reject("Source not valid ("+S+")")}a.fetch=r;function c(C){return C instanceof ArrayBuffer}function s(C,S,I){return new Promise(function(w,N){C.decodeAudioData(S,function(B){w(B)},function(){N("Can't decode audio data ("+S.slice(0,30)+"...)")})})}var l=o(/\.(mp3|wav|ogg)(\?.*)?$/i);function d(C,S,I){var w=i(I.from,S);return a(C,a.fetch(w,"arraybuffer"),I)}function g(C){return C&&typeof C.then=="function"}function u(C,S,I){return S.then(function(w){return a(C,w,I)})}var f=Array.isArray;function h(C,S,I){return Promise.all(S.map(function(w){return a(C,w,I,w)}))}function m(C){return C&&typeof C=="object"}function b(C,S,I){var w={},N=Object.keys(S).map(function(B){if(I.only&&I.only.indexOf(B)===-1)return null;var F=S[B];return a(C,F,I,F).then(function(G){w[B]=G})});return Promise.all(N).then(function(){return w})}var T=o(/\.json(\?.*)?$/i);function A(C,S,I){var w=i(I.from,S);return a(C,a.fetch(w,"text").then(JSON.parse),I)}var k=o(/^data:audio/);function M(C,S,I){var w=S.indexOf(",");return a(C,n.decode(S.slice(w+1)).buffer,I)}var E=o(/\.js(\?.*)?$/i);function D(C,S,I){var w=i(I.from,S);return a(C,a.fetch(w,"text").then(L),I)}function L(C){var S=C.indexOf("MIDI.Soundfont.");if(S<0)throw Error("Invalid MIDI.js Soundfont format");S=C.indexOf("=",S)+2;var I=C.lastIndexOf(",");return JSON.parse(C.slice(S,I)+"}")}t.exports&&(t.exports=a),typeof window<"u"&&(window.loadAudio=a)})(At);var pn=At.exports,Ct={exports:{}},hn=yn;function yn(t){var n=t.createGain(),r=n._voltage=vn(t),o=W(r),i=W(r),a=W(r);return n._startAmount=W(i),n._endAmount=W(a),n._multiplier=W(o),n._multiplier.connect(n),n._startAmount.connect(n),n._endAmount.connect(n),n.value=o.gain,n.startValue=i.gain,n.endValue=a.gain,n.startValue.value=0,n.endValue.value=0,Object.defineProperties(n,Sn),n}var Sn={attack:{value:0,writable:!0},decay:{value:0,writable:!0},sustain:{value:1,writable:!0},release:{value:0,writable:!0},getReleaseDuration:{value:function(){return this.release}},start:{value:function(t){var n=this._multiplier.gain,r=this._startAmount.gain,o=this._endAmount.gain;this._voltage.start(t),this._decayFrom=this._decayFrom=t+this.attack,this._startedAt=t;var i=this.sustain;n.cancelScheduledValues(t),r.cancelScheduledValues(t),o.cancelScheduledValues(t),o.setValueAtTime(0,t),this.attack?(n.setValueAtTime(0,t),n.linearRampToValueAtTime(1,t+this.attack),r.setValueAtTime(1,t),r.linearRampToValueAtTime(0,t+this.attack)):(n.setValueAtTime(1,t),r.setValueAtTime(0,t)),this.decay&&n.setTargetAtTime(i,this._decayFrom,et(this.decay))}},stop:{value:function(t,n){n&&(t=t-this.release);var r=t+this.release;if(this.release){var o=this._multiplier.gain,i=this._startAmount.gain,a=this._endAmount.gain;o.cancelScheduledValues(t),i.cancelScheduledValues(t),a.cancelScheduledValues(t);var c=et(this.release);if(this.attack&&t<this._decayFrom){var s=xn(0,1,this._startedAt,this._decayFrom,t);o.linearRampToValueAtTime(s,t),i.linearRampToValueAtTime(1-s,t),i.setTargetAtTime(0,t,c)}a.setTargetAtTime(1,t,c),o.setTargetAtTime(0,t,c)}return this._voltage.stop(r),r}},onended:{get:function(){return this._voltage.onended},set:function(t){this._voltage.onended=t}}},bn=new Float32Array([1,1]);function vn(t){var n=t.createBufferSource(),r=t.createBuffer(1,2,t.sampleRate);return r.getChannelData(0).set(bn),n.buffer=r,n.loop=!0,n}function W(t){var n=t.context.createGain();return t.connect(n),n}function et(t){return Math.log(t+1)/Math.log(100)}function xn(t,n,r,o,i){var a=n-t,c=o-r,s=i-r,l=s/c,d=t+l*a;return d<=t&&(d=t),d>=n&&(d=n),d}var Tn=hn,An={},Cn={gain:1,attack:.01,decay:.1,sustain:.9,release:.3,loop:!1,cents:0,loopStart:0,loopEnd:0};function wn(t,n,r){var o=!1,i=0,a={},c=t.createGain();c.gain.value=1;var s=Object.assign({},Cn,r),l={context:t,out:c,opts:s};return n instanceof AudioBuffer?l.buffer=n:l.buffers=n,l.start=function(u,f,h){if(l.buffer&&u!==null)return l.start(null,u,f);var m=u?l.buffers[u]:l.buffer;if(m){if(!o){console.warn("SamplePlayer not connected to any node.");return}}else{console.warn("Buffer "+u+" not found.");return}var b=h||An;f=Math.max(t.currentTime,f||0),l.emit("start",f,u,b);var T=g(u,m,b);return T.id=d(u,T),T.env.start(f),T.source.start(f),l.emit("started",f,T.id,T),b.duration&&T.stop(f+b.duration),T},l.play=function(u,f,h){return l.start(u,f,h)},l.stop=function(u,f){var h;return f=f||Object.keys(a),f.map(function(m){return h=a[m],h?(h.stop(u),h.id):null})},l.connect=function(u){return o=!0,c.connect(u),l},l.emit=function(u,f,h,m){l.onevent&&l.onevent(u,f,h,m);var b=l["on"+u];b&&b(f,h,m)},l;function d(u,f){return f.id=i++,a[f.id]=f,f.source.onended=function(){var h=t.currentTime;f.source.disconnect(),f.env.disconnect(),f.disconnect(),l.emit("ended",h,f.id,f)},f.id}function g(u,f,h){var m=t.createGain();return m.gain.value=0,m.connect(c),m.env=Mn(t,h,s),m.env.connect(m.gain),m.source=t.createBufferSource(),m.source.buffer=f,m.source.connect(m),m.source.loop=h.loop||s.loop,m.source.playbackRate.value=En(h.cents||s.cents),m.source.loopStart=h.loopStart||s.loopStart,m.source.loopEnd=h.loopEnd||s.loopEnd,m.stop=function(b){var T=b||t.currentTime;l.emit("stop",T,u);var A=m.env.stop(T);m.source.stop(A)},m}}function tt(t){return typeof t=="number"}var In=["attack","decay","sustain","release"];function Mn(t,n,r){var o=Tn(t),i=n.adsr||r.adsr;return In.forEach(function(a,c){i?o[a]=i[c]:o[a]=n[a]||r[a]}),o.value.value=tt(n.gain)?n.gain:tt(r.gain)?r.gain:1,o}function En(t){return t?Math.pow(2,t/1200):1}var kn=wn,Dn=function(t){return t.on=function(n,r){if(arguments.length===1&&typeof n=="function")return t.on("event",n);var o="on"+n,i=t[o];return t[o]=i?Nn(i,r):r,t},t};function Nn(t,n){return function(r,o,i,a){t(r,o,i,a),n(r,o,i,a)}}var wt=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function Bn(){return wt}var Fn=[0,2,4,5,7,9,11];function It(t,n,r){if(typeof t!="string")return null;var o=wt.exec(t);if(!o||!n&&o[4])return null;var i={letter:o[1].toUpperCase(),acc:o[2].replace(/x/g,"##")};return i.pc=i.letter+i.acc,i.step=(i.letter.charCodeAt(0)+3)%7,i.alt=i.acc[0]==="b"?-i.acc.length:i.acc.length,i.chroma=Fn[i.step]+i.alt,o[3]&&(i.oct=+o[3],i.midi=i.chroma+12*(i.oct+1),i.freq=Mt(i.midi,r)),n&&(i.tonicOf=o[4]),i}function Mt(t,n){return Math.pow(2,(t-69)/12)*(n||440)}var Et={parse:It,regex:Bn,midiToFreq:Mt},_n=["letter","acc","pc","step","alt","chroma","oct","midi","freq"];_n.forEach(function(t){Et[t]=function(n){var r=It(n);return r&&typeof r[t]<"u"?r[t]:null}});var Pn=Et,Un=Pn,Ln=function(t){return t!==null&&t!==[]&&t>=0&&t<129},Rn=function(t){return Ln(t)?+t:Un.midi(t)},Vn=function(t){if(t.buffers){var n=t.opts.map,r=typeof n=="function"?n:Rn,o=function(a){return a?r(a)||a:null};t.buffers=On(t.buffers,o);var i=t.start;t.start=function(a,c,s){var l=o(a),d=l%1;return d&&(l=Math.floor(l),s=Object.assign(s||{},{cents:Math.floor(d*100)})),i(l,c,s)}}return t};function On(t,n){return Object.keys(t).reduce(function(r,o){return r[n(o)]=t[o],r},{})}var $n=Array.isArray,Hn=function(t){return t&&typeof t=="object"},Gn={},Qn=function(t){return t.schedule=function(n,r){var o=t.context.currentTime,i=n<o?o:n;t.emit("schedule",i,r);var a,c,s,l;return r.map(function(d){if(d)$n(d)?(a=d[0],c=d[1]):(a=d.time,c=d);else return null;return Hn(c)?(s=c.name||c.key||c.note||c.midi||null,l=c):(s=c,l=Gn),t.start(s,i+(a||0),l)})},t};function ge(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var kt={exports:{}};(function(t,n){(function(r){t.exports=r()})(function(){return function r(o,i,a){function c(d,g){if(!i[d]){if(!o[d]){var u=typeof ge=="function"&&ge;if(!g&&u)return u(d,!0);if(s)return s(d,!0);var f=new Error("Cannot find module '"+d+"'");throw f.code="MODULE_NOT_FOUND",f}var h=i[d]={exports:{}};o[d][0].call(h.exports,function(m){var b=o[d][1][m];return c(b||m)},h,h.exports,r,o,i,a)}return i[d].exports}for(var s=typeof ge=="function"&&ge,l=0;l<a.length;l++)c(a[l]);return c}({1:[function(r,o,i){Object.defineProperty(i,"__esModule",{value:!0}),i.default=function(a){function c(s){if(this._event=s,this._data=s.data,this.receivedTime=s.receivedTime,this._data&&this._data.length<2){console.warn("Illegal MIDI message of length",this._data.length);return}switch(this._messageCode=s.data[0]&240,this.channel=s.data[0]&15,this._messageCode){case 128:this.messageType="noteoff",this.key=s.data[1]&127,this.velocity=s.data[2]&127;break;case 144:this.messageType="noteon",this.key=s.data[1]&127,this.velocity=s.data[2]&127;break;case 160:this.messageType="keypressure",this.key=s.data[1]&127,this.pressure=s.data[2]&127;break;case 176:this.messageType="controlchange",this.controllerNumber=s.data[1]&127,this.controllerValue=s.data[2]&127,this.controllerNumber===120&&this.controllerValue===0?this.channelModeMessage="allsoundoff":this.controllerNumber===121?this.channelModeMessage="resetallcontrollers":this.controllerNumber===122?this.controllerValue===0?this.channelModeMessage="localcontroloff":this.channelModeMessage="localcontrolon":this.controllerNumber===123&&this.controllerValue===0?this.channelModeMessage="allnotesoff":this.controllerNumber===124&&this.controllerValue===0?this.channelModeMessage="omnimodeoff":this.controllerNumber===125&&this.controllerValue===0?this.channelModeMessage="omnimodeon":this.controllerNumber===126?this.channelModeMessage="monomodeon":this.controllerNumber===127&&(this.channelModeMessage="polymodeon");break;case 192:this.messageType="programchange",this.program=s.data[1];break;case 208:this.messageType="channelpressure",this.pressure=s.data[1]&127;break;case 224:this.messageType="pitchbendchange";var l=s.data[2]&127,d=s.data[1]&127;this.pitchBend=(l<<8)+d;break}}return new c(a)},o.exports=i.default},{}]},{},[1])(1)})})(kt);var qn=kt.exports,zn=qn,Jn=function(t){return t.listenToMidi=function(n,r){var o={},i=r||{},a=i.gain||function(c){return c/127};return n.onmidimessage=function(c){var s=c.messageType?c:zn(c);if(s.messageType==="noteon"&&s.velocity===0&&(s.messageType="noteoff"),!(i.channel&&s.channel!==i.channel))switch(s.messageType){case"noteon":o[s.key]=t.play(s.key,0,{gain:a(s.velocity)});break;case"noteoff":o[s.key]&&(o[s.key].stop(),delete o[s.key]);break}},t},t};(function(t){var n=kn,r=Dn,o=Vn,i=Qn,a=Jn;function c(s,l,d){return a(i(o(r(n(s,l,d)))))}t.exports&&(t.exports=c),typeof window<"u"&&(window.SamplePlayer=c)})(Ct);var jn=Ct.exports;function nt(t,n){return Array(n+1).join(t)}function Ue(t){return typeof t=="number"}function Wn(t){return typeof t=="string"}function Yn(t){return typeof t<"u"}function Dt(t,n){return Math.pow(2,(t-69)/12)*(n||440)}var Nt=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function Xn(){return Nt}var Kn=[0,2,4,5,7,9,11];function H(t,n,r){if(typeof t!="string")return null;var o=Nt.exec(t);if(!o||!n&&o[4])return null;var i={letter:o[1].toUpperCase(),acc:o[2].replace(/x/g,"##")};i.pc=i.letter+i.acc,i.step=(i.letter.charCodeAt(0)+3)%7,i.alt=i.acc[0]==="b"?-i.acc.length:i.acc.length;var a=Kn[i.step]+i.alt;return i.chroma=a<0?12+a:a%12,o[3]&&(i.oct=+o[3],i.midi=a+12*(i.oct+1),i.freq=Dt(i.midi,r)),n&&(i.tonicOf=o[4]),i}var Zn="CDEFGAB";function er(t){return Ue(t)?t<0?nt("b",-t):nt("#",t):""}function tr(t){return Ue(t)?""+t:""}function Bt(t,n,r){return t===null||typeof t>"u"?null:t.step?Bt(t.step,t.alt,t.oct):t<0||t>6?null:Zn.charAt(t)+er(n)+tr(r)}function Ft(t){if((Ue(t)||Wn(t))&&t>=0&&t<128)return+t;var n=H(t);return n&&Yn(n.midi)?n.midi:null}function nr(t,n){var r=Ft(t);return r===null?null:Dt(r,n)}function rr(t){return(H(t)||{}).letter}function ir(t){return(H(t)||{}).acc}function or(t){return(H(t)||{}).pc}function ar(t){return(H(t)||{}).step}function sr(t){return(H(t)||{}).alt}function cr(t){return(H(t)||{}).chroma}function lr(t){return(H(t)||{}).oct}const ur=Object.freeze(Object.defineProperty({__proto__:null,acc:ir,alt:sr,build:Bt,chroma:cr,freq:nr,letter:rr,midi:Ft,oct:lr,parse:H,pc:or,regex:Xn,step:ar},Symbol.toStringTag,{value:"Module"})),dr=un(ur);var we,rt;function gr(){if(rt)return we;rt=1;var t=dr;function n(i,a){if(console.warn("new Soundfont() is deprected"),console.log("Please use Soundfont.instrument() instead of new Soundfont().instrument()"),!(this instanceof n))return new n(i);this.nameToUrl=a||n.nameToUrl,this.ctx=i,this.instruments={},this.promises=[]}n.prototype.onready=function(i){console.warn("deprecated API"),console.log("Please use Promise.all(Soundfont.instrument(), Soundfont.instrument()).then() instead of new Soundfont().onready()"),Promise.all(this.promises).then(i)},n.prototype.instrument=function(i,a){console.warn("new Soundfont().instrument() is deprecated."),console.log("Please use Soundfont.instrument() instead.");var c=this.ctx;if(i=i||"default",i in this.instruments)return this.instruments[i];var s={name:i,play:o(c,a)};if(this.instruments[i]=s,i!=="default"){var l=n.instrument(c,i,a).then(function(d){return s.play=d.play,s});this.promises.push(l),s.onready=function(d){console.warn("onready is deprecated. Use Soundfont.instrument().then()"),l.then(d)}}else s.onready=function(d){console.warn("onready is deprecated. Use Soundfont.instrument().then()"),d()};return s};function r(i,a,c){return console.warn("Soundfont.loadBuffers is deprecate."),console.log("Use Soundfont.instrument(..) and get buffers properties from the result."),n.instrument(i,a,c).then(function(s){return s.buffers})}n.loadBuffers=r;function o(i,a){return a=a||{},function(c,s,l,d){console.warn("The oscillator player is deprecated."),console.log("Starting with version 0.9.0 you will have to wait until the soundfont is loaded to play sounds.");var g=c>0&&c<129?+c:t.midi(c),u=g?t.midiToFreq(g,440):null;if(u){l=l||.2,d=d||{};var f=d.destination||a.destination||i.destination,h=d.vcoType||a.vcoType||"sine",m=d.gain||a.gain||.4,b=i.createOscillator();b.type=h,b.frequency.value=u;var T=i.createGain();return T.gain.value=m,b.connect(T),T.connect(f),b.start(s),l>0&&b.stop(s+l),b}}}return n.noteToMidi=t.midi,we=n,we}(function(t){var n=pn,r=jn;function o(s,l,d){if(arguments.length===1)return function(m,b){return o(s,m,b)};var g=d||{},u=g.isSoundfontURL||i,f=g.nameToUrl||a,h=u(l)?l:f(l,g.soundfont,g.format);return n(s,h,{only:g.only||g.notes}).then(function(m){var b=r(s,m,g).connect(g.destination?g.destination:s.destination);return b.url=h,b.name=l,b})}function i(s){return/\.js(\?.*)?$/i.test(s)}function a(s,l,d){return d=d==="ogg"?d:"mp3",l=l==="FluidR3_GM"?l:"MusyngKite","https://gleitz.github.io/midi-js-soundfonts/"+l+"/"+s+"-"+d+".js"}var c=gr();c.instrument=o,c.nameToUrl=a,t.exports&&(t.exports=c),typeof window<"u"&&(window.Soundfont=c)})(Tt);var fr=Tt.exports;const it=ln(fr),p=(t,n=document)=>n.querySelector(t),_t=(t,n=document)=>[...n.querySelectorAll(t)],x=(t,n,r,o)=>t.addEventListener(n,r,o),v=(t,n)=>{Object.entries(n).forEach(([r,o])=>t.classList.toggle(r,o))},Le=(t,n)=>{let r=0;return(...o)=>{const i=performance.now();i-r>n&&(r=i,t(...o))}},mr={0:"acoustic_grand_piano",1:"bright_acoustic_piano",2:"electric_grand_piano",3:"honky_tonk_piano",4:"electric_piano_1",5:"electric_piano_2",6:"harpsichord",7:"clavinet",8:"celesta",9:"glockenspiel",10:"music_box",11:"vibraphone",12:"marimba",13:"xylophone",14:"tubular_bells",15:"dulcimer",16:"drawbar_organ",17:"percussive_organ",18:"rock_organ",19:"church_organ",20:"reed_organ",21:"accordion",22:"harmonica",23:"tango_accordion",24:"acoustic_guitar_nylon",25:"acoustic_guitar_steel",26:"electric_guitar_jazz",27:"electric_guitar_clean",28:"electric_guitar_muted",29:"overdriven_guitar",30:"distortion_guitar",31:"guitar_harmonics",32:"acoustic_bass",33:"electric_bass_finger",34:"electric_bass_pick",35:"fretless_bass",36:"slap_bass_1",37:"slap_bass_2",38:"synth_bass_1",39:"synth_bass_2",40:"violin",41:"viola",42:"cello",43:"contrabass",44:"tremolo_strings",45:"pizzicato_strings",46:"orchestral_harp",47:"timpani",48:"string_ensemble_1",49:"string_ensemble_2",50:"synth_strings_1",51:"synth_strings_2",52:"choir_aahs",53:"voice_oohs",54:"synth_voice",55:"orchestra_hit",56:"trumpet",57:"trombone",58:"tuba",59:"muted_trumpet",60:"french_horn",61:"brass_section",62:"synth_brass_1",63:"synth_brass_2",64:"soprano_sax",65:"alto_sax",66:"tenor_sax",67:"baritone_sax",68:"oboe",69:"english_horn",70:"bassoon",71:"clarinet",72:"piccolo",73:"flute",74:"recorder",75:"pan_flute",76:"blown_bottle",77:"shakuhachi",78:"whistle",79:"ocarina",80:"lead_1_square",81:"lead_2_sawtooth",82:"lead_3_calliope",83:"lead_4_chiff",84:"lead_5_charang",85:"lead_6_voice",86:"lead_7_fifths",87:"lead_8_bass_and_lead",88:"pad_1_new_age",89:"pad_2_warm",90:"pad_3_polysynth",91:"pad_4_choir",92:"pad_5_bowed",93:"pad_6_metallic",94:"pad_7_halo",95:"pad_8_sweep",96:"fx_1_rain",97:"fx_2_soundtrack",98:"fx_3_crystal",99:"fx_4_atmosphere",100:"fx_5_brightness",101:"fx_6_goblins",102:"fx_7_echoes",103:"fx_8_sci_fi",104:"sitar",105:"banjo",106:"shamisen",107:"koto",108:"kalimba",109:"bagpipe",110:"fiddle",111:"shanai",112:"tinkle_bell",113:"agogo",114:"steel_drums",115:"woodblock",116:"taiko_drum",117:"melodic_tom",118:"synth_drum",119:"reverse_cymbal",120:"guitar_fret_noise",121:"breath_noise",122:"seashore",123:"bird_tweet",124:"telephone_ring",125:"helicopter",126:"applause",127:"gunshot"},re="acoustic_grand_piano",fe=0;async function Pt(t){if(!e.audioContext){y.warn("AudioContext not ready, cannot load instrument.","Audio");return}let n=mr[t];n||(y.warn(`No soundfont mapped for program ${t}. Falling back to default: ${re}.`,"Audio"),n=re,t=fe),y.info(`Loading instrument: ${n} (program ${t})`,"Audio"),e.isSoundfontLoading=!0;const r=e.ui.instrumentSelector;r&&(r.disabled=!0);try{const o=await it.instrument(e.audioContext,n,{soundfont:"MusyngKite",destination:e.synthMasterGain,gain:2});e.synth&&e.synth.stop(),e.synth=o,y.info(`Instrument ${n} loaded successfully.`,"Audio")}catch(o){const i=`Failed to load instrument: ${n}. It might not be available. Please try another one.`;y.error(o,"LoadInstrument",{instrumentName:n,program:t}),alert(i),y.warn(`Attempting to load fallback instrument '${re}'.`,"Audio");try{const a=await it.instrument(e.audioContext,re,{soundfont:"MusyngKite",destination:e.synthMasterGain,gain:2});e.synth&&e.synth.stop(),e.synth=a,e.globalSettings.selectedInstrument=fe,r&&(r.value=String(fe)),y.info("Fallback instrument loaded successfully.","Audio")}catch(a){y.error(a,"LoadInstrument",{instrumentName:re,program:fe,context:"Fallback attempt"}),alert("CRITICAL: Failed to load even the fallback instrument. Audio playback will not work.")}}finally{e.isSoundfontLoading=!1,r&&(r.disabled=!1)}}async function Ut(t=!1){if(e.isAudioInitialized&&e.audioContext&&e.audioContext.state==="running"){t&&!e.pitchDetectionFrameId&&Ne();return}e.audioContext&&e.audioContext.state==="suspended"&&(y.info("Resuming suspended AudioContext","Audio"),await e.audioContext.resume());try{e.audioContext||(y.info("Initializing new AudioContext","Audio"),e.audioContext=new(window.AudioContext||window.webkitAudioContext),e.synthMasterGain=e.audioContext.createGain(),e.synthMasterGain.connect(e.audioContext.destination),await Pt(e.globalSettings.selectedInstrument)),e.micStream||(y.info("Requesting microphone access (getUserMedia)","Audio"),e.micStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),e.analyser=e.audioContext.createAnalyser(),e.analyser.fftSize=ae.BUFFER_SIZE,e.pitchDetectionBuffer=new Float32Array(ae.BUFFER_SIZE),e.fftData=new Uint8Array(e.analyser.frequencyBinCount),e.audioContext.createMediaStreamSource(e.micStream).connect(e.analyser),y.info("Microphone access granted and audio chain configured","Audio")),[e.ui.practiceMicMsg,e.ui.tunerMicMsg].forEach(n=>v(n,{hidden:!0})),e.isAudioInitialized=!0,t&&(Rt(),Ne())}catch(n){[e.ui.practiceMicMsg,e.ui.tunerMicMsg].forEach(r=>v(r,{hidden:!1})),y.error(n,"AudioInit"),e.isAudioInitialized=!1}}function Lt(){e.pitchDetectionFrameId&&(cancelAnimationFrame(e.pitchDetectionFrameId),e.pitchDetectionFrameId=null,y.info("Pitch detection stopped.","Audio")),e.isTunerActive=!1}function pr(){if(!e.analyser||!e.pitchDetectionBuffer)return[];e.analyser.getFloatTimeDomainData(e.pitchDetectionBuffer);let t=0;for(let i=0;i<e.pitchDetectionBuffer.length;i++)t+=e.pitchDetectionBuffer[i]*e.pitchDetectionBuffer[i];if(t=Math.sqrt(t/e.pitchDetectionBuffer.length),t<ae.RMS_THRESHOLD)return[];const n=new Float32Array(Math.floor(e.pitchDetectionBuffer.length/2));let r=0;n[0]=1;for(let i=1;i<n.length;i++){let a=0;for(let c=0;c<n.length;c++){const s=e.pitchDetectionBuffer[c]-e.pitchDetectionBuffer[c+i];a+=s*s}r+=a,n[i]=a/(r/i+1e-6)}const o=[];for(let i=.05;i<.5;i+=.05){let a=-1;for(let c=2;c<n.length-1;c++)if(n[c]<i&&n[c]<n[c-1]&&n[c]<n[c+1]){a=c;break}if(a!==-1){const c=e.audioContext.sampleRate/a,s=1-n[a]/i;o.push({pitch:c,probability:s})}}return o}function Rt(){e.hmmState={T1:new Float32Array($).fill(1/$),T2:Array.from({length:$},()=>[]),path:[]}}function hr(t){e.hmmState||Rt();const n=new Float32Array($).fill(1e-6);t.length===0?n[me]=1:(t.forEach(s=>{const l=St(s.pitch);if(l!==null&&l>=oe&&l<=Fe){const d=Math.floor((l-oe)*100/he);n[d]=Math.max(n[d],s.probability)}}),n[me]=1-Math.max(...n));const r=new Float32Array($),o=new Int32Array($);for(let s=0;s<$;s++){let l=0,d=0;for(let g=0;g<$;g++){const u=g===s?.9:Math.abs(g-s)===1?.05:1e-4,f=e.hmmState.T1[g]*u;f>l&&(l=f,d=g)}r[s]=l*n[s],o[s]=d}const i=r.reduce((s,l)=>s+l,0);if(i>0)for(let s=0;s<r.length;s++)r[s]/=i;e.hmmState.T1=r;let a=0,c=0;for(let s=0;s<e.hmmState.T1.length;s++)e.hmmState.T1[s]>c&&(c=e.hmmState.T1[s],a=s);return a===me?null:ve(oe+a*he/100)}function Ne(){try{e.analyser&&e.analyser.getByteFrequencyData(e.fftData);const t=pr(),n=hr(t);if(e.currentDetectedFrequency=n&&n>60&&n<1600?n:null,e.isTunerActive){const r=e.currentDetectedFrequency?en(e.currentDetectedFrequency):null;yr(r)}else{const r=e.currentDetectedFrequency?St(e.currentDetectedFrequency):null;e.currentDetectedMidi=r?Math.round(r):null}}catch(t){y.error(t,"PitchDetectionLoop"),e.pitchDetectionFrameId&&(cancelAnimationFrame(e.pitchDetectionFrameId),e.pitchDetectionFrameId=null);return}e.pitchDetectionFrameId=requestAnimationFrame(Ne)}function yr(t){const n=e.ui;if(!t){n.tunerNoteName.textContent="-",n.tunerStatus.textContent="...",n.tunerStatus.className="text-xl font-semibold text-gray-500 h-7",n.tunerFreq.textContent="0 Hz",n.tunerNeedle.style.transform="rotate(0deg)",v(n.tunerCircle,{good:!1});return}const{noteName:r,frequency:o,cents:i}=t;n.tunerNoteName.textContent=r,n.tunerFreq.textContent=`${o.toFixed(2)} Hz`;const a=Math.max(-45,Math.min(45,i*.9));n.tunerNeedle.style.transform=`rotate(${a}deg)`,Math.abs(i)<ae.IN_TUNE_CENTS_THRESHOLD?(n.tunerStatus.textContent="Good Job!",n.tunerStatus.className="text-xl font-semibold text-green-400 h-7",v(n.tunerCircle,{good:!0})):i<0?(n.tunerStatus.textContent="Too Low",n.tunerStatus.className="text-xl font-semibold text-yellow-400 h-7",v(n.tunerCircle,{good:!1})):(n.tunerStatus.textContent="Too High",n.tunerStatus.className="text-xl font-semibold text-red-400 h-7",v(n.tunerCircle,{good:!1}))}function Vt(){e.synth&&e.synth.stop()}function ot(t){if(!e.synthMasterGain||!e.audioContext)return;const n=e.audioContext.currentTime,r=t?1e-4:1;e.synthMasterGain.gain.cancelScheduledValues(n),e.synthMasterGain.gain.linearRampToValueAtTime(r,n+vt)}function Sr(t){if(!e.synth||e.isSoundfontLoading||!t)return;const n=parseInt(e.ui.tempoSlider.value)/100,r=t.duration/n;e.synth.play(t.pitch,void 0,{duration:r})}const at={PERFECT:.15,LATE:.6},Ot={CENTS_TOLERANCE_FOR_GAMEPLAY:60,FFT_ENERGY_THRESHOLD:180};function br(t,n,r,o){if(!n||!r||!o)return!1;for(const i of t){const a=ve(i.pitch),c=Math.round(a*(o.fftSize/2)/r.sampleRate);let s=0;for(let l=-2;l<=2;l++)n[c+l]>s&&(s=n[c+l]);if(s<Ot.FFT_ENERGY_THRESHOLD)return!1}return!0}function vr(t,n,r,o,i,a){const c=Math.abs(n);if(n<=0&&c<at.LATE){let s=!1;if(t.isChord)s=br(t.notes,o,i,a);else if(r!==null){const l=t.notes[0],d=ve(l.pitch);let g=1200*Math.log2(r/d);Math.abs(g)>800&&(g%=1200),s=Math.abs(g)<Ot.CENTS_TOLERANCE_FOR_GAMEPLAY}if(s)return c<at.PERFECT?{scoreChange:100,perfectNotesChange:1,attemptedNotesChange:1,wasCorrect:!0,feedback:"perfect"}:{scoreChange:75,perfectNotesChange:0,attemptedNotesChange:1,wasCorrect:!0,feedback:n>0?"early":"late"};if(n<-.3)return{scoreChange:0,perfectNotesChange:0,attemptedNotesChange:1,wasCorrect:!1,feedback:"wrong"}}return n<-.6?{scoreChange:0,perfectNotesChange:0,attemptedNotesChange:1,wasCorrect:!1,feedback:"missed"}:null}function xr(t){const n=e.ui;t?(e.gameState.streak+=1,e.gameState.streak>0&&e.gameState.streak%10===0&&e.gameState.multiplier<8&&(e.gameState.multiplier+=1)):(e.gameState.streak=0,e.gameState.multiplier=1),n.streakDisplay.textContent=`${e.gameState.multiplier}x`,t&&(v(n.streakDisplay,{"streak-increased":!1}),n.streakDisplay.offsetWidth,v(n.streakDisplay,{"streak-increased":!0}))}function Tr(t){if(!e.currentSongData||!e.analyser)return;const n=e.loopEndTime!==null&&e.loopEndTime<e.currentSongData.totalDuration,r=e.currentSongData.tablature[e.currentNoteIndex];if(r){const s=r.notes[0].pitch,l=r.isChord?"Chord":ke[s%12];e.ui.targetNoteDisplay.textContent=`Target: ${l}`;const d=e.currentDetectedMidi!==null?ke[e.currentDetectedMidi%12]:"--";e.ui.pitchDisplay.textContent=`Detected: ${d}`}const o=5,i=5,a=Math.max(0,e.currentNoteIndex-o),c=Math.min(e.currentSongData.tablature.length,e.currentNoteIndex+i);for(let s=a;s<c;s++){const l=e.currentSongData.tablature[s];if(l.isScored)continue;const d=l.notes[0].startTime-e.songTime;if(!e.isScrubbingMinimap&&d<.05&&!l.notes[0].isAudioTriggered&&l.notes.forEach(f=>{Sr(f),f.isAudioTriggered=!0,f.impactTime=t}),!(!n||e.songTime>=e.loopStartTime&&e.songTime<e.loopEndTime))continue;const u=vr(l,d,e.currentDetectedFrequency,e.fftData,e.audioContext,e.analyser);if(u){l.isScored=!0,e.gameState.score+=u.scoreChange*e.gameState.multiplier,e.gameState.perfectNotes+=u.perfectNotesChange,e.gameState.attemptedNotes+=u.attemptedNotesChange,xr(u.wasCorrect),l.notes.forEach(h=>h.feedback=u.feedback);const f={perfect:"Perfect!",good:"Good!",early:"Early",late:"Late",wrong:"Wrong Note",missed:"Missed"};e.ui.feedbackDisplay.textContent=`Feedback: ${f[u.feedback]||"--"}`,e.ui.scoreDisplay.textContent=`Score: ${e.gameState.score}`}}}function ye(t){if(!e.isPlaying||e.isPaused||!e.currentSongData||!e.currentSongData.tablature){e.animationFrameId=null;return}if(e.lastTimestamp===0){e.lastTimestamp=t,e.animationFrameId=requestAnimationFrame(ye);return}const n=(t-e.lastTimestamp)/1e3;e.lastTimestamp=t;const r=parseInt(e.ui.tempoSlider.value)/100;if(e.songTime+=n*r,e.currentMode==="practice"&&e.loopEndTime!==null&&e.songTime>=e.loopEndTime){const o=Ve(),i=Math.floor(e.loopStartTime/o)*o,a=Math.max(0,i-o);e.songTime=a,e.currentScrollX=e.songTime*e.currentSongData.pixelsPerSecond,e.currentSongData.tablature.forEach(c=>{c.notes[0].startTime>=a&&(c.notes.forEach(s=>{delete s.isAudioTriggered,delete s.impactTime,delete s.feedback}),delete c.isScored)}),y.info("Looping back to start","Game",{loopStartTime:e.loopStartTime,newSongTime:e.songTime})}e.currentScrollX=e.songTime*e.currentSongData.pixelsPerSecond,e.currentNoteIndex=ue(e.songTime),Tr(t),R(t),ee(),e.currentSongData.totalDuration&&e.songTime>e.currentSongData.totalDuration+2?Cr():e.animationFrameId=requestAnimationFrame(ye)}function Z(){if(!e.currentSongData||e.isPlaying||!e.currentSongData.tablature||e.currentSongData.tablature.length===0)return;if(y.info("Starting animation","Game"),e.loopEndTime!==null&&e.loopEndTime<e.currentSongData.totalDuration&&e.songTime<=e.loopStartTime){const n=Ve(),r=Math.floor(e.loopStartTime/n)*n,o=Math.max(0,r-n);e.songTime=o}e.synthMasterGain&&e.audioContext&&(e.synthMasterGain.gain.cancelScheduledValues(e.audioContext.currentTime),e.synthMasterGain.gain.setValueAtTime(1,e.audioContext.currentTime)),e.isPlaying=!0,e.isPaused=!1,v(e.ui.playIcon,{hidden:!0}),v(e.ui.pauseIcon,{hidden:!1}),e.lastTimestamp=0,e.animationFrameId=requestAnimationFrame(ye)}function Se(){!e.isPlaying||e.isPaused||(y.info("Pausing animation","Game"),e.isPaused=!0,v(e.ui.playIcon,{hidden:!1}),v(e.ui.pauseIcon,{hidden:!0}),e.synthMasterGain&&e.audioContext&&e.synthMasterGain.gain.exponentialRampToValueAtTime(1e-4,e.audioContext.currentTime+.05))}function Re(){!e.isPlaying||!e.isPaused||(y.info("Resuming animation","Game"),e.isPaused=!1,v(e.ui.playIcon,{hidden:!0}),v(e.ui.pauseIcon,{hidden:!1}),e.lastTimestamp=0,e.synthMasterGain&&e.audioContext&&(e.synthMasterGain.gain.cancelScheduledValues(e.audioContext.currentTime),e.synthMasterGain.gain.setValueAtTime(1,e.audioContext.currentTime)),e.animationFrameId||(e.animationFrameId=requestAnimationFrame(ye)))}function j(t=!1){e.animationFrameId&&cancelAnimationFrame(e.animationFrameId),e.animationFrameId=null,e.isPlaying=!1,e.isPaused=!1,v(e.ui.playIcon,{hidden:!1}),v(e.ui.pauseIcon,{hidden:!0}),e.currentSongData&&Ar(t)}function Ar(t=!1){Kt(),t&&e.currentSongData?e.songTime=e.loopStartTime:(e.songTime=0,e.currentSongData&&(e.loopStartTime=0,e.loopEndTime=e.currentSongData.totalDuration)),e.currentScrollX=e.currentSongData?e.songTime*e.currentSongData.pixelsPerSecond:0,e.lastTimestamp=0,e.currentNoteIndex=ue(e.songTime),e.ui.scoreDisplay.textContent="Score: 0",e.ui.streakDisplay.textContent="1x",e.ui.targetNoteDisplay.textContent="Target: --",e.ui.feedbackDisplay.textContent="Feedback: --",e.ui.pitchDisplay.textContent="Detected: --",e.stars=[];for(let n=0;n<100;n++){const{neckTopY:r}=V();e.stars.push({x:Math.random()*e.ui.tabDisplay.clientWidth,y:Math.random()*r,r:Math.random()*1.5})}e.currentSongData&&e.currentSongData.tablature&&e.currentSongData.tablature.forEach(n=>{n.notes[0].startTime>=e.songTime&&(delete n.isScored,n.notes.forEach(r=>{delete r.isAudioTriggered,delete r.impactTime,delete r.feedback}))}),R(),ee()}function Cr(){if(!e.currentSongData)return;y.info(`Session ended in ${e.currentMode} mode.`,"Game",{score:e.gameState.score,perfect:e.gameState.perfectNotes,attempted:e.gameState.attemptedNotes});const t=e.gameState.score,n=e.currentSongData.highScore||0;e.ui.summaryScore.textContent=String(t);const r=e.gameState.attemptedNotes>0?Math.round(e.gameState.perfectNotes/e.gameState.attemptedNotes*100):0;if(e.ui.summaryAccuracy.textContent=`${r}%`,e.currentMode==="performance"&&t>n){y.info(`New high score achieved in Performance Mode: ${t} with ${r}% accuracy.`,"Game");const o=e.songs.find(i=>i.id===e.currentSongData.id);o&&(o.highScore=t,o.accuracy=r,localStorage.setItem(`fretflow_songs_${e.currentInstrument}`,JSON.stringify(e.songs)))}else e.currentMode==="practice"&&y.info(`Practice session score ${t} will not be saved.`,"Game");j(),Rr()}function ue(t){var a,c,s;const n=(a=e.currentSongData)==null?void 0:a.tablature;if(!n||n.length===0)return 0;let r=0,o=n.length-1,i=0;for(;r<=o;){const l=r+Math.floor((o-r)/2),d=(s=(c=n[l])==null?void 0:c.notes[0])==null?void 0:s.startTime;if(d===void 0){o=l-1;continue}d<=t?(i=l,r=l+1):o=l-1}return i}function Ve(){if(!e.currentSongData)return 2;const{midiTempo:t,midiTimeSignature:n}=e.currentSongData,r=t||5e5,o=n?JSON.parse(n):{numerator:4},i=r/1e6,a=o.numerator||4;return i*a}function Oe(t,n,r=new Set){const o=[],i=P(n);return i.tuning.forEach((a,c)=>{if(r.has(c))return;const s=t-a;s>=0&&s<=i.numFrets&&o.push({string:c,fret:s})}),o}function wr(t){let n=0;const r=t.map(a=>a.fret).filter(a=>a>0),o=12,i=.3;return r.length>0&&r.forEach(a=>{a>o&&(n+=Math.pow(a-o,2)*i)}),r.length>1&&(n+=Math.pow(Math.max(...r)-Math.min(...r),2)*.5),t.some(a=>a.fret===0)&&(n-=2),r.length>0&&(n+=r.reduce((a,c)=>a+c,0)/r.length*.1),n}function Ir(t,n){if(!t||t.length===0)return 0;let r=0;const o=n.map(s=>s.fret).filter(s=>s>0),i=t.map(s=>s.fret).filter(s=>s>0);if(o.length>0&&i.length>0){const s=o.reduce((d,g)=>d+g,0)/o.length,l=i.reduce((d,g)=>d+g,0)/i.length;r+=Math.abs(s-l)*1.5}const a=n.reduce((s,l)=>s+l.string,0)/n.length,c=t.reduce((s,l)=>s+l.string,0)/t.length;return r+=Math.abs(a-c)*.2,r}function $t(t,n){if(!t||t.length===0)return[];const r=P(n),o=[];for(const u of t){let f=function(A,k,M){if(A===m.length){T.push(k);return}if(!(!b[A]||b[A].length===0)){for(const E of b[A])if(!M.has(E.string)){const D={...m[A],...E,finger:0},L=[...k,D],C=new Set(M).add(E.string);f(A+1,L,C)}}};const h=u.notes.map(A=>({note:A,positions:Oe(A.pitch,n)})).filter(A=>A.positions.length>0);if(h.length===0){u.notes.length>0&&y.warn(`Skipping event at time ${u.notes[0].startTime.toFixed(2)}s: No playable notes found for this event.`,"TablatureGeneration");continue}if(h.length<u.notes.length&&y.warn(`Simplified chord at time ${u.notes[0].startTime.toFixed(2)}s: Some notes were out of range.`,"TablatureGeneration"),h.length>r.numStrings){y.warn(`Skipping event at time ${u.notes[0].startTime.toFixed(2)}s: Chord has more notes (${h.length}) than available strings (${r.numStrings}).`,"TablatureGeneration");continue}const m=h.map(A=>A.note),b=h.map(A=>A.positions),T=[];if(f(0,[],new Set),T.length>0){let A=T.map(M=>({fingering:M,internalCost:wr(M)}));A.sort((M,E)=>M.internalCost-E.internalCost),o.push(A.slice(0,30))}else u.notes.length>0&&y.warn(`Skipping unplayable event at time ${u.notes[0].startTime.toFixed(2)}s`,"TablatureGeneration")}if(o.length===0)return y.warn("Tablature generation resulted in 0 events. This may cause an error on the main thread.","TablatureGeneration"),[];const i=[o[0].map(u=>u.internalCost)],a=[new Array(o[0].length).fill(0)];for(let u=1;u<o.length;u++){const f=[],h=[];for(let m=0;m<o[u].length;m++){let b=1/0,T=-1;const A=o[u][m];for(let k=0;k<o[u-1].length;k++){const M=o[u-1][k],E=Ir(M.fingering,A.fingering),D=i[u-1][k]+E+A.internalCost;D<b&&(b=D,T=k)}f.push(b),h.push(T)}i.push(f),a.push(h)}const c=[];let s=-1,l=1/0;const d=i[i.length-1];for(let u=0;u<d.length;u++)d[u]<l&&(l=d[u],s=u);if(s===-1)return[];c.push(s);let g=s;for(let u=o.length-2;u>=0;u--){const f=a[u+1][g];c.unshift(f),g=f}return c.map((u,f)=>{const h=o[f][u].fingering;return h.sort((m,b)=>m.string-b.string),{notes:h,isChord:h.length>1}})}function $e(t){let n=1;return t.map(r=>{const o=r.notes.map(i=>{if(i.finger!==void 0&&i.finger!==null&&i.finger!==0)return i.fret>0&&(n=i.fret-i.finger+1),i;if(i.fret===0)return{...i,finger:0};Math.abs(i.fret-n)>4&&i.fret>0&&(n=i.fret<=4?1:i.fret-1);let a=i.fret-n+1;return a=Math.max(1,Math.min(4,a)),{...i,finger:a}});return{...r,notes:o}})}function Mr(){const t=e.isEditMode?e.editedTablature:e.originalTablature;if(!t||t.length===0)return[];const n=P(e.currentInstrument),r=JSON.parse(JSON.stringify(t));for(let o=0;o<r.length;o++){const a=r[o].notes.map((s,l)=>{const d=t[o].notes[l],g=d.pitch+e.transposeOffset;s.pitch=g;const u=d.string+e.stringShiftOffset,f=g-n.tuning[u];return u>=0&&u<n.numStrings&&f>=0&&f<=n.numFrets?{note:s,preferredString:u,isPlaced:!1}:{note:s,preferredString:-1,isPlaced:!1}}),c=new Set;a.forEach(s=>{s.preferredString!==-1&&!c.has(s.preferredString)&&(s.note.string=s.preferredString,s.note.fret=s.note.pitch-n.tuning[s.preferredString],c.add(s.preferredString),s.isPlaced=!0)}),a.forEach(s=>{if(!s.isPlaced){const l=Oe(s.note.pitch,e.currentInstrument),d=l.filter(g=>!c.has(g.string)).sort((g,u)=>g.fret-u.fret)[0];d?(s.note.string=d.string,s.note.fret=d.fret,c.add(d.string),s.isPlaced=!0):l.length>0?(s.note.string=l[0].string,s.note.fret=l[0].fret):s.note.fret=-1}})}return $e(r)}function U(t={}){if(e.currentSongData){if(t.recalculateFingering){y.info("Global fingering override triggered. Resetting all manual fingerings.","Practice"),e.originalTablature.forEach(r=>{r.notes.forEach(o=>{o.finger=0})});const n=e.songs.find(r=>r.id===e.currentSongData.id);n&&(n.tablature=JSON.stringify(e.originalTablature),localStorage.setItem(`fretflow_songs_${e.currentInstrument}`,JSON.stringify(e.songs)),y.info("Persisted fingering reset to song library.","Practice"))}e.currentSongData.tablature=Mr(),R(),ee(),e.ui.transposeValue.textContent=e.transposeOffset>0?`+${e.transposeOffset}`:String(e.transposeOffset),e.ui.stringShiftValue.textContent=e.stringShiftOffset>0?`+${e.stringShiftOffset}`:String(e.stringShiftOffset)}}async function J(){if(!(!e.currentSongData||!e.currentSongData.id||e.isEditMode))try{const t=e.songs.find(n=>n.id===e.currentSongData.id);if(t){const n={playbackTempo:parseInt(e.ui.tempoSlider.value),transpose:e.transposeOffset,stringShift:e.stringShiftOffset,zoomLevel:e.zoomLevel};Object.assign(t,n),localStorage.setItem(`fretflow_songs_${e.currentInstrument}`,JSON.stringify(e.songs)),y.info(`Saved settings for song: ${t.title}`,"Practice",n)}}catch(t){y.error(t,"SavePracticeSettings")}}function st(t){if(!e.originalTablature)return!1;const n=P(e.currentInstrument),r=e.isEditMode?e.editedTablature:e.originalTablature;for(const o of r)for(const i of o.notes){const a=i.string+t;if(a<0||a>=n.numStrings)return!1;const c=i.pitch-n.tuning[a];if(c<0||c>n.numFrets)return!1}return!0}function ct(t){if(!e.originalTablature)return!0;const n=P(e.currentInstrument),r=e.isEditMode?e.editedTablature:e.originalTablature;for(const o of r){let i=function(c,s){if(c===a.length)return!0;const l=a[c];for(const d of l.positions)if(!s.has(d.string)&&i(c+1,new Set(s).add(d.string)))return!0;return!1};const a=o.notes.map(c=>{const s=c.pitch+e.transposeOffset+t;return{pitch:s,positions:Oe(s,e.currentInstrument)}});if(a.some(c=>c.positions.length===0)||a.length>n.numStrings||!i(0,new Set))return!1}return!0}function ie(){e.currentSongData&&(e.ui.transposeUpBtn.disabled=!ct(1),e.ui.transposeDownBtn.disabled=!ct(-1),e.ui.stringShiftUpBtn.disabled=!st(e.stringShiftOffset-1),e.ui.stringShiftDownBtn.disabled=!st(e.stringShiftOffset+1))}function Be(t){if(!e.currentSongData)return{mode:null,time:0};const n=e.ui.minimapCanvas.getBoundingClientRect(),r=t.clientX-n.left,o=r/n.width*e.currentSongData.totalDuration;if(e.isEditMode||e.currentMode==="performance")return{mode:"seek",time:o};const{MINIMAP_HANDLE_W:i,MINIMAP_HIT_PAD:a}=nn,c=i/2,s=e.loopStartTime/e.currentSongData.totalDuration*n.width,l=e.loopEndTime/e.currentSongData.totalDuration*n.width,d=Math.abs(r-s)<c+a,g=Math.abs(r-l)<c+a;return d?{mode:"start",time:o}:g?{mode:"end",time:o}:{mode:"seek",time:o}}function lt(t){if(!e.currentSongData)return;const{time:n}=Be(t);e.dragMode==="start"?e.loopStartTime=Math.max(0,Math.min(n,e.loopEndTime-.1)):e.dragMode==="end"?e.loopEndTime=Math.min(e.currentSongData.totalDuration,Math.max(n,e.loopStartTime+.1)):e.dragMode==="seek"&&(e.songTime=Math.max(0,Math.min(n,e.currentSongData.totalDuration))),e.currentSongData.tablature.forEach(r=>{r.notes[0].startTime>=e.songTime&&(delete r.isScored,r.notes.forEach(o=>{delete o.isAudioTriggered,delete o.impactTime,delete o.feedback}))}),e.currentScrollX=e.songTime*e.currentSongData.pixelsPerSecond,e.currentNoteIndex=ue(e.songTime),Vt(),R(),ee()}async function Er(t){y.info(`Loading song to practice: ${t.title}`,"Practice",{id:t.id});let n=JSON.parse(t.tablature||"[]");n.length>0&&n[0].pitch!==void 0&&n[0].notes===void 0&&(y.info("Migrating old song data structure to new format.","SongLoad"),n=n.map(l=>({notes:[l],isChord:!1}))),e.originalTablature=n,e.transposeOffset=t.transpose||0,e.stringShiftOffset=t.stringShift||0,e.zoomLevel=t.zoomLevel||1;const r=t.playbackTempo||100,o=n.length>0?n[n.length-1]:{notes:[{startTime:0,duration:0}]},i=o.notes[0].startTime+o.notes[0].duration,a=n.flatMap(l=>l.notes).map(l=>l.duration).filter(l=>l>0),c=a.length>0?Math.min(...a):.1,s=Math.max(150,(72*e.globalSettings.noteSize+8)/c)*e.zoomLevel;e.ui.tempoSlider.value=String(r),e.ui.tempoValue.textContent=`${r}%`,e.ui.zoomSlider.value=String(e.zoomLevel),e.ui.zoomValue.textContent=`${Math.round(e.zoomLevel*100)}%`,e.currentSongData={...t,tablature:[],totalDuration:i,minDuration:c,pixelsPerSecond:s},e.loopStartTime=0,e.loopEndTime=i,e.currentMode="practice",U(),ie(),await Qt(),j(),Z()}function He(){e.ui.undoBtn.disabled=e.historyIndex<0,e.ui.redoBtn.disabled=e.historyIndex>=e.editHistory.length-1}function be(t){e.historyIndex<e.editHistory.length-1&&(e.editHistory=e.editHistory.slice(0,e.historyIndex+1)),e.editHistory.push(t),e.historyIndex++,He(),e.pendingEdits||(e.pendingEdits=!0,e.ui.saveBtn.disabled=!1,e.ui.doneEditingBtn.textContent="Done",v(e.ui.doneEditingBtn,{"bg-green-600":!0,"hover:bg-green-700":!0,"bg-gray-600":!1,"hover:bg-gray-700":!1})),y.info("Added edit to history","Editor",t)}function kr(){if(!e.selectedNoteIndex)return;const{eventIndex:t,noteIndex:n}=e.selectedNoteIndex,r=e.editedTablature[t];if(!r)return;const o=r.notes[n],i=r.notes.length===1;be({type:"delete",eventIndex:t,noteIndex:n,deletedNote:JSON.parse(JSON.stringify(o)),wasLastNoteInEvent:i}),r.notes.splice(n,1),i?e.editedTablature.splice(t,1):r.isChord=r.notes.length>1,y.info("Deleted note","Editor",{noteId:e.selectedNoteIndex}),Q(),U()}function Ht(){if(e.historyIndex<0)return;const t=e.editHistory[e.historyIndex];switch(y.info("Performing undo","Editor",t),t.type){case"delete":{const{eventIndex:n,noteIndex:r,deletedNote:o,wasLastNoteInEvent:i}=t;if(i){const a={notes:[o],isChord:!1};e.editedTablature.splice(n,0,a)}else{const a=e.editedTablature[n];a.notes.splice(r,0,o),a.isChord=a.notes.length>1}break}case"finger":{const n=e.editedTablature[t.noteId.eventIndex].notes[t.noteId.noteIndex];n.finger=t.oldValue;break}case"position":{const n=e.editedTablature[t.noteId.eventIndex].notes[t.noteId.noteIndex];n.string=t.oldValue.string,n.fret=t.oldValue.fret;break}case"pitch":{const n=e.editedTablature[t.noteId.eventIndex].notes[t.noteId.noteIndex];n.pitch=t.oldValue.pitch,n.fret=t.oldValue.fret;break}}e.historyIndex--,U(),He(),e.historyIndex<0&&e.pendingEdits&&(e.pendingEdits=!1,e.ui.saveBtn.disabled=!0,e.ui.doneEditingBtn.textContent="Exit",v(e.ui.doneEditingBtn,{"bg-green-600":!1,"hover:bg-green-700":!1,"bg-gray-600":!0,"hover:bg-gray-700":!0})),e.selectedNoteIndex&&t.type!=="delete"&&e.selectedNoteIndex.eventIndex===t.noteId.eventIndex&&e.selectedNoteIndex.noteIndex===t.noteId.noteIndex&&ce(e.selectedNoteIndex)}function Gt(){if(e.historyIndex>=e.editHistory.length-1)return;e.historyIndex++;const t=e.editHistory[e.historyIndex];switch(y.info("Performing redo","Editor",t),t.type){case"delete":{const{eventIndex:n,noteIndex:r,wasLastNoteInEvent:o}=t,i=e.editedTablature[n];i.notes.splice(r,1),o?e.editedTablature.splice(n,1):i.isChord=i.notes.length>1;break}case"finger":{const n=e.editedTablature[t.noteId.eventIndex].notes[t.noteId.noteIndex];n.finger=t.newValue;break}case"position":{const n=e.editedTablature[t.noteId.eventIndex].notes[t.noteId.noteIndex];n.string=t.newValue.string,n.fret=t.newValue.fret;break}case"pitch":{const n=e.editedTablature[t.noteId.eventIndex].notes[t.noteId.noteIndex];n.pitch=t.newValue.pitch,n.fret=t.newValue.fret;break}}U(),He(),e.pendingEdits||(e.pendingEdits=!0,e.ui.saveBtn.disabled=!1,e.ui.doneEditingBtn.textContent="Done",v(e.ui.doneEditingBtn,{"bg-green-600":!0,"hover:bg-green-700":!0,"bg-gray-600":!1,"hover:bg-gray-700":!1})),e.selectedNoteIndex&&t.type!=="delete"&&e.selectedNoteIndex.eventIndex===t.noteId.eventIndex&&e.selectedNoteIndex.noteIndex===t.noteId.noteIndex&&ce(e.selectedNoteIndex)}function ce(t){var u,f;if(!t||!e.currentSongData)return;const{eventIndex:n,noteIndex:r}=t,o=(u=e.editedTablature[n])==null?void 0:u.notes[r];if(!o)return;const i=(f=e.currentSongData.tablature[n])==null?void 0:f.notes[r];if(!i)return;y.info("Opening note editor","Editor",{noteId:t}),e.selectedNoteIndex=t,e.ui.editorFretValue.textContent=String(o.fret),_t(".finger-btn",e.ui.editorFingerButtons).forEach(h=>{const m=parseInt(h.dataset.finger),b=m===o.finger;v(h,{active:b}),h.style.backgroundColor=xe[m],h.style.color="white"});const{neckTopY:a,neckHeight:c}=V(),s=c/P(e.currentInstrument).numStrings,l=le()+i.startTime*e.currentSongData.pixelsPerSecond-e.currentScrollX,d=a+i.string*s+s/2,g=e.ui.noteEditorPopup;g.style.left=`${l+35}px`,g.style.top=`${d-g.offsetHeight/2}px`,v(g,{hidden:!1}),setTimeout(()=>{v(g,{"opacity-0":!1,"pointer-events-none":!1})},10),R()}function Q(){e.selectedNoteIndex&&(y.info("Closing note editor","Editor"),e.selectedNoteIndex=null,v(e.ui.noteEditorPopup,{"opacity-0":!0,"pointer-events-none":!0}),setTimeout(()=>v(e.ui.noteEditorPopup,{hidden:!0}),150),R())}function Ie(t,n){var g;if(!((g=e.currentSongData)!=null&&g.tablature))return null;const r=e.ui.dynamicCanvas.getBoundingClientRect(),o=t-r.left,i=n-r.top,a=P(e.currentInstrument),{neckTopY:c,neckHeight:s}=V(),l=s/a.numStrings,d=e.currentSongData.tablature;for(let u=d.length-1;u>=0;u--){const f=d[u];for(let h=0;h<f.notes.length;h++){const m=f.notes[h],b=le()+m.startTime*e.currentSongData.pixelsPerSecond-e.currentScrollX,T=c+m.string*l+l/2,A=72*e.globalSettings.noteSize,k=A,M=(m.duration-e.currentSongData.minDuration)*e.currentSongData.pixelsPerSecond,E=k+Math.max(0,M);if(o>=b&&o<=b+E&&i>=T-A/2&&i<=T+A/2)return{eventIndex:u,noteIndex:h}}}return null}function ut(t,n){t.push(n>>24&255),t.push(n>>16&255),t.push(n>>8&255),t.push(n&255)}function Me(t,n){t.push(n>>8&255),t.push(n&255)}function dt(t,n){let r=n&127;for(;(n>>=7)>0;)r<<=8,r|=n&127|128;for(;t.push(r&255),r&128;)r>>=8}function Dr(t){const n=JSON.parse(t.tablature),r=480,o=t.midiTempo||5e5,i=t.midiTimeSignature?JSON.parse(t.midiTimeSignature):{numerator:4,denominator:4},a=o/1e6/r,c=[];c.push({tick:0,event:[255,88,4,i.numerator,Math.log2(i.denominator),24,8]});const s=[];s.push(o>>16&255),s.push(o>>8&255),s.push(o&255),c.push({tick:0,event:[255,81,3,...s]});const l=`FretFlow: ${t.title}`,d=Array.from(l).map(h=>h.charCodeAt(0));c.push({tick:0,event:[255,3,d.length,...d]}),n.forEach(h=>{h.notes.forEach(m=>{const b=Math.round(m.startTime/a),T=Math.round((m.startTime+m.duration)/a);c.push({tick:b,event:[144,m.pitch,100]}),c.push({tick:T,event:[128,m.pitch,0]})})}),c.sort((h,m)=>h.tick-m.tick);const g=[];let u=0;c.forEach(h=>{const m=h.tick-u;dt(g,m),g.push(...h.event),u=h.tick}),dt(g,0),g.push(255,47,0);const f=[];return f.push(..."MThd".split("").map(h=>h.charCodeAt(0))),ut(f,6),Me(f,1),Me(f,1),Me(f,r),f.push(..."MTrk".split("").map(h=>h.charCodeAt(0))),ut(f,g.length),f.push(...g),y.info(`Generated MIDI file for song: ${t.title}`,"MidiGenerator",{bytes:f.length}),new Uint8Array(f)}function Nr(t){const n=e.songs.find(r=>r.id===t);n&&(y.info(`Deleting song: ${n.title}`,"Library",{songId:t}),e.songs=e.songs.filter(r=>r.id!==t),localStorage.setItem(`fretflow_songs_${e.currentInstrument}`,JSON.stringify(e.songs)),O())}function Br(t){const n=e.songs.find(r=>r.id===t);n&&(n.isFavorite=!n.isFavorite,y.info(`Toggled favorite for song: ${n.title}`,"Library",{isFavorite:n.isFavorite}),localStorage.setItem(`fretflow_songs_${e.currentInstrument}`,JSON.stringify(e.songs)),O())}function Fr(t){const n=e.songs.find(a=>a.id===t);if(!n){alert("Could not find song to export."),y.warn(`Could not find song to export with id: ${t}`,"LibraryUI");return}y.info(`Exporting song: ${n.title}`,"LibraryUI",{songId:t});const r="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(n,null,2)),o=document.createElement("a"),i=n.title.replace(/[^a-z0-9]/gi,"_").toLowerCase();o.setAttribute("href",r),o.setAttribute("download",`fretflow_song_${i}.json`),document.body.appendChild(o),o.click(),o.remove()}function _r(t){const n=e.songs.find(r=>r.id===t);if(!n){alert("Could not find song to export as MIDI."),y.warn(`Could not find song to export MIDI with id: ${t}`,"LibraryUI");return}try{y.info(`Exporting MIDI for song: ${n.title}`,"LibraryUI",{songId:t});const r=Dr(n),o=new Blob([r],{type:"audio/midi"}),i=URL.createObjectURL(o),a=document.createElement("a"),c=n.title.replace(/[^a-z0-9]/gi,"_").toLowerCase();a.setAttribute("href",i),a.setAttribute("download",`fretflow_${c}.mid`),document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(i)}catch(r){y.error(r,"handleExportMidi"),alert(`Failed to generate MIDI file: ${r.message}`)}}function Pr(t){const n=t.target,r=n.closest(".favorite-btn");if(r){const s=r.getAttribute("data-song-id");s&&Br(s);return}const o=n.closest(".export-song-btn");if(o){const s=o.getAttribute("data-song-id");s&&Fr(s);return}const i=n.closest(".export-midi-btn");if(i){const s=i.getAttribute("data-song-id");s&&_r(s);return}const a=n.closest(".delete-song-btn");if(a&&a.matches(".delete-song-btn")){const s=a.getAttribute("data-song-id");s&&Nr(s);return}const c=n.closest(".song-item");if(c instanceof HTMLElement&&c.dataset.songId){const s=e.songs.find(l=>l.id===c.dataset.songId);s&&Er(s)}}function Ur(t,n){const r=document.createElement("div");return r.id=t,r.className="song-item-placeholder bg-gray-800/70 p-4 rounded-lg flex justify-between items-center ring-1 ring-blue-500/50",r.innerHTML=`
        <div class="flex-grow">
            <h3 class="text-lg font-bold text-white truncate">${n}</h3>
            <p class="text-sm text-blue-400">Processing...</p>
        </div>
        <div class="spinner"></div>
    `,r}function gt(t){const n=document.createElement("div");n.className="song-item bg-gray-800/70 backdrop-blur-sm p-4 rounded-lg flex items-center gap-4 hover:bg-gray-700/80 transition-all duration-200 ring-1 ring-white/5 shadow-lg",n.dataset.songId=t.id;const r=!!t.isFavorite;let o=`High Score: ${t.highScore||0}`;return t.accuracy!==void 0&&(o+=` &middot; Accuracy: ${t.accuracy}%`),n.innerHTML=`
        <div class="flex-grow cursor-pointer">
            <h3 class="text-xl font-bold text-white truncate" title="${t.title}">${t.title}</h3>
            <p class="text-sm text-gray-400">${o}</p>
        </div>
        <div class="flex-shrink-0 flex items-center gap-1">
             <button class="favorite-btn p-2 rounded-full ${r?"favorited":""}" title="${r?"Remove from favorites":"Add to favorites"}" data-song-id="${t.id}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor" style="pointer-events: none;"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
             </button>
             <button class="export-midi-btn p-2 rounded-full text-gray-500 hover:bg-purple-900/50 hover:text-purple-400 transition-colors" title="Export MIDI" data-song-id="${t.id}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" style="pointer-events: none;">
                    <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3V7.82l8-1.6v5.894A4.369 4.369 0 0015 12c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3V3z" />
                </svg>
             </button>
             <button class="export-song-btn p-2 rounded-full text-gray-500 hover:bg-blue-900/50 hover:text-blue-400 transition-colors" title="Export song (JSON)" data-song-id="${t.id}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" style="pointer-events: none;">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
             </button>
             <button class="delete-song-btn p-2 rounded-full text-gray-500 hover:bg-red-900/50 hover:text-red-400 transition-colors" title="Delete song" data-song-id="${t.id}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" style="pointer-events: none;"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
            </button>
        </div>
    `,n}function ft(t,n){const r=document.createDocumentFragment();if(t){const i=document.createElement("h2");i.className="text-2xl font-bold text-gray-300",r.appendChild(i),i.textContent=t}const o=document.createElement("div");return o.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",n.forEach(i=>o.appendChild(i)),r.appendChild(o),r}function O(t,n){const r=e.ui.songList,o=e.ui.librarySearchInput,i=o?o.value.toLowerCase().trim():"";r.innerHTML="";const a=i?e.songs.filter(u=>u.title.toLowerCase().includes(i)):e.songs,c=t&&n?Ur(t,n):null;if(a.length===0&&!c){r.className="flex-grow overflow-y-auto px-4 sm:px-8 flex items-center justify-center";const u=`
            <div class="empty-state-container h-full flex flex-col items-center justify-center text-center">
              <svg class="w-16 h-16 mb-4 opacity-30 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
              <h3 class="text-2xl font-semibold text-white mb-2">No Songs Found</h3>
              <p class="text-gray-400 mb-6">Your search for "${i}" did not match any songs.</p>
            </div>
        `,f=`
            <div class="empty-state-container h-full flex flex-col items-center justify-center text-center">
              <svg class="w-16 h-16 mb-4 opacity-30 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 01-.99-3.467l2.31-.66A2.25 2.25 0 009 15.553z" /></svg>
              <h3 class="text-2xl font-semibold text-white mb-2">Your Library is Empty</h3>
              <p class="text-gray-400 mb-6">Click the button below to add your first MIDI file.</p>
              <label for="midi-file-input" class="add-song-btn-large">
                  <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                  Add Songs
              </label>
            </div>
        `;r.innerHTML=i?u:f;return}r.className="flex-grow overflow-y-auto px-4 sm:px-8 pb-8 space-y-8";const s=document.createDocumentFragment(),l=a.filter(u=>u.isFavorite).sort((u,f)=>new Date(f.createdAt).getTime()-new Date(u.createdAt).getTime()),d=a.filter(u=>!u.isFavorite).sort((u,f)=>new Date(f.createdAt).getTime()-new Date(u.createdAt).getTime());l.length>0&&s.appendChild(ft("Favorites",l.map(gt)));const g=d.map(gt);if(c&&g.unshift(c),g.length>0){const u=l.length>0?"All Songs":"";s.appendChild(ft(u,g))}r.appendChild(s)}function Lr(){e.ui={loadingScreen:p("#loading-screen"),library:p("#song-library-screen"),practice:p("#practice-screen"),tuner:p("#tuner-screen"),summary:p("#summary-screen"),songList:p("#song-list"),addBtn:p("#add-song-btn"),libraryTunerBtn:p("#library-tuner-btn"),practiceTunerBtn:p("#practice-tuner-btn"),fullscreenBtn:p("#fullscreen-btn"),exportLibraryBtn:p("#export-library-btn"),importLibraryInput:p("#import-library-input"),importSongInput:p("#import-song-input"),midiFileInput:p("#midi-file-input"),practiceBackBtn:p("#practice-back-btn"),tunerBackBtn:p("#tuner-back-btn"),settingsBtn:p("#settings-btn"),settingsMenu:p("#settings-menu"),settingsMenuContent:p("#settings-menu-content"),settingsBackdrop:p("#settings-backdrop"),tempoSlider:p("#tempo-slider"),tempoValue:p("#tempo-value"),tempoDownBtn:p("#tempo-down-btn"),tempoUpBtn:p("#tempo-up-btn"),noteSizeSlider:p("#note-size-slider"),noteSizeValue:p("#note-size-value"),stringSpacingSlider:p("#string-spacing-slider"),stringSpacingValue:p("#string-spacing-value"),stringThicknessSlider:p("#string-thickness-slider"),stringThicknessValue:p("#string-thickness-value"),zoomSlider:p("#zoom-slider"),zoomValue:p("#zoom-value"),tabDisplay:p("#tab-display"),staticCanvas:p("#static-canvas"),dynamicCanvas:p("#practice-canvas"),playPauseBtn:p("#play-pause-btn"),rewindBtn:p("#rewind-btn"),editModeBtn:p("#edit-mode-btn"),editModeActions:p("#edit-mode-actions"),saveBtn:p("#save-btn"),doneEditingBtn:p("#done-editing-btn"),undoBtn:p("#undo-btn"),redoBtn:p("#redo-btn"),playIcon:p("#play-icon"),pauseIcon:p("#pause-icon"),pitchDisplay:p("#pitch-display"),feedbackDisplay:p("#feedback-display"),targetNoteDisplay:p("#target-note-display"),practiceMicMsg:p("#practice-mic-msg"),tunerMicMsg:p("#tuner-mic-msg"),tunerNoteName:p("#tuner-note-name"),tunerNeedle:p("#tuner-needle"),tunerStatus:p("#tuner-status"),tunerFreq:p("#tuner-freq"),tunerCircle:p("#tuner-circle"),scoreDisplay:p("#current-score-display"),streakDisplay:p("#streak-display"),summaryScore:p("#summary-score"),summaryAccuracy:p("#summary-accuracy"),summaryBackBtn:p("#summary-back-btn"),transposeDownBtn:p("#transpose-down-btn"),transposeUpBtn:p("#transpose-up-btn"),transposeValue:p("#transpose-value"),stringShiftDownBtn:p("#string-shift-down-btn"),stringShiftUpBtn:p("#string-shift-up-btn"),stringShiftValue:p("#string-shift-value"),minimapCanvas:p("#minimap-canvas"),libraryTitle:p("#library-title"),instrumentNameDisplay:p("#instrument-name-display"),selectGuitarBtn:p("#select-guitar-btn"),selectUkuleleBtn:p("#select-ukulele-btn"),librarySearchInput:p("#library-search-input"),moreActionsBtn:p("#more-actions-btn"),moreActionsMenu:p("#more-actions-menu"),editButtonsContainer:p("#edit-buttons-container"),noteEditorPopup:p("#note-editor-popup"),editorCloseBtn:p("#editor-close-btn"),editorFretDown:p("#editor-fret-down"),editorFretUp:p("#editor-fret-up"),editorFretValue:p("#editor-fret-value"),editorFingerButtons:p("#editor-finger-buttons"),editorDeleteBtn:p("#editor-delete-btn"),logViewerBtn:p("#log-viewer-btn"),logViewer:p("#log-viewer"),logViewerBackdrop:p("#log-viewer-backdrop"),logViewerContent:p("#log-viewer-content"),clearLogsBtn:p("#clear-logs-btn"),closeLogsBtn:p("#close-logs-btn"),instrumentSelector:p("#instrument-selector"),confirmDialogBackdrop:p("#confirm-dialog-backdrop"),confirmDialog:p("#confirm-dialog"),confirmDialogTitle:p("#confirm-dialog-title"),confirmDialogMessage:p("#confirm-dialog-message"),confirmDialogButtons:p("#confirm-dialog-buttons"),practiceModeLabel:p("#practice-mode-label"),performanceModeLabel:p("#performance-mode-label"),editModeLabel:p("#edit-mode-label"),practiceInfoContainer:p("#practice-info-container"),modeSwitcher:p("#mode-switcher"),selectPracticeBtn:p("#select-practice-btn"),selectPerformanceBtn:p("#select-performance-btn")}}const de=t=>{[e.ui.loadingScreen,e.ui.library,e.ui.practice,e.ui.summary,e.ui.tuner].forEach(n=>{n&&v(n,{hidden:!n.isEqualNode(t)})}),y.info(`Showing screen: ${t.id}`,"UI")};function Te(){const t=e.currentMode==="practice",n=e.currentMode==="performance",r=e.isEditMode,o=n||r;v(e.ui.practiceModeLabel,{hidden:!t||r,flex:t&&!r}),v(e.ui.performanceModeLabel,{hidden:!n||r,flex:n&&!r}),v(e.ui.editModeLabel,{hidden:!r,flex:r}),v(e.ui.practiceInfoContainer,{hidden:r}),v(e.ui.editButtonsContainer,{hidden:!r}),v(e.ui.modeSwitcher,{hidden:r,flex:!r}),v(e.ui.selectPracticeBtn,{active:t}),v(e.ui.selectPerformanceBtn,{active:n}),_t(".local-setting-control").forEach(i=>{i.disabled=o}),e.ui.settingsBtn.disabled=o,e.ui.practiceTunerBtn.disabled=r}const K=()=>{j(),Lt(),Q(),O(),de(e.ui.library)},Qt=async()=>{await Ut(!0),e.isTunerActive=!1,de(e.ui.practice),Te(),Pe()},qt=async()=>{await Ut(!0),e.isTunerActive=!0,Q(),de(e.ui.tuner)},Rr=()=>{j(),Lt(),Q(),de(e.ui.summary)};function Vr(){v(e.ui.logViewer,{hidden:!1}),v(e.ui.logViewerBackdrop,{hidden:!1}),setTimeout(()=>{v(e.ui.logViewer,{open:!0}),v(e.ui.logViewerBackdrop,{open:!0})},10)}function mt(){v(e.ui.logViewer,{open:!1}),v(e.ui.logViewerBackdrop,{open:!1}),setTimeout(()=>{v(e.ui.logViewer,{hidden:!0}),v(e.ui.logViewerBackdrop,{hidden:!0})},300)}function Or(){localStorage.setItem("fretflow_instrument",e.currentInstrument)}function $r(){const t=localStorage.getItem("fretflow_instrument");t&&["guitar","ukulele"].includes(t)&&(e.currentInstrument=t);const n=localStorage.getItem("fretflow_global_settings");if(n){const r=JSON.parse(n);e.globalSettings={...e.globalSettings,...r}}y.info("Loaded global settings","Settings",{instrument:e.currentInstrument,settings:e.globalSettings}),e.ui.noteSizeSlider.value=String(e.globalSettings.noteSize),e.ui.noteSizeValue.textContent=`${Math.round(e.globalSettings.noteSize*100)}%`,e.ui.stringSpacingSlider.value=String(e.globalSettings.stringSpacing),e.ui.stringSpacingValue.textContent=`${Math.round(e.globalSettings.stringSpacing*100)}%`,e.ui.stringThicknessSlider.value=String(e.globalSettings.stringThickness),e.ui.stringThicknessValue.textContent=`${Math.round(e.globalSettings.stringThickness*100)}%`,e.ui.instrumentSelector.value=String(e.globalSettings.selectedInstrument)}function pe(){y.info("Saving global settings","Settings",e.globalSettings),localStorage.setItem("fretflow_global_settings",JSON.stringify(e.globalSettings))}function pt(t,n,r){e.ui.confirmDialogTitle.textContent=t,e.ui.confirmDialogMessage.textContent=n;const o=r.map(i=>{const a=document.createElement("button");return a.textContent=i.text,a.className=i.classes,x(a,"click",()=>{Hr(),i.onClick()}),a});e.ui.confirmDialogButtons.replaceChildren(...o),v(e.ui.confirmDialogBackdrop,{hidden:!1}),setTimeout(()=>{v(e.ui.confirmDialogBackdrop,{open:!0}),v(e.ui.confirmDialog,{open:!0})},10)}function Hr(){v(e.ui.confirmDialogBackdrop,{open:!1}),v(e.ui.confirmDialog,{open:!1}),setTimeout(()=>{v(e.ui.confirmDialogBackdrop,{hidden:!0})},200)}const Gr={log(t,n,r="General",o){const i=`[MidiParser:${r}] ${n}`;o?console[t](i,o):console[t](i)},warn(t,n,r){this.log("warn",t,n,r)}};class Qr{constructor(n,r){q(this,"data");q(this,"length");q(this,"pos");this.data=new DataView(n.buffer,n.byteOffset),this.length=this.data.byteLength,this.pos=r||0}getc(){return this.data.getUint8(this.pos++)}peek(){return this.data.getUint8(this.pos)}read(n){var r=new Uint8Array(this.data.buffer,this.data.byteOffset+this.pos,n);return this.pos+=n,r}readInt16(){var n=this.data.getUint16(this.pos,!1);return this.pos+=2,n}readInt32(){var n=this.data.getUint32(this.pos,!1);return this.pos+=4,n}readVarInt(){var n=0,r;do r=this.getc(),n=n<<7|r&127;while(r&128);return n}readString(n){for(var r="",o=0;o<n;++o)r+=String.fromCharCode(this.getc());return r}}function qr(t){var n=t.readString(4);if(n!=="MThd")throw new Error("Invalid MThd signature");t.readInt32();var r=t.readInt16(),o=t.readInt16(),i=t.readInt16();if(i&32768)throw new Error("Time division is not in ticks per quarter note.");return{formatType:r,trackCount:o,timeDivision:i}}function zr(t){var n=t.readString(4);if(n!=="MTrk")throw new Error("Invalid MTrk signature");for(var r=t.readInt32(),o=t.pos+r,i=null,a=[];t.pos<o;){const c=t.readVarInt();let s=t.peek(),l={deltaTime:c};if(s&128)i=s,t.pos++;else{if(i===null)throw new Error("Running status byte is null. Invalid MIDI.");s=i}const d=s>>4,g=s&15;if(d>=8&&d<=14)switch(l.type="channel",l.subtype=d,l.channel=g,d){case 8:case 9:case 10:case 11:case 14:l.param1=t.getc(),l.param2=t.getc();break;case 12:case 13:l.param1=t.getc(),l.param2=0;break}else if(s===255){l.type="meta";const u=l;u.subtype=t.getc();const f=t.readVarInt();switch(u.subtype){case 81:u.data=(t.getc()<<16)+(t.getc()<<8)+t.getc();break;case 88:u.data=t.read(f);break;default:t.pos+=f}}else if(s===240||s===247){const u=t.readVarInt();t.pos+=u,l.type="sysEx"}else{l.type="system",l.subtype=s;let u=0;switch(s){case 241:case 243:u=1;break;case 242:u=2;break}u>0&&t.read(u)}l.type&&a.push(l)}return a}function Jr(t){const n=new Qr(t),r=qr(n),o=[];for(var i=0;i<r.trackCount;++i)try{o.push(zr(n))}catch(a){Gr.warn(`Failed to parse track ${i+1}. Skipping. Reason: ${a.message}`,"Parse")}return{...r,tracks:o}}const ht={C:0,D:2,E:4,F:5,G:7,A:9,B:11};function jr(t){var i,a,c;const n=(i=t.querySelector("step"))==null?void 0:i.textContent,r=(a=t.querySelector("octave"))==null?void 0:a.textContent,o=parseInt(((c=t.querySelector("alter"))==null?void 0:c.textContent)||"0");return!n||!r||!ht.hasOwnProperty(n)?60:12*(parseInt(r)+1)+ht[n]+o}function Wr(t,n){var h,m,b,T,A;const r=t.querySelector("parsererror");if(r)throw new Error(`XML Parsing Error: ${(h=r.textContent)==null?void 0:h.trim()}`);const o=((b=(m=t.querySelector("work-title"))==null?void 0:m.textContent)==null?void 0:b.trim())||n.replace(/\.xml$/i,""),i=t.querySelectorAll("part-list > score-part"),a=new Map;i.forEach(k=>{var D;const M=k.getAttribute("id"),E=((D=k.querySelector("part-name"))==null?void 0:D.textContent)||"Unknown Part";M&&a.set(M,E)});const c=[],s=t.querySelectorAll("part"),l=t.querySelector("part > measure > attributes"),d=t.querySelector("sound[tempo]")||(l==null?void 0:l.querySelector("direction sound[tempo]")),g=d?parseFloat(d.getAttribute("tempo")):120,u=l==null?void 0:l.querySelector("time"),f={numerator:parseInt(((T=u==null?void 0:u.querySelector("beats"))==null?void 0:T.textContent)||"4",10),denominator:parseInt(((A=u==null?void 0:u.querySelector("beat-type"))==null?void 0:A.textContent)||"4",10)};if(s.forEach(k=>{const M=k.getAttribute("id"),E=[];let D=0,L=1,C=g;k.querySelectorAll("measure").forEach(I=>{var G,te,Ge,Qe,qe,ze,Je,je,We;let w=0;const N=I.querySelector("attributes");if(N){const ne=(G=N.querySelector("divisions"))==null?void 0:G.textContent;ne&&(L=parseInt(ne,10))}const B=I.querySelector("direction sound[tempo]");B&&(C=parseFloat(B.getAttribute("tempo")));const F=60/C/L;for(const ne of I.childNodes){const Ae=ne.nodeName.toLowerCase(),_=ne;if(Ae==="note"){if(_.querySelector("rest")){_.querySelector("chord")||(w+=parseInt(((te=_.querySelector("duration"))==null?void 0:te.textContent)||"0",10)*F);continue}const Ye=_.querySelector("pitch");if(Ye){let Ce=parseInt(((Ge=_.querySelector("duration"))==null?void 0:Ge.textContent)||"0",10),Xe=Ce*F;_.querySelectorAll("dot").forEach(()=>{Ce/=2,Xe+=Ce*F});const Wt={pitch:jr(Ye),startTime:D+(_.querySelector("chord")?w-parseInt(((Qe=_.querySelector("duration"))==null?void 0:Qe.textContent)||"0",10)*F:w),duration:Xe,staff:parseInt(((qe=_.querySelector("staff"))==null?void 0:qe.textContent)||"1",10),voice:((ze=_.querySelector("voice"))==null?void 0:ze.textContent)||"1",isTieStart:!!(_.querySelector('tie[type="start"]')||_.querySelector('notations > tied[type="start"]')),isTieStop:!!(_.querySelector('tie[type="stop"]')||_.querySelector('notations > tied[type="stop"]'))};E.push(Wt)}_.querySelector("chord")||(w+=parseInt(((Je=_.querySelector("duration"))==null?void 0:Je.textContent)||"0",10)*F)}else Ae==="backup"?w-=parseInt(((je=_.querySelector("duration"))==null?void 0:je.textContent)||"0",10)*F:Ae==="forward"&&(w+=parseInt(((We=_.querySelector("duration"))==null?void 0:We.textContent)||"0",10)*F)}D+=w}),E.length>0&&c.push({id:M,name:a.get(M)||"Unknown Part",notes:E})}),c.length===0)throw new Error("MusicXML file contains no parsable instrument parts with notes.");return{title:o,parts:c,initialTempo:6e7/g,initialTimeSignature:f}}function Yr(t,n){const{title:r,parts:o,initialTempo:i,initialTimeSignature:a}=t;y.info(`Processing pre-parsed XML data for: ${r}`,"XmlProcessing");const c=o.find(m=>/guitar|ukulele/i.test(m.name))||o[0];if(!c)throw new Error("Could not find any instrument parts in the MusicXML file.");y.info(`Selected part "${c.name}" for tablature generation.`,"XmlProcessing");const s=[],l={};c.notes.sort((m,b)=>m.startTime-b.startTime);for(let m=0;m<c.notes.length;){const b=c.notes[m],T=[b];let A=m+1;for(;A<c.notes.length&&Math.abs(c.notes[A].startTime-b.startTime)<.001;)T.push(c.notes[A++]);const k=[];T.forEach(M=>{const E=`${M.staff}-${M.voice}`,D=l[E];if(M.isTieStop&&D)D.duration+=M.duration;else{const L={pitch:M.pitch,startTime:M.startTime,duration:M.duration};k.push(L),M.isTieStart&&(l[E]=L)}M.isTieStop&&!M.isTieStart&&delete l[E]}),k.length>0&&s.push({notes:k.sort((M,E)=>M.pitch-E.pitch),isChord:k.length>1}),m=A}if(s.length===0)throw new Error(`The selected part "${c.name}" contains no playable notes.`);const d=i/1e6,g=a.numerator||4,u=d*g;u>0&&(y.info(`Adding ${u.toFixed(2)}s pre-roll measure.`,"XmlProcessing"),s.forEach(m=>{m.notes.forEach(b=>{b.startTime+=u})}));const f=$t(s,n),h=$e(f);if(h.length===0)throw new Error("Could not generate playable tablature from the MusicXML file. Notes may be outside the instrument range.");return{title:r,tablature:h,midiTempo:i,midiTimeSignature:a}}const Xr="TVRoZAAAAAYAAQABAeBNVHJrAAAEFQD/AwdVa3VsZWxlAP9YBAkDGAgA/1kCAAAA/1EDB6EgALB5AABkAABlAAAGDABkfwBlfwDAGACwB2QACkAAWwAAXQAA/yEBAACQR1CFT0cAAUdQhU9HAAFHUIVPRwABR1CFT0cAAUVQhU9FAAFDUIVPQwABQ1CFT0MAAUJQhU9CAAFAUIVPQAABQFCFT0AAAUNQhU9DAAFHUIVPRwABTFCFT0wAAUxQhU9MAAFMUIVPTAABTFCFT0wAAUpQhU9KAAFIUIVPSAABSFCFT0gAAUdQhU9HAAFFUIVPRQABRVCFT0UAAUdQhU9HAAFIUIVPSAABR1CFT0cAAUhQhU9IAAFHUIVPRwABS1CFT0sAAUhQhU9IAAFHUIVPRwABR1CFT0cAAUVQhU9FAAFDUIVPQwABQ1CFT0MAAUJQhU9CAAFAUIVPQAABQlCFT0IAAUJQhU9CAAFCUIVPQgABQlCFT0IAAUNQhU9DAAFCUIVPQgABQFCFT0AAAUBQhU9AAAFAUIVPQAABQFCFT0AAiyFEUIVPRAABRFCFT0QAAURQhU9EAAFEUIVPRAABQlCFT0IAAUBQhU9AAAFAUIVPQAABP1CFTz8AAT9QhU8/AAE/UIVPPwABPlCFTz4AAT9QhU8/AAFJUIVPSQABSVCFT0kAAUlQhU9JAAFJUIVPSQABS1CFT0sAAUlQhU9JAAFJUIVPSQABR1CFT0cAAUdQhU9HAAFHUIVPRwABSVCFT0kAAUtQhU9LAAFMUIVPTAABTFCFT0wAAUxQhU9MAAFMUIVPTAABS1CFT0sAAUpQhU9KAAFJUIVPSQABSVCFT0kAAUlQhU9JAAFJUIVPSQABR1CFT0cAAUVQhU9FAAFEUIVPRAABRFCFT0QAAURQhU9EAAFEUIVPRAABRVCFT0UAAUJQhU9CAAFAUIVPQAABQFCFT0AAAUBQhU9AAAFAUIVPQACLIUdQhU9HAAFHUIVPRwABR1CFT0cAAUdQhU9HAAFFUIVPRQABQ1CFT0MAAUNQhU9DAAFCUIVPQgABQFCFT0AAAUBQhU9AAAFDUIVPQwABR1CFT0cAAUxQhU9MAAFMUIVPTAABTFCFT0wAAUxQhU9MAAFKUIVPSgABSFCFT0gAAUhQhU9IAAFHUIVPRwABRVCFT0UAAUVQhU9FAAFHUIVPRwABSFCFT0gAAUdQhU9HAAFIUIVPSAABR1CFT0cAAUtQhU9LAAFIUIVPSAABR1CFT0cAAUdQhU9HAAFFUIVPRQABQ1CFT0MAAUNQhU9DAAFCUIVPQgABQFCFT0AAAUJQhU9CAAFCUIVPQgABQlCFT0IAAUJQhU9CAAFDUIVPQwABQlCFT0IAAUBQhU9AAAFAUIVPQAABQFCFT0AAAUBQhU9AAAH/LwA=";async function zt(t,n,r=!1){try{const o=await t,i={id:"song_"+Date.now()+Math.random(),title:o.title,highScore:0,isFavorite:!1,tablature:JSON.stringify(o.tablature),midiTempo:o.midiTempo,midiTimeSignature:JSON.stringify(o.midiTimeSignature),createdAt:new Date().toISOString(),playbackTempo:100,transpose:0,zoomLevel:1,stringShift:0};y.info(`Successfully processed and adding song: ${i.title}`,"Library"),e.songs.unshift(i),localStorage.setItem(`fretflow_songs_${e.currentInstrument}`,JSON.stringify(e.songs))}catch(o){const i=`Error adding song: ${o.message}`;r||alert(i),y.error(o,"Song Addition")}finally{const o=document.getElementById(n);o&&o.remove(),O()}}function Jt(t,n,r,o){return new Promise((i,a)=>{try{const c=n.replace(/\.(mid|midi)$/i,""),s=Jr(new Uint8Array(t)),l=s.timeDivision;let d=[];s.tracks.forEach(S=>{let I=0;S.forEach(w=>{I+=w.deltaTime,w.absoluteTicks=I,d.push(w)})}),d.sort((S,I)=>S.absoluteTicks-I.absoluteTicks);const g=[],u={};let f=0,h=0,m=5e5;const b=(S,I)=>S*(I/1e6)/l;d.forEach(S=>{const I=S.absoluteTicks-h;if(f+=b(I,m),h=S.absoluteTicks,S.type==="meta"&&S.subtype===81)m=S.data;else if(S.type==="channel"){const w=S.param1;if(S.subtype===9&&S.param2>0)u[w]||(u[w]=[]),u[w].push({pitch:w,startTimeInSeconds:f,absoluteTicks:S.absoluteTicks});else if((S.subtype===8||S.subtype===9&&S.param2===0)&&u[w]&&u[w].length>0){const N=u[w].pop(),B=f-N.startTimeInSeconds;B>.001&&g.push({pitch:N.pitch,startTime:N.startTimeInSeconds,duration:B,absoluteTicks:N.absoluteTicks})}}});let T=5e5,A={numerator:4,denominator:4};d.find(S=>S.type==="meta"&&S.subtype===81?(T=S.data,!0):!1),d.find(S=>S.type==="meta"&&S.subtype===88&&S.data?(A={numerator:S.data[0],denominator:Math.pow(2,S.data[1])},!0):!1);const k=T/1e6,M=A.numerator||4,E=k*M;if(E>0&&(y.info(`Adding ${E.toFixed(2)}s pre-roll measure.`,"MidiProcessing"),g.forEach(S=>{S.startTime+=E})),o&&g.length>0){const S=P(r),I=Math.min(...S.tuning),w=Math.max(...S.tuning)+S.numFrets;let N=0,B=0;for(let F=-24;F<=24;F++){const G=g.filter(te=>te.pitch+F>=I&&te.pitch+F<=w).length;(G>B||G===B&&Math.abs(F)<Math.abs(N))&&(B=G,N=F)}N!==0&&g.forEach(F=>{F.pitch+=N})}g.sort((S,I)=>S.absoluteTicks-I.absoluteTicks);const D=[];for(let S=0;S<g.length;){const I=[g[S]];let w=S+1;for(;w<g.length&&g[w].absoluteTicks===g[S].absoluteTicks;)I.push(g[w++]);D.push({notes:I.map(N=>({pitch:N.pitch,startTime:N.startTime,duration:N.duration})).sort((N,B)=>N.pitch-B.pitch),isChord:I.length>1}),S=w}const L=$t(D,r),C=$e(L);if(C.length===0)throw new Error("No playable notes found. The MIDI might be empty, corrupted, or out of the instrument range.");i({title:c,tablature:C,midiTempo:T,midiTimeSignature:A})}catch(c){a(c)}})}function Kr(t,n,r){return new Promise((o,i)=>{try{const a=new DOMParser().parseFromString(t,"application/xml"),c=Wr(a,n),s=Yr(c,r);o(s)}catch(a){i(a)}})}function Zr(t){const n=window.atob(t),r=n.length,o=new Uint8Array(r);for(let i=0;i<r;i++)o[i]=n.charCodeAt(i);return o.buffer}function ei(){y.info("Adding demo song to library.","Library");const t="demo-song-placeholder";O(t,"Romanza (Demo)");const n=Zr(Xr),r=Jt(n,"Romanza (Demo)",e.currentInstrument,!0);zt(r,t,!0)}function jt(){y.info(`Loading library for instrument: ${e.currentInstrument}`,"Library");const t=localStorage.getItem(`fretflow_songs_${e.currentInstrument}`);e.songs=t?JSON.parse(t):[],e.songs.length===0?ei():O()}function ti(t){const n=t.target;if(!n.files||n.files.length===0)return;const r=n.files[0];y.info(`Importing library from file: ${r.name}`,"Library");const o=new FileReader;o.onload=i=>{try{const a=JSON.parse(i.target.result);if(Array.isArray(a)){const c=a.filter(s=>!e.songs.some(l=>l.id===s.id));e.songs.push(...c),localStorage.setItem(`fretflow_songs_${e.currentInstrument}`,JSON.stringify(e.songs)),O(),y.info(`Imported ${c.length} new songs.`,"Library"),alert(`Imported ${c.length} new songs.`)}else throw new Error("Invalid library format. Expected an array of songs.")}catch(a){alert(`Failed to import library: ${a}`),y.error(a,"LibraryImport")}finally{n.value=""}},o.readAsText(r)}function ni(t){const n=t.target;if(!n.files||n.files.length===0)return;const r=n.files[0];y.info(`Importing single song from file: ${r.name}`,"Library");const o=new FileReader;o.onload=i=>{try{const a=JSON.parse(i.target.result);if(!a.title||!a.tablature||!a.id)throw new Error("Invalid song file format. Missing required properties (id, title, tablature).");if(e.songs.find(s=>s.id===a.id)){const s=a.id;a.id="song_"+Date.now()+Math.random(),a.title=`${a.title} (Imported)`,y.warn("Imported song with duplicate ID. Assigned new ID and title.","Library",{oldId:s,newId:a.id})}e.songs.unshift(a),localStorage.setItem(`fretflow_songs_${e.currentInstrument}`,JSON.stringify(e.songs)),O(),y.info(`Successfully imported song: ${a.title}`,"Library"),alert(`Successfully imported "${a.title}".`)}catch(a){const c=a instanceof Error?a.message:String(a);alert(`Failed to import song: ${c}`),y.error(a,"SongImport")}finally{n.value=""}},o.readAsText(r)}function ri(){if(e.songs.length===0){alert("Library is empty, nothing to export.");return}y.info("Exporting library","Library",{songCount:e.songs.length});const t="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e.songs,null,2)),n=document.createElement("a");n.setAttribute("href",t),n.setAttribute("download",`fretflow_library_${e.currentInstrument}_${new Date().toISOString().split("T")[0]}.json`),document.body.appendChild(n),n.click(),n.remove()}function ii(t){const n=t.target;if(!n.files||n.files.length===0)return;const r=Array.from(n.files);y.info(`Adding ${r.length} new song(s).`,"Library");for(const o of r){const i=o.name.toLowerCase(),a=i.endsWith(".mid")||i.endsWith(".midi"),c=i.endsWith(".xml");if(!a&&!c){y.warn(`Skipping unsupported file type: ${o.name}`,"Library"),alert(`Skipping unsupported file type: ${o.name}`);continue}const s=new FileReader,l=`placeholder-${Date.now()}-${Math.random()}`;O(l,o.name),s.onload=d=>{const g=d.target.result;let u;a?u=Jt(g,o.name,e.currentInstrument,!1):u=Kr(g,o.name,e.currentInstrument),zt(u,l)},s.onerror=()=>{y.error(`FileReader error for file: ${o.name}`,"Library");const d=document.getElementById(l);d&&d.remove()},a?s.readAsArrayBuffer(o):s.readAsText(o)}n.value=""}function oi(){const t=()=>{const r=e.currentInstrument==="guitar";v(e.ui.selectGuitarBtn,{active:r}),v(e.ui.selectUkuleleBtn,{active:!r}),e.ui.instrumentNameDisplay.textContent=P(e.currentInstrument).name},n=r=>{e.currentInstrument!==r&&(y.info(`Switching instrument to ${r}`,"Library"),e.currentInstrument=r,Or(),jt(),t())};x(e.ui.selectGuitarBtn,"click",()=>n("guitar")),x(e.ui.selectUkuleleBtn,"click",()=>n("ukulele")),x(e.ui.librarySearchInput,"input",()=>O()),x(e.ui.libraryTunerBtn,"click",qt),x(e.ui.midiFileInput,"change",ii),x(e.ui.exportLibraryBtn,"click",ri),x(e.ui.importLibraryInput,"change",ti),x(e.ui.importSongInput,"change",ni),x(e.ui.songList,"click",Pr),t()}async function Ee(){const t=e.ui.saveBtn;if(!(!e.pendingEdits||t.disabled)){y.info("Saving edited tablature...","Editor"),t.textContent="Saving...",t.disabled=!0;try{const n=e.songs.find(r=>r.id===e.currentSongData.id);n&&(n.tablature=JSON.stringify(e.editedTablature),e.originalTablature=JSON.parse(JSON.stringify(e.editedTablature)),localStorage.setItem(`fretflow_songs_${e.currentInstrument}`,JSON.stringify(e.songs)),e.pendingEdits=!1,e.editHistory=[],e.historyIndex=-1,e.ui.undoBtn.disabled=!0,e.ui.redoBtn.disabled=!0,e.ui.doneEditingBtn.textContent="Exit",v(e.ui.doneEditingBtn,{"bg-green-600":!1,"hover:bg-green-700":!1,"bg-gray-600":!0,"hover:bg-gray-700":!0}),t.textContent="Saved!",await new Promise(r=>setTimeout(r,1e3)))}catch(n){y.error(n,"SaveEdits"),alert("Error saving changes. Please check the logs."),t.textContent="Error!",await new Promise(r=>setTimeout(r,2e3))}finally{t.textContent="Save"}}}function Y(){e.isEditMode=!1,y.info("Exiting edit mode","Editor"),e.pendingEdits=!1,e.editedTablature=[],e.editHistory=[],e.historyIndex=-1,Q(),v(e.ui.practice,{"in-edit-mode":!1}),v(e.ui.editModeBtn,{hidden:!1}),v(e.ui.editModeActions,{hidden:!0}),Te(),U()}function ai(){e.currentSongData&&(e.isEditMode=!0,y.info("Entering edit mode","Editor"),j(),e.editedTablature=JSON.parse(JSON.stringify(e.originalTablature)),e.editHistory=[],e.historyIndex=-1,e.pendingEdits=!1,v(e.ui.practice,{"in-edit-mode":!0}),v(e.ui.editModeBtn,{hidden:!0}),v(e.ui.editModeActions,{hidden:!1}),e.ui.undoBtn.disabled=!0,e.ui.redoBtn.disabled=!0,e.ui.saveBtn.disabled=!0,e.ui.doneEditingBtn.textContent="Exit",v(e.ui.doneEditingBtn,{"bg-green-600":!1,"hover:bg-green-700":!1,"bg-gray-600":!0,"hover:bg-gray-700":!0}),Te(),U())}function yt(t){e.currentMode===t||e.isEditMode||(e.ui.settingsMenu.classList.contains("open")&&(v(e.ui.settingsMenu,{open:!1}),v(e.ui.settingsBackdrop,{open:!1})),e.currentMode=t,y.info(`Switched to ${t} mode`,"Game"),t==="performance"&&e.currentSongData&&(e.loopStartTime=0,e.loopEndTime=e.currentSongData.totalDuration),j(!0),Z(),Te())}function si(){x(e.ui.playPauseBtn,"click",()=>{e.isPlaying?e.isPaused?Re():Se():Z()}),x(e.ui.rewindBtn,"click",()=>{y.info("Rewinding song to loop start","Practice"),j(!0),Z()}),x(e.ui.practiceBackBtn,"click",async()=>{e.isEditMode?e.pendingEdits?pt("Return to Library?","You have unsaved changes. What would you like to do before leaving?",[{text:"Cancel",classes:"px-4 py-2 text-sm bg-gray-500 hover:bg-gray-600 rounded-md text-white",onClick:()=>{}},{text:"Discard & Leave",classes:"px-4 py-2 text-sm bg-red-600 hover:bg-red-700 rounded-md text-white",onClick:()=>{Y(),K()}},{text:"Save & Leave",classes:"px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 rounded-md text-white",onClick:async()=>{await Ee(),Y(),K()}}]):(Y(),K()):(await J(),K())}),x(e.ui.practiceTunerBtn,"click",()=>{e.isPlaying&&!e.isPaused&&Se(),qt()}),x(e.ui.selectPracticeBtn,"click",()=>yt("practice")),x(e.ui.selectPerformanceBtn,"click",()=>yt("performance")),x(e.ui.editModeBtn,"click",ai),x(e.ui.saveBtn,"click",Ee),x(e.ui.doneEditingBtn,"click",async()=>{e.pendingEdits?pt("Unsaved Changes","You have unsaved changes. What would you like to do?",[{text:"Cancel",classes:"px-4 py-2 text-sm bg-gray-500 hover:bg-gray-600 rounded-md text-white",onClick:()=>{}},{text:"Discard & Exit",classes:"px-4 py-2 text-sm bg-red-600 hover:bg-red-700 rounded-md text-white",onClick:Y},{text:"Save & Exit",classes:"px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 rounded-md text-white",onClick:async()=>{await Ee(),Y()}}]):Y()})}function ci(){x(e.ui.tempoSlider,"input",t=>{e.ui.tempoValue.textContent=`${t.target.value}%`}),x(e.ui.tempoSlider,"change",J),x(e.ui.tempoDownBtn,"click",()=>{const t=e.ui.tempoSlider,n=parseInt(t.value,10),r=Math.max(parseInt(t.min,10),n-1);r!==n&&(t.value=String(r),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})))}),x(e.ui.tempoUpBtn,"click",()=>{const t=e.ui.tempoSlider,n=parseInt(t.value,10),r=Math.min(parseInt(t.max,10),n+1);r!==n&&(t.value=String(r),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})))}),x(e.ui.zoomSlider,"input",t=>{if(e.zoomLevel=parseFloat(t.target.value),e.ui.zoomValue.textContent=`${Math.round(e.zoomLevel*100)}%`,e.currentSongData){const n=Math.max(150,(72*e.globalSettings.noteSize+8)/e.currentSongData.minDuration);e.currentSongData.pixelsPerSecond=n*e.zoomLevel,R(),ee()}}),x(e.ui.zoomSlider,"change",J),x(e.ui.transposeDownBtn,"click",()=>{e.isEditMode||(e.transposeOffset--,U({recalculateFingering:!0}),J(),ie())}),x(e.ui.transposeUpBtn,"click",()=>{e.isEditMode||(e.transposeOffset++,U({recalculateFingering:!0}),J(),ie())}),x(e.ui.stringShiftDownBtn,"click",()=>{e.isEditMode||(e.stringShiftOffset++,U({recalculateFingering:!0}),J(),ie())}),x(e.ui.stringShiftUpBtn,"click",()=>{e.isEditMode||(e.stringShiftOffset--,U({recalculateFingering:!0}),J(),ie())}),x(e.ui.noteSizeSlider,"input",t=>{e.globalSettings.noteSize=parseFloat(t.target.value),e.ui.noteSizeValue.textContent=`${Math.round(e.globalSettings.noteSize*100)}%`,U()}),x(e.ui.noteSizeSlider,"change",pe),x(e.ui.stringSpacingSlider,"input",t=>{e.globalSettings.stringSpacing=parseFloat(t.target.value),e.ui.stringSpacingValue.textContent=`${Math.round(e.globalSettings.stringSpacing*100)}%`,De(),R()}),x(e.ui.stringSpacingSlider,"change",pe),x(e.ui.stringThicknessSlider,"input",t=>{e.globalSettings.stringThickness=parseFloat(t.target.value),e.ui.stringThicknessValue.textContent=`${Math.round(e.globalSettings.stringThickness*100)}%`,De(),R()}),x(e.ui.stringThicknessSlider,"change",pe)}function li(){x(e.ui.undoBtn,"click",Ht),x(e.ui.redoBtn,"click",Gt),x(e.ui.editorCloseBtn,"click",Q),x(e.ui.editorFretUp,"click",()=>t(1)),x(e.ui.editorFretDown,"click",()=>t(-1)),x(e.ui.editorDeleteBtn,"click",kr),x(e.ui.editorFingerButtons,"click",n=>{const r=n.target.closest(".finger-btn");if(r&&e.selectedNoteIndex){const o=parseInt(r.dataset.finger),{eventIndex:i,noteIndex:a}=e.selectedNoteIndex,c=e.editedTablature[i].notes[a];c.finger!==o&&(be({type:"finger",noteId:e.selectedNoteIndex,oldValue:c.finger,newValue:o}),c.finger=o,ce(e.selectedNoteIndex),U())}});function t(n){if(!e.selectedNoteIndex)return;const r=P(e.currentInstrument),{eventIndex:o,noteIndex:i}=e.selectedNoteIndex,a=e.editedTablature[o].notes[i],c=a.fret+n;if(c>=0&&c<=r.numFrets){const s=a.pitch,l=a.fret,d=r.tuning[a.string]+c;be({type:"pitch",noteId:e.selectedNoteIndex,oldValue:{pitch:s,fret:l},newValue:{pitch:d,fret:c}}),a.fret=c,a.pitch=d,ce(e.selectedNoteIndex),U()}}}function ui(){x(e.ui.dynamicCanvas,"mousedown",n=>{if(e.isEditMode){const r=Ie(n.clientX,n.clientY);r?(e.isDragging=!0,e.wasDragged=!1,e.draggedNoteIndex=r,e.mousePosition={x:n.clientX,y:n.clientY},v(e.ui.dynamicCanvas,{grabbing:!0})):Q()}}),x(e.ui.dynamicCanvas,"click",n=>{e.isEditMode||(e.isPlaying?e.isPaused?Re():Se():Z())});const t=Le(n=>{if(!e.isEditMode||!e.currentSongData||e.isDragging)return;const r=Ie(n.clientX,n.clientY);JSON.stringify(r)!==JSON.stringify(e.hoveredNoteIndex)&&(e.hoveredNoteIndex=r,R())},50);x(e.ui.dynamicCanvas,"mousemove",n=>{if(e.isDragging){e.wasDragged=!0,e.mousePosition={x:n.clientX,y:n.clientY},R();return}t(n)}),x(e.ui.dynamicCanvas,"mouseup",n=>{if(!e.currentSongData)return;const r=e.wasDragged;if(r&&e.draggedNoteIndex){const o=P(e.currentInstrument),i=e.ui.dynamicCanvas.getBoundingClientRect(),a=n.clientY-i.top,{neckTopY:c,neckHeight:s}=V(),l=s/o.numStrings,d=Math.max(0,Math.min(o.numStrings-1,Math.round((a-c)/l-.5))),{eventIndex:g,noteIndex:u}=e.draggedNoteIndex,f=e.editedTablature[g].notes[u],h=f.string,m=f.fret,b=f.pitch-o.tuning[d];b>=0&&b<=o.numFrets&&d!==h&&(be({type:"position",noteId:e.draggedNoteIndex,oldValue:{string:h,fret:m},newValue:{string:d,fret:b}}),f.string=d,f.fret=b)}else if(e.isEditMode&&!r){const o=Ie(n.clientX,n.clientY);o&&(e.selectedNoteIndex&&e.selectedNoteIndex.eventIndex===o.eventIndex&&e.selectedNoteIndex.noteIndex===o.noteIndex?Q():ce(o))}e.isDragging=!1,e.draggedNoteIndex=null,e.wasDragged=!1,e.mousePosition=null,v(e.ui.dynamicCanvas,{grabbing:!1}),r&&U()}),x(e.ui.dynamicCanvas,"mouseleave",()=>{e.isDragging&&(e.isDragging=!1,e.draggedNoteIndex=null,e.wasDragged=!1,e.mousePosition=null,v(e.ui.dynamicCanvas,{grabbing:!1}),U())})}function di(){x(e.ui.minimapCanvas,"mousedown",r=>{if(!e.currentSongData)return;e.isScrubbingMinimap=!0,Vt(),ot(!0);const{mode:o}=Be(r);e.dragMode=o,lt(r)});const t=Le(lt,16);x(window,"mousemove",r=>{if(e.isScrubbingMinimap)t(r);else{if(!e.currentSongData||e.isEditMode){e.ui.minimapCanvas.style.cursor="pointer";return}const{mode:o}=Be(r);e.ui.minimapCanvas.style.cursor=o==="start"||o==="end"?"ew-resize":"pointer"}});function n(){e.isScrubbingMinimap&&(e.isScrubbingMinimap=!1,e.dragMode=null,requestAnimationFrame(()=>ot(!1)))}x(window,"mouseup",n),x(window,"mouseleave",n)}function gi(){const t=e.ui.logViewerContent,n=a=>`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}:${a.getSeconds().toString().padStart(3,"0")}`,r=a=>{const c=document.createElement("div");c.className=`log-entry log-entry-${a.level}`;const s=a.data?`
Data: ${JSON.stringify(a.data,null,2)}`:"";return c.innerHTML=`<span class="log-meta">${n(a.timestamp)}</span> <span class="log-context">[${a.context}]</span> ${a.message}${s}`,c},o=()=>{const c=y.getLogs().map(r);t.replaceChildren(...c),t.scrollTop=t.scrollHeight},i=a=>{if(e.ui.logViewer.classList.contains("hidden"))return;const c=r(a),s=t.scrollHeight-t.clientHeight<=t.scrollTop+5;t.appendChild(c),s&&(t.scrollTop=t.scrollHeight)};y.subscribe(i),x(e.ui.logViewerBtn,"click",()=>{o(),Vr()}),x(e.ui.closeLogsBtn,"click",mt),x(e.ui.logViewerBackdrop,"click",mt),x(e.ui.clearLogsBtn,"click",()=>{y.clear(),o()})}function fi(){const t=e.ui.instrumentSelector;t.innerHTML="",xt.forEach(n=>{const r=document.createElement("optgroup");r.label=n.category,n.instruments.forEach(o=>{const i=document.createElement("option");i.value=String(o.program),i.textContent=o.name.replace(/^\d+\s*-\s*/,""),o.program===e.globalSettings.selectedInstrument&&(i.selected=!0),r.appendChild(i)}),t.appendChild(r)}),x(t,"change",async n=>{const r=parseInt(n.target.value);e.globalSettings.selectedInstrument=r,await Pt(r),pe(),y.info(`Changed synth instrument to program ${r}`,"Audio")})}function mi(){function t(){const r=e.ui.fullscreenBtn.innerHTML;e.ui.fullscreenBtn.textContent="Fullscreen N/A",e.ui.fullscreenBtn.disabled=!0,setTimeout(()=>{e.ui.fullscreenBtn.innerHTML=r,e.ui.fullscreenBtn.disabled=!1},2500)}x(e.ui.fullscreenBtn,"click",async()=>{if(!document.fullscreenEnabled){y.warn("Fullscreen API is not available or is blocked.","UI"),t();return}try{document.fullscreenElement?(await document.exitFullscreen(),y.info("Exited fullscreen mode.","UI")):(await document.documentElement.requestFullscreen(),y.info("Entered fullscreen mode.","UI"))}catch(r){y.error(r,"Fullscreen"),t()}}),x(e.ui.summaryBackBtn,"click",K),x(e.ui.tunerBackBtn,"click",()=>{e.currentSongData?Qt():K()});const n=()=>{v(e.ui.settingsMenu,{open:!1}),v(e.ui.settingsBackdrop,{open:!1})};x(e.ui.settingsBtn,"click",r=>{r.stopPropagation(),v(e.ui.settingsMenu,{open:!0}),v(e.ui.settingsBackdrop,{open:!0})}),x(e.ui.moreActionsBtn,"click",r=>{r.stopPropagation();const o=e.ui.moreActionsMenu,i=o.classList.contains("open");v(o,{open:!i,hidden:i})}),x(e.ui.moreActionsMenu,"click",()=>{v(e.ui.moreActionsMenu,{open:!1,hidden:!0})}),x(document,"click",r=>{!e.ui.settingsMenuContent.contains(r.target)&&!e.ui.settingsBtn.contains(r.target)&&n(),!e.ui.moreActionsBtn.contains(r.target)&&!e.ui.moreActionsMenu.contains(r.target)&&v(e.ui.moreActionsMenu,{open:!1,hidden:!0})}),x(document,"keydown",r=>{if(!(r.target.tagName==="INPUT"||r.target.tagName==="TEXTAREA")&&(!e.ui.practice.classList.contains("hidden")&&!e.isEditMode&&(r.code==="Space"&&(r.preventDefault(),e.isPlaying?e.isPaused?Re():Se():Z()),r.key==="Enter"&&(r.preventDefault(),e.ui.rewindBtn.click(),y.info("Restarted song with Enter key","KeyboardShortcut")),(r.key==="-"||r.key==="_")&&(r.preventDefault(),e.ui.tempoDownBtn.click(),y.info('Decreased tempo with "-" key',"KeyboardShortcut")),(r.key==="+"||r.key==="=")&&(r.preventDefault(),e.ui.tempoUpBtn.click(),y.info('Increased tempo with "+" key',"KeyboardShortcut"))),e.isEditMode)){const o=(r.metaKey||r.ctrlKey)&&r.key==="z"&&!r.shiftKey,i=(r.metaKey||r.ctrlKey)&&(r.key==="y"||r.key==="z"&&r.shiftKey);o&&(r.preventDefault(),Ht()),i&&(r.preventDefault(),Gt())}}),x(window,"resize",Le(Pe,100))}function pi(){oi(),si(),ci(),li(),ui(),di(),mi(),fi(),gi()}function hi(){y.info("Application initializing...","Init"),Lr(),on(),$r(),jt(),pi(),de(e.ui.library)}window.addEventListener("load",hi);
